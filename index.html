<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JapaneseGO V17.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --accent-color: #0A84FF;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: calc(90px + var(--safe-bottom));
        }

        /* é ‚éƒ¨å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding-top: var(--safe-top);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        h1 { margin: 0; font-size: 22px; font-weight: 800; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* æœå°‹ & åˆ†é¡ */
        .search-box { margin: 0 15px 10px 15px; position: relative; display: none; }
        .search-input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 12px 10px 12px 35px; color: #fff; font-size: 16px; }
        .search-icon { position: absolute; left: 10px; top: 12px; color: #888; }
        .tabs-container { width: 100%; overflow-x: auto; padding: 0 15px 10px 15px; white-space: nowrap; display: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; appearance: none; background: #333; color: #ccc; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-right: 8px; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        /* å…§å®¹å€ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç™¾å¯¶ç®± (Toolbox) æ ¼ç‹€é¸å–® */
        .toolbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .tool-card {
            background: #1c1c1e; border: 1px solid #333; border-radius: 20px;
            padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 140px;
        }
        .tool-card:active { transform: scale(0.96); background: #252525; }
        .tool-icon { font-size: 40px; margin-bottom: 10px; }
        .tool-name { font-size: 16px; font-weight: 700; color: #fff; }
        .tool-desc { font-size: 12px; color: #888; margin-top: 5px; }

        /* ğŸ¥ é†«ç™‚æ€¥æ•‘ä»‹é¢ */
        .medical-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .med-btn {
            background: #2c1a1a; border: 1px solid #5a2a2a; border-radius: 16px;
            padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .med-btn:active { background: #3a1a1a; transform: scale(0.98); }
        .med-icon { font-size: 32px; margin-bottom: 8px; display: block; }
        .med-label { color: #ff5e5e; font-weight: bold; font-size: 16px; }

        /* ğŸ”¤ äº”åéŸ³ä»‹é¢ */
        .kana-switch { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .kana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .kana-cell {
            background: #222; border-radius: 8px; padding: 10px 0; text-align: center;
            cursor: pointer; border: 1px solid #333;
        }
        .kana-cell:active { background: #0A84FF; border-color: #0A84FF; }
        .kana-char { font-size: 20px; font-weight: bold; color: #fff; }
        .kana-romaji { font-size: 10px; color: #888; margin-top: 2px; }

        /* ğŸ‘¶ å…’ç«¥æ¨¡å¼ */
        .kids-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 10px; }
        .kid-card {
            background: #fff; border-radius: 25px; padding: 20px; text-align: center;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1); cursor: pointer;
            aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .kid-card:active { transform: scale(0.9); }
        .kid-icon { font-size: 60px; line-height: 1; margin-bottom: 10px; }
        .kid-label { font-size: 20px; font-weight: 900; color: #333; }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(15,15,15,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding-top: 10px; z-index: 2000; padding-bottom: var(--safe-bottom); }
        .nav-btn { text-align: center; color: #666; font-size: 10px; width: 20%; cursor: pointer; }
        .nav-btn.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* è¤‡ç¿’ & æœƒè©± & ç‰¹è¨“ (ä¿ç•™åŸæ¨£å¼) */
        .review-stats { text-align: center; color: #888; font-size: 13px; margin-bottom: 20px; }
        .flashcard-container { perspective: 1000px; width: 100%; height: 280px; margin-top: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; background: #222; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .flashcard-back { transform: rotateY(180deg); background: #2c2c2e; border-radius: 20px; }
        .r-btn { padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; font-size: 16px; min-width: 120px; margin-top: 20px; cursor: pointer; background: #0A84FF; color: white; }
        
        .dialogue-card { background: #151515; border: 1px solid #333; border-radius: 16px; margin-bottom: 20px; overflow: hidden; }
        .dialogue-header { background: #222; padding: 10px 15px; font-weight: 700; color: #fff; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 8px; }
        .dialogue-body { padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .chat-row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 10px; }
        .chat-row.user-row { flex-direction: row-reverse; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; border: 1px solid #444; }
        .chat-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; cursor: pointer; background: #2c2c2e; color: #eee; }
        .chat-row.user-row .chat-bubble { background: #0A84FF; color: #fff; }
        
        .card { background: #1c1c1e; border: 1px solid #333; border-radius: 18px; padding: 18px; margin-bottom: 14px; position: relative; transition: 0.2s; }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .jp-big { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 6px; }
        .romaji { font-family: monospace; color: #FFD60A; font-size: 14px; margin-bottom: 6px; display: block; }
        .cn { font-size: 15px; color: #ccc; }
        .check-box { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; }
        .check-box.checked { background: #30D158; border-color: #30D158; color: white; }
        .star-btn { font-size: 28px; color: #444; padding: 5px; cursor: pointer; }
        .star-btn.fav { color: #FFD60A; }
        
        /* å…¨è¢å¹•è¦†è“‹ */
        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        #fs-jp { font-size: 48px; font-weight: 900; color: #fff; margin-bottom: 20px; line-height: 1.3; }
        #fs-cn { font-size: 24px; color: #888; font-weight: 500; }
        #fs-close { position: absolute; top: 50px; right: 30px; font-size: 30px; color: #666; border: 1px solid #333; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Ultimate V17.0</span></h1>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="filterDict('short', this)">ğŸ—£ï¸ çŸ­å¥</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ æ”¶è—</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">ç”Ÿå­˜</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">ç¾é£Ÿ</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">è³¼ç‰©</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">è¦ªå­</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">è—¥å¦</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">äº¤é€š</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">ä½å®¿</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">æ©Ÿå ´</button>
        <button class="tab-btn" onclick="filterDict('okinawa', this)" style="color:#FF2D55; border-color:#FF2D55;">ğŸŒº æ²–ç¹©</button>
    </div>
</div>

<div id="fullscreen-overlay" onclick="closeFullscreen()">
    <div id="fs-close">âœ•</div>
    <div id="fs-jp">JP</div>
    <div id="fs-cn">CN</div>
    <div style="margin-top:30px; font-size:12px; color:#555;">(é»æ“Šé—œé–‰)</div>
</div>

<div id="view-learn" class="view active">
    <div style="background:linear-gradient(135deg,#1a2a3a,#1c1c1e); border:1px solid #333; border-radius:16px; padding:15px; margin-bottom:20px; display:flex; gap:15px; align-items:center;">
        <div style="font-size:40px;">ğŸ¦</div>
        <div style="flex:1;">
            <div style="font-size:13px; color:#0A84FF; font-weight:bold; margin-bottom:4px;">æ•™ç·´å®åš€</div>
            <div id="sensei-msg" style="font-size:15px; color:#fff;">...</div>
        </div>
    </div>
    <div id="curriculum-container"></div>
</div>

<div id="view-dialogue" class="view">
    <div id="dialogue-container"></div>
</div>

<div id="view-dict" class="view">
    <div id="dict-container"></div>
</div>

<div id="view-tools" class="view">
    <div class="toolbox-grid">
        <div class="tool-card" onclick="openTool('medical')">
            <div class="tool-icon">ğŸ¥</div>
            <div class="tool-name">æ€¥æ•‘æŒ‡æŒ‡é€š</div>
            <div class="tool-desc">ç·Šæ€¥æ™‚åˆ»å¿…å‚™</div>
        </div>
        <div class="tool-card" onclick="openTool('kana')">
            <div class="tool-icon">ğŸ”¤</div>
            <div class="tool-name">äº”åéŸ³è¡¨</div>
            <div class="tool-desc">èœå–®è§£ç¢¼ç¥å™¨</div>
        </div>
        <div class="tool-card" onclick="openTool('kids')">
            <div class="tool-icon">ğŸ‘¶</div>
            <div class="tool-name">å¥å¥å°ˆå€</div>
            <div class="tool-desc">è¦ªå­å…±å­¸éŠæˆ²</div>
        </div>
        <div class="tool-card" onclick="openTool('review')">
            <div class="tool-icon">ğŸ”€</div>
            <div class="tool-name">éš¨æ©Ÿè¤‡ç¿’</div>
            <div class="tool-desc">å–®å­—æŠ½è€ƒæŒ‘æˆ°</div>
        </div>
    </div>
</div>

<div id="view-medical" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div>
    <div style="color:#FF453A; font-weight:bold; margin-bottom:15px; text-align:center;">ç·Šæ€¥ç‹€æ³Point-and-Speak</div>
    <div class="medical-grid">
        <div class="med-btn" onclick="speak('ç†±ãŒã‚ã‚Šã¾ã™')"><span class="med-icon">ğŸ¤’</span><span class="med-label">ç™¼ç‡’</span></div>
        <div class="med-btn" onclick="speak('ãŠè…¹ãŒç—›ã„')"><span class="med-icon">ğŸ¤¢</span><span class="med-label">è‚šå­ç—›</span></div>
        <div class="med-btn" onclick="speak('åãæ°—ãŒã—ã¾ã™')"><span class="med-icon">ğŸ¤®</span><span class="med-label">æƒ³å</span></div>
        <div class="med-btn" onclick="speak('æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ')"><span class="med-icon">ğŸ¤•</span><span class="med-label">å—å‚·</span></div>
        <div class="med-btn" onclick="speak('åµã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã§ã™')"><span class="med-icon">ğŸ¥š</span><span class="med-label">å°è›‹éæ•</span></div>
        <div class="med-btn" onclick="speak('ç‰›ä¹³ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã§ã™')"><span class="med-icon">ğŸ¥›</span><span class="med-label">å°å¥¶éæ•</span></div>
        <div class="med-btn" onclick="speak('è–¬å±€ã¯ã©ã“ï¼Ÿ')"><span class="med-icon">ğŸ’Š</span><span class="med-label">æ‰¾è—¥å±€</span></div>
        <div class="med-btn" onclick="speak('æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§')"><span class="med-icon">ğŸš‘</span><span class="med-label">å«æ•‘è­·è»Š</span></div>
    </div>
</div>

<div id="view-kana" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div>
    <div class="kana-switch">
        <button class="tab-btn active" onclick="renderKana('hira')">å¹³å‡å (ã‚)</button>
        <button class="tab-btn" onclick="renderKana('kata')">ç‰‡å‡å (ã‚¢)</button>
    </div>
    <div id="kana-grid" class="kana-grid"></div>
</div>

<div id="view-kids" class="view" style="background:#f0f8ff; min-height:100vh;">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF; font-weight:bold;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›çˆ¸åª½æ¨¡å¼</div>
    <div class="kids-grid">
        <div class="kid-card" onclick="speak('ãã‚‡ã†ã‚Šã‚…ã†')"><div class="kid-icon">ğŸ¦–</div><div class="kid-label">æé¾</div></div>
        <div class="kid-card" onclick="speak('ãã†')"><div class="kid-icon">ğŸ˜</div><div class="kid-label">å¤§è±¡</div></div>
        <div class="kid-card" onclick="speak('ã‚¢ã‚¤ã‚¹')"><div class="kid-icon">ğŸ¦</div><div class="kid-label">å†°æ·‡æ·‹</div></div>
        <div class="kid-card" onclick="speak('ãƒã‚¹')"><div class="kid-icon">ğŸšŒ</div><div class="kid-label">å…¬è»Š</div></div>
        <div class="kid-card" onclick="speak('ã²ã“ã†ã')"><div class="kid-icon">âœˆï¸</div><div class="kid-label">é£›æ©Ÿ</div></div>
        <div class="kid-card" onclick="speak('ãƒãƒŠãƒŠ')"><div class="kid-icon">ğŸŒ</div><div class="kid-label">é¦™è•‰</div></div>
    </div>
</div>

<div id="view-review" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div>
    <div style="text-align:center; margin-top:20px;">
        <h2>ğŸ”€ éš¨æ©ŸæŠ½è€ƒ</h2>
        <div style="color:#888; font-size:13px; margin-bottom:20px;">å¾å·²å­¸ç¿’å–®å­—å‡ºé¡Œ</div>
    </div>
    <div id="review-area" style="display:none;">
        <div class="flashcard-container" onclick="flipCard()">
            <div id="flashcard" class="flashcard">
                <div class="flashcard-front">
                    <div style="font-size:32px; font-weight:800; margin-bottom:10px;" id="fc-jp">JP</div>
                    <div style="color:#FFD60A; font-family:monospace;" id="fc-romaji">Romaji</div>
                    <div style="margin-top:20px; color:#666; font-size:12px;">(é»æ“Šç¿»é¢)</div>
                </div>
                <div class="flashcard-back">
                    <div style="font-size:24px; font-weight:bold;" id="fc-cn">CN</div>
                    <div style="margin-top:20px; font-size:30px;" onclick="event.stopPropagation(); speakCurrentCard()">ğŸ”Š</div>
                </div>
            </div>
        </div>
        <div style="text-align:center;"><button class="r-btn" onclick="nextCard()">ä¸‹ä¸€é¡Œ</button></div>
    </div>
    <div id="empty-review" style="text-align:center; margin-top:50px; color:#666; display:none;">
        <div style="font-size:50px; margin-bottom:20px;">ğŸ“</div>å°šæœªå‹¾é¸ä»»ä½•å–®å­—
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)"><span class="nav-icon">ğŸ“…</span>ç‰¹è¨“</div>
    <div class="nav-btn" onclick="switchView('dialogue', this)"><span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±</div>
    <div class="nav-btn" onclick="switchView('dict', this)"><span class="nav-icon">ğŸ“–</span>å­—å…¸</div>
    <div class="nav-btn" id="nav-tools" onclick="switchView('tools', this)"><span class="nav-icon">ğŸ§°</span>ç™¾å¯¶ç®±</div>
</div>

<script>
    const cheerQuotes = ["ç‚ºäº†å¥å¥çš„ç¬‘å®¹ï¼ŒåŠ æ²¹ï¼ğŸ‘¶", "æ²–ç¹©æµ·é¢¨åœ¨ç­‰ä½ ï¼ğŸŒŠ", "æ¯å¤©5åˆ†é˜å°±å¥½ï¼ğŸ’ª", "æƒ³åƒåœ¨å±…é…’å±‹é»é¤ï¼ğŸº", "Sumimasen æ˜¯è¬èƒ½çš„ï¼âœ¨"];
    
    // --- å®Œæ•´è³‡æ–™åº« (è«‹å‹™å¿…æ”¾å…¥å®Œæ•´è³‡æ–™) ---
    const phrases = [
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "A-ri-ga-tou", cn: "è¬è¬" },
        { id: "d1", cat: "dining", jp: "ã“ã‚Œãã ã•ã„", romaji: "Ko-re Ku-da-sai", cn: "æˆ‘è¦é€™å€‹" },
        { id: "k1", cat: "kids", jp: "å­ä¾›æ¤…å­", romaji: "Ko-do-mo Isu", cn: "å…’ç«¥æ¤…" },
        // ... (è«‹è£œä¸Šæ‰€æœ‰ 200+ å¥ï¼Œæ­¤è™•çœç•¥ä»¥ç¯€çœç¯‡å¹…)
        { id: "x1", cat: "short", jp: "ãªã‚‹ã»ã©", romaji: "Na-ru-ho-do", cn: "åŸä¾†å¦‚æ­¤" },
        { id: "o1", cat: "okinawa", jp: "ã¯ã„ã•ã„", romaji: "Hai-sai", cn: "ä½ å¥½" }
    ];

    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2","s3","s4","x1"] },
        { t: "Week 2 é»é¤å…¥é–€", ids: ["d1","d2","d3"] },
        // ... (è«‹è£œä¸Šæ‰€æœ‰é€±æ¬¡)
    ];

    const dialogues = [
        { title: "ğŸ¨ é£¯åº— Check-in", msgs: [{r:"user",t:"ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³",c:"Check-in"},{r:"staff",t:"ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’",c:"è­·ç…§"}] }
        // ... (è«‹è£œä¸Šå°è©±)
    ];

    // --- äº”åéŸ³è³‡æ–™ ---
    const kanaData = {
        hira: ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“","ã•","ã—","ã™","ã›","ã","ãŸ","ã¡","ã¤","ã¦","ã¨","ãª","ã«","ã¬","ã­","ã®","ã¯","ã²","ãµ","ã¸","ã»","ã¾","ã¿","ã‚€","ã‚","ã‚‚","ã‚„","","ã‚†","","ã‚ˆ","ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚","ã‚","","","","ã‚’","ã‚“"],
        kata: ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª","ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³","ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½","ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ","ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ","ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›","ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢","ãƒ¤","","ãƒ¦","","ãƒ¨","ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­","ãƒ¯","","","","ãƒ²","ãƒ³"],
        romaji: ["a","i","u","e","o","ka","ki","ku","ke","ko","sa","shi","su","se","so","ta","chi","tsu","te","to","na","ni","nu","ne","no","ha","hi","fu","he","ho","ma","mi","mu","me","mo","ya","","yu","","yo","ra","ri","ru","re","ro","wa","","","","wo","n"]
    };

    let currentReviewCard = null;

    // åˆå§‹åŒ–
    document.getElementById('sensei-msg').innerText = cheerQuotes[Math.floor(Math.random() * cheerQuotes.length)];
    renderPlan();
    renderDialogues();
    filterDict('all', null);
    renderKana('hira');

    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        
        // è™•ç†ç™¾å¯¶ç®±å­é é¢é‚è¼¯
        if (['medical','kana','kids','review'].includes(name)) {
            document.getElementById('view-'+name).classList.add('active');
            document.getElementById('nav-tools').classList.add('active'); // ä¿æŒç™¾å¯¶ç®±äº®èµ·
        } else {
            document.getElementById('view-'+name).classList.add('active');
            if(btn) btn.classList.add('active');
        }

        const isDict = name === 'dict';
        document.getElementById('tabs-bar').style.display = isDict ? 'block' : 'none';
        document.getElementById('search-bar-container').style.display = isDict ? 'block' : 'none';
        
        if (name === 'review') initReview();
        window.scrollTo(0,0);
    }

    function openTool(toolName) { switchView(toolName, null); }

    // --- æ¸²æŸ“åŠŸèƒ½ ---
    function renderKana(type) {
        const grid = document.getElementById('kana-grid');
        grid.innerHTML = '';
        const chars = kanaData[type];
        chars.forEach((char, i) => {
            if(char === "") {
                grid.innerHTML += `<div></div>`;
            } else {
                grid.innerHTML += `<div class="kana-cell" onclick="speak('${char}')"><div class="kana-char">${char}</div><div class="kana-romaji">${kanaData.romaji[i]}</div></div>`;
            }
        });
    }

    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_v17_prog')||'[]');
        box.innerHTML = weeks.map((w, idx) => {
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}')">ğŸ”</div><div class="check-box ${chk}" onclick="event.stopPropagation(); toggleCheck('${id}', this)">âœ“</div></div></div></div>`;
            }).join('');
            return `<div class="week-header"><div class="week-title">${w.t}</div></div>${lessons}`;
        }).join('');
    }

    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_v17_prog')||'[]');
        if (saved.includes(id)) { saved = saved.filter(x => x !== id); el.classList.remove('checked'); }
        else { saved.push(id); el.classList.add('checked'); }
        localStorage.setItem('jp_v17_prog', JSON.stringify(saved));
    }

    function filterDict(cat, btn) {
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('search-input').value = '';
        let data = phrases;
        if (cat === 'fav') { const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]'); data = phrases.filter(p => favs.includes(p.id)); }
        else if (cat !== 'all') { data = phrases.filter(p => p.cat === cat); }
        const box = document.getElementById('dict-container');
        box.innerHTML = data.map(p => {
            const isFav = JSON.parse(localStorage.getItem('jp_favs')||'[]').includes(p.id) ? 'fav' : '';
            return `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}')">ğŸ”</div><div class="star-btn ${isFav}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">â˜…</div></div></div></div>`;
        }).join('');
    }

    function renderDialogues() {
        document.getElementById('dialogue-container').innerHTML = dialogues.map(d => {
            const bubbles = d.msgs.map(m => {
                const rowClass = m.r === 'user' ? 'user-row' : 'staff-row';
                const avatar = m.r === 'user' ? 'ğŸ§‘â€ğŸ¼' : 'ğŸ‘©â€ğŸ’¼';
                return `<div class="chat-row ${rowClass}"><div class="avatar">${avatar}</div><div class="chat-bubble" onclick="speak('${m.t}')"><span class="bubble-jp">${m.t} ğŸ”Š</span><span class="bubble-cn">${m.c}</span></div></div>`;
            }).join('');
            return `<div class="dialogue-card"><div class="dialogue-header"><span>${d.title}</span></div><div class="dialogue-body">${bubbles}</div></div>`;
        }).join('');
    }

    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (favs.includes(id)) { favs = favs.filter(x => x !== id); el.classList.remove('fav'); }
        else { favs.push(id); el.classList.add('fav'); }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
    }

    function initReview() {
        const saved = JSON.parse(localStorage.getItem('jp_v17_prog')||'[]');
        if (saved.length === 0) { document.getElementById('review-area').style.display = 'none'; document.getElementById('empty-review').style.display = 'block'; }
        else { document.getElementById('review-area').style.display = 'block'; document.getElementById('empty-review').style.display = 'none'; nextCard(); }
    }
    function nextCard() {
        const saved = JSON.parse(localStorage.getItem('jp_v17_prog')||'[]');
        if(saved.length === 0) return;
        const randId = saved[Math.floor(Math.random() * saved.length)];
        currentReviewCard = phrases.find(p => p.id === randId);
        document.getElementById('flashcard').classList.remove('flipped');
        setTimeout(() => { document.getElementById('fc-jp').innerText = currentReviewCard.jp; document.getElementById('fc-romaji').innerText = currentReviewCard.romaji; document.getElementById('fc-cn').innerText = currentReviewCard.cn; }, 200);
    }
    function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); if(document.getElementById('flashcard').classList.contains('flipped')) setTimeout(() => speak(currentReviewCard.jp), 300); }
    function speakCurrentCard() { if(currentReviewCard) speak(currentReviewCard.jp); }

    function handleSearch() {
        const key = document.getElementById('search-input').value.toLowerCase();
        const box = document.getElementById('dict-container');
        const data = phrases.filter(p => p.jp.includes(key) || p.romaji.toLowerCase().includes(key) || p.cn.includes(key));
        box.innerHTML = data.map(p => `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div></div></div></div>`).join('');
    }

    function openFullscreen(jp, cn) { event.stopPropagation(); document.getElementById('fs-jp').innerText = jp; document.getElementById('fs-cn').innerText = cn; document.getElementById('fullscreen-overlay').style.display = 'flex'; }
    function closeFullscreen() { document.getElementById('fullscreen-overlay').style.display = 'none'; }
    function speak(txt) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); }
</script>
</body>
</html>
