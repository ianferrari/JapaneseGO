<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JapaneseGO V16.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --accent-color: #0A84FF;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --safe-top: env(safe-area-inset-top);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: 120px;
        }

        /* é ‚éƒ¨å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding-top: var(--safe-top);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        h1 { margin: 0; font-size: 22px; font-weight: 800; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .speed-btn {
            background: #333; border: 1px solid #555; color: #fff;
            padding: 5px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;
        }

        /* æœå°‹æ¡† & åˆ†é¡ */
        .search-box { margin: 0 15px 10px 15px; position: relative; display: none; }
        .search-input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 12px 10px 12px 35px; color: #fff; font-size: 16px; }
        .search-icon { position: absolute; left: 10px; top: 12px; color: #888; }
        
        .tabs-container { width: 100%; overflow-x: auto; padding: 0 15px 10px 15px; white-space: nowrap; display: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; appearance: none; background: #333; color: #ccc; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-right: 8px; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        /* å…§å®¹å€ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡åˆ—è¡¨ */
        .card { background: #1c1c1e; border: 1px solid #333; border-radius: 18px; padding: 18px; margin-bottom: 14px; position: relative; transition: 0.2s; }
        .card.active-playing { border-color: #0A84FF; background: #15202b; transform: scale(1.02); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .jp-big { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 6px; }
        .romaji { font-family: monospace; color: #FFD60A; font-size: 14px; margin-bottom: 6px; display: block; }
        .cn { font-size: 15px; color: #ccc; }
        
        .card-actions { display: flex; gap: 10px; align-items: center; margin-left: 10px; }
        .star-btn { font-size: 28px; color: #444; padding: 5px; transition: transform 0.2s; cursor: pointer; }
        .star-btn.fav { color: #FFD60A; text-shadow: 0 0 10px rgba(255, 214, 10, 0.4); transform: scale(1.2); }
        .star-btn:active { transform: scale(0.9); }
        .show-btn { font-size: 22px; color: #666; padding: 5px; cursor: pointer; }
        .check-box { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; transition: all 0.2s; }
        .check-box.checked { background: #30D158; border-color: #30D158; color: white; }

        /* æ¸¬é©—æ¨¡å¼ */
        .quiz-container { text-align: center; margin-top: 20px; }
        .quiz-speaker { width: 120px; height: 120px; background: #222; border-radius: 50%; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center; font-size: 50px; border: 2px solid #0A84FF; cursor: pointer; box-shadow: 0 0 20px rgba(10, 132, 255, 0.2); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(10,132,255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(10,132,255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10,132,255, 0); } }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .quiz-btn { background: #2c2c2e; color: #fff; padding: 15px; border-radius: 12px; border: 1px solid #444; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .quiz-btn:active { transform: scale(0.98); }
        .quiz-btn.correct { background: #30D158; border-color: #30D158; }
        .quiz-btn.wrong { background: #FF453A; border-color: #FF453A; }

        /* Toast */
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(30,30,30,0.95); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 9999; border: 1px solid #555; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* å…¨è¢å¹• */
        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        #fs-jp { font-size: 48px; font-weight: 900; color: #fff; margin-bottom: 20px; line-height: 1.3; }
        #fs-cn { font-size: 24px; color: #888; font-weight: 500; }
        #fs-close { position: absolute; top: 50px; right: 30px; font-size: 30px; color: #666; border: 1px solid #333; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* æœƒè©± */
        .dialogue-card { background: #151515; border: 1px solid #333; border-radius: 16px; margin-bottom: 20px; overflow: hidden; }
        .dialogue-header { background: #222; padding: 10px 15px; font-weight: 700; color: #fff; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 8px; }
        .dialogue-body { padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .chat-row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 10px; }
        .chat-row.user-row { flex-direction: row-reverse; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; border: 1px solid #444; }
        .chat-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; cursor: pointer; }
        .chat-row.staff-row .chat-bubble { background: #2c2c2e; color: #eee; border-bottom-left-radius: 4px; }
        .chat-row.user-row .chat-bubble { background: #0A84FF; color: #fff; border-bottom-right-radius: 4px; }
        .bubble-jp { font-size: 18px; font-weight: 700; margin-bottom: 4px; display: block; }
        .bubble-cn { font-size: 14px; opacity: 0.85; }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(15,15,15,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding-top: 10px; z-index: 2000; }
        .nav-btn { text-align: center; color: #666; font-size: 10px; width: 20%; cursor: pointer; }
        .nav-btn.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        
        .sensei-box { background: linear-gradient(135deg, #1a2a3a 0%, #1c1c1e 100%); border: 1px solid #333; border-radius: 16px; padding: 15px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        .sensei-avatar { font-size: 40px; }
        .sensei-content { flex: 1; }
        .sensei-title { font-size: 13px; color: #0A84FF; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
        .sensei-msg { font-size: 15px; line-height: 1.4; color: #fff; font-weight: 500; }
        .week-header { margin: 30px 0 15px 0; }
        .week-title { color: #0A84FF; font-size: 20px; font-weight: 800; margin: 0; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Full V16.0</span></h1>
        <button id="speed-toggle" class="speed-btn" onclick="toggleSpeed()">ğŸ¢ é¾œé€Ÿ</button>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ æ”¶è—</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">ç”Ÿå­˜</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">ç¾é£Ÿ</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">è³¼ç‰©</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">è¦ªå­</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">è—¥å¦</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">äº¤é€š</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">ä½å®¿</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">æ©Ÿå ´</button>
    </div>
</div>

<div id="toast">å·²æ”¶è— â­</div>

<div id="fullscreen-overlay" onclick="closeFullscreen()">
    <div id="fs-close">âœ•</div>
    <div id="fs-jp">JP TEXT</div>
    <div id="fs-cn">CN TEXT</div>
    <div style="margin-top:30px; font-size:12px; color:#555;">(é»æ“Šç•«é¢é—œé–‰)</div>
</div>

<div id="view-learn" class="view active">
    <div class="sensei-box">
        <div class="sensei-avatar">ğŸ¦</div>
        <div class="sensei-content">
            <div class="sensei-title">æ•™ç·´å®åš€</div>
            <div class="sensei-msg" id="sensei-msg">...</div>
        </div>
    </div>
    <div id="curriculum-container"></div>
</div>

<div id="view-quiz" class="view">
    <div style="text-align:center; margin-top:20px; margin-bottom:30px;">
        <h2>ğŸ‘‚ è½éŸ³è¾¨ç¾©</h2>
        <div style="color:#888; font-size:13px;">é»æ“Šå–‡å­ï¼Œé¸å‡ºæ­£ç¢ºçš„ä¸­æ–‡æ„æ€</div>
    </div>
    <div class="quiz-container">
        <div class="quiz-speaker" onclick="playQuizAudio()">ğŸ”Š</div>
        <div id="quiz-options" class="quiz-options"></div>
        <div id="quiz-feedback" style="margin-top:20px; font-size:18px; font-weight:bold; height:30px;"></div>
        <button class="r-btn next" onclick="nextQuiz()" style="margin-top:20px; background:#444; color:white; padding:10px 20px; border-radius:20px; border:none;">è·³é / ä¸‹ä¸€é¡Œ</button>
    </div>
</div>

<div id="view-dialogue" class="view">
    <div id="dialogue-container"></div>
</div>

<div id="view-dict" class="view">
    <div id="dict-container"></div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)"><span class="nav-icon">ğŸ“…</span>ç‰¹è¨“</div>
    <div class="nav-btn" onclick="switchView('quiz', this)"><span class="nav-icon">ğŸ®</span>æ¸¬é©—</div>
    <div class="nav-btn" onclick="switchView('dialogue', this)"><span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±</div>
    <div class="nav-btn" onclick="switchView('dict', this)"><span class="nav-icon">ğŸ“–</span>å­—å…¸</div>
</div>

<script>
    const cheerQuotes = ["ç‚ºäº†å¥å¥çš„ç¬‘å®¹ï¼ŒåŠ æ²¹ï¼ğŸ‘¶", "æ²–ç¹©æµ·é¢¨åœ¨ç­‰ä½ ï¼ğŸŒŠ", "æ¯å¤©5åˆ†é˜å°±å¥½ï¼ğŸ’ª", "æƒ³åƒåœ¨å±…é…’å±‹é»é¤ï¼ğŸº", "Sumimasen æ˜¯è¬èƒ½çš„ï¼âœ¨"];
    
    // --- å®Œæ•´è³‡æ–™åº« ---
    const phrases = [
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "A-ri-ga-tou", cn: "è¬è¬" },
        { id: "s3", cat: "survival", jp: "å¤§ä¸ˆå¤«", romaji: "Dai-jou-bu", cn: "æ²’é—œä¿‚" },
        { id: "s4", cat: "survival", jp: "ãƒˆã‚¤ãƒ¬", romaji: "To-i-re", cn: "å»æ‰€" },
        { id: "d1", cat: "dining", jp: "ã“ã‚Œãã ã•ã„", romaji: "Ko-re Ku-da-sai", cn: "æˆ‘è¦é€™å€‹" },
        { id: "d2", cat: "dining", jp: "ãŠæ°´", romaji: "O-mi-zu", cn: "æ°´" },
        { id: "d3", cat: "dining", jp: "ãŠä¼šè¨ˆ", romaji: "O-kai-kei", cn: "çµå¸³" },
        { id: "sh1", cat: "shopping", jp: "ã„ãã‚‰ï¼Ÿ", romaji: "I-ku-ra?", cn: "å¤šå°‘éŒ¢ï¼Ÿ" },
        { id: "sh2", cat: "shopping", jp: "ã‚«ãƒ¼ãƒ‰OKï¼Ÿ", romaji: "Kaa-do OK?", cn: "å¯ä»¥åˆ·å¡å—ï¼Ÿ" },
        { id: "k1", cat: "kids", jp: "å­ä¾›æ¤…å­", romaji: "Ko-do-mo Isu", cn: "å…’ç«¥æ¤…" },
        { id: "k2", cat: "kids", jp: "ã‚¹ãƒ—ãƒ¼ãƒ³", romaji: "Su-puu-n", cn: "æ¹¯åŒ™" },
        { id: "k3", cat: "kids", jp: "ãŠæ¹¯", romaji: "O-yu", cn: "ç†±æ°´(æ³¡å¥¶)" },
        { id: "k5", cat: "kids", jp: "ã‚ªãƒ ãƒ„", romaji: "O-mu-tsu", cn: "å°¿å¸ƒ" },
        { id: "dr1", cat: "driving", jp: "æº€ã‚¿ãƒ³", romaji: "Man-tan", cn: "åŠ æ»¿æ²¹" },
        { id: "h1", cat: "hotel", jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", romaji: "Chek-ku-in", cn: "Check-in" },
        { id: "a1", cat: "airport", jp: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ", romaji: "Pa-su-poo-to", cn: "è­·ç…§" },
        { id: "x1", cat: "short", jp: "ãªã‚‹ã»ã©", romaji: "Na-ru-ho-do", cn: "åŸä¾†å¦‚æ­¤" },
        { id: "x2", cat: "short", jp: "ã™ã”ã„", romaji: "Su-go-i", cn: "å¥½å²å®³" }
    ];

    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2","s3","s4","x1"] },
        { t: "Week 2 é»é¤å…¥é–€", ids: ["d1","d2","d3"] },
        { t: "Week 3 è¦ªå­å¿…å‚™", ids: ["k1","k2","k3","k5"] }
    ];

    // --- æœƒè©±è³‡æ–™ (å®Œæ•´å›æ­¸) ---
    const dialogues = [
        {
            title: "ğŸ¨ é£¯åº— Check-in",
            msgs: [
                { r: "user", t: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŠé¡˜ã„ã—ã¾ã™ã€‚", c: "æˆ‘è¦Check-in" },
                { r: "staff", t: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’è¦‹ã›ã¦ãã ã•ã„ã€‚", c: "è«‹å‡ºç¤ºè­·ç…§" },
                { r: "user", t: "ã¯ã„ã€ã“ã‚Œã§ã™ã€‚", c: "å¥½çš„ï¼Œåœ¨é€™è£¡" },
                { r: "user", t: "æœé£Ÿã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ", c: "æ—©é¤æ˜¯å¹¾é»ï¼Ÿ" }
            ]
        },
        {
            title: "ğŸœ é¤å»³å®¢è£½é»é¤",
            msgs: [
                { r: "staff", t: "ã”æ³¨æ–‡ã¯ï¼Ÿ", c: "è«‹å•è¦é»ä»€éº¼ï¼Ÿ" },
                { r: "user", t: "ã“ã‚Œãã ã•ã„ã€‚ãƒã‚®æŠœãã§ã€‚", c: "æˆ‘è¦é€™å€‹ï¼Œä¸è¦è”¥" },
                { r: "user", t: "ã‚ã¨ã€å­ä¾›æ¤…å­ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "é‚„æœ‰ï¼Œæœ‰å…’ç«¥æ¤…å—ï¼Ÿ" },
                { r: "staff", t: "ã¯ã„ã€ã‚ã‚Šã¾ã™ã‚ˆã€‚", c: "æœ‰çš„ï¼Œé€™é‚Šè«‹" }
            ]
        },
        {
            title: "ğŸ’Š è—¥å¦åº—è²·è—¥",
            msgs: [
                { r: "user", t: "ã™ã¿ã¾ã›ã‚“ã€é¢¨é‚ªè–¬ã¯ã©ã“ï¼Ÿ", c: "ä¸å¥½æ„æ€ï¼Œæ„Ÿå†’è—¥åœ¨å“ªï¼Ÿ" },
                { r: "staff", t: "ç†±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "æœ‰ç™¼ç‡’å—ï¼Ÿ" },
                { r: "user", t: "ã¯ã„ã€å°‘ã—ã€‚", c: "æœ‰ï¼Œä¸€é»é»" },
                { r: "staff", t: "ã“ã¡ã‚‰ãŒãŠã™ã™ã‚ã§ã™ã€‚", c: "æ¨è–¦é€™å€‹çµ¦æ‚¨" }
            ]
        },
        {
            title: "ğŸª è¶…å•†çµå¸³",
            msgs: [
                { r: "staff", t: "è¢‹ã„ã‚Šã¾ã™ã‹ï¼Ÿ", c: "è¦è¢‹å­å—ï¼Ÿ" },
                { r: "user", t: "å¤§ä¸ˆå¤«ã§ã™ã€‚", c: "ä¸ç”¨äº†" },
                { r: "staff", t: "æ¸©ã‚ã¾ã™ã‹ï¼Ÿ", c: "è¦åŠ ç†±å—ï¼Ÿ" },
                { r: "user", t: "ãŠé¡˜ã„ã—ã¾ã™ã€‚", c: "éº»ç…©ä½ äº†" }
            ]
        },
        {
            title: "ğŸš• æ­è¨ˆç¨‹è»Š",
            msgs: [
                { r: "user", t: "ã“ã“ã«è¡Œã£ã¦ãã ã•ã„ã€‚", c: "è«‹å»é€™è£¡(æŒ‡åœ°åœ–)" },
                { r: "staff", t: "ã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚", c: "å¥½çš„ï¼ŒçŸ¥é“äº†" },
                { r: "user", t: "ã‚«ãƒ¼ãƒ‰OKã§ã™ã‹ï¼Ÿ", c: "å¯ä»¥åˆ·å¡å—ï¼Ÿ" },
                { r: "staff", t: "ã¯ã„ã€OKã§ã™ã€‚", c: "å¯ä»¥çš„" }
            ]
        },
        {
            title: "ğŸš— åŠ æ²¹ç«™åŠ æ²¹",
            msgs: [
                { r: "staff", t: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚", c: "æ­¡è¿å…‰è‡¨" },
                { r: "user", t: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã€æº€ã‚¿ãƒ³ã§ã€‚", c: "æ™®é€šæ²¹ï¼ŒåŠ æ»¿" },
                { r: "user", t: "ã‚´ãƒŸã€æ¨ã¦ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ", c: "å¯ä»¥å¹«æˆ‘ä¸Ÿåƒåœ¾å—ï¼Ÿ" },
                { r: "staff", t: "ã¯ã„ã€ã©ã†ãã€‚", c: "å¥½çš„ï¼Œè«‹çµ¦æˆ‘" }
            ]
        }
    ];

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let currentCat = 'all';
    let speechRate = 1.0; 
    let currentQuiz = null;

    // åˆå§‹åŒ–
    updateSenseiMsg();
    renderPlan();
    renderDialogues(); // ç¢ºä¿å‘¼å«æœƒè©±æ¸²æŸ“
    filterDict('all', null);
    
    // --- æ¸¬é©—åŠŸèƒ½ ---
    function nextQuiz() {
        const target = phrases[Math.floor(Math.random() * phrases.length)];
        currentQuiz = target;
        let options = [target];
        while(options.length < 4) {
            const wrong = phrases[Math.floor(Math.random() * phrases.length)];
            if (!options.includes(wrong)) options.push(wrong);
        }
        options.sort(() => Math.random() - 0.5);
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        document.getElementById('quiz-feedback').innerText = '';
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'quiz-btn';
            btn.innerText = opt.cn;
            btn.onclick = () => checkAnswer(opt, btn);
            container.appendChild(btn);
        });
        setTimeout(() => speak(target.jp), 300);
    }
    
    function playQuizAudio() { if(currentQuiz) speak(currentQuiz.jp); }
    
    function checkAnswer(selected, btn) {
        if(selected.id === currentQuiz.id) {
            btn.classList.add('correct');
            document.getElementById('quiz-feedback').innerText = "â­•ï¸ æ­£ç¢ºï¼";
            document.getElementById('quiz-feedback').style.color = "#30D158";
            speak("æ­£è§£", null);
            setTimeout(nextQuiz, 1500);
        } else {
            btn.classList.add('wrong');
            document.getElementById('quiz-feedback').innerText = "âŒ å†è©¦ä¸€æ¬¡";
            document.getElementById('quiz-feedback').style.color = "#FF453A";
        }
    }

    // --- èªé€Ÿåˆ‡æ› ---
    function toggleSpeed() {
        const btn = document.getElementById('speed-toggle');
        if (speechRate === 1.0) {
            speechRate = 0.55; // èª¿æ•´ç‚ºæ›´æ…¢ï¼Œå·®ç•°æ›´æ˜é¡¯
            btn.innerText = "ğŸ¢ æ…¢é€Ÿ";
            showToast("å·²åˆ‡æ›ç‚ºæ…¢é€Ÿ (0.55x)");
        } else {
            speechRate = 1.0; // æ­£å¸¸
            btn.innerText = "ğŸ‡ æ­£å¸¸";
            showToast("å·²åˆ‡æ›ç‚ºæ­£å¸¸èªé€Ÿ");
        }
    }

    // --- æ”¶è—èˆ‡ Toast ---
    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        let isAdd = false;
        if (favs.includes(id)) {
            favs = favs.filter(x => x !== id);
            el.classList.remove('fav');
        } else {
            favs.push(id);
            el.classList.add('fav');
            isAdd = true;
        }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
        showToast(isAdd ? "å·²æ”¶è— â­" : "å·²å–æ¶ˆæ”¶è—");
        if(currentCat === 'fav') filterDict('fav', null);
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1500);
    }

    // --- è¦–åœ–åˆ‡æ› ---
    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+name).classList.add('active');
        btn.classList.add('active');
        
        const isDict = name === 'dict';
        document.getElementById('tabs-bar').style.display = isDict ? 'block' : 'none';
        document.getElementById('search-bar-container').style.display = isDict ? 'block' : 'none';
        
        if(name === 'quiz') nextQuiz();
        updateSenseiMsg();
        window.scrollTo(0,0);
    }

    // --- æ¸²æŸ“åŠŸèƒ½ ---
    function updateSenseiMsg() { document.getElementById('sensei-msg').innerText = cheerQuotes[Math.floor(Math.random() * cheerQuotes.length)]; }
    
    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_v15_prog')||'[]');
        box.innerHTML = weeks.map(w => {
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `
                <div class="card" onclick="speak('${p.jp}')">
                    <div class="card-top">
                        <div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div></div>
                        <div class="card-actions">
                            <div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}')">ğŸ”</div>
                            <div class="check-box ${chk}" onclick="event.stopPropagation(); toggleCheck('${id}', this)">âœ“</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            return `<div class="week-header"><div class="week-title">${w.t}</div></div>${lessons}`;
        }).join('');
    }

    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_v15_prog')||'[]');
        if (saved.includes(id)) { saved = saved.filter(x => x !== id); el.classList.remove('checked'); }
        else { saved.push(id); el.classList.add('checked'); }
        localStorage.setItem('jp_v15_prog', JSON.stringify(saved));
    }

    function filterDict(cat, btn) {
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        currentCat = cat; document.getElementById('search-input').value = '';
        let data = phrases;
        if (cat === 'fav') { const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]'); data = phrases.filter(p => favs.includes(p.id)); }
        else if (cat !== 'all') { data = phrases.filter(p => p.cat === cat); }
        renderDictRaw(data);
    }

    function renderDictRaw(data) {
        const box = document.getElementById('dict-container');
        const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (data.length === 0) { box.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ç„¡çµæœ</div>'; return; }
        box.innerHTML = data.map(p => {
            const isFav = favs.includes(p.id) ? 'fav' : '';
            return `
            <div class="card" onclick="speak('${p.jp}')">
                <div class="card-top">
                    <div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div></div>
                    <div class="card-actions">
                        <div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}')">ğŸ”</div>
                        <div class="star-btn ${isFav}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">â˜…</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function handleSearch() {
        const key = document.getElementById('search-input').value.toLowerCase();
        renderDictRaw(phrases.filter(p => p.jp.includes(key) || p.romaji.toLowerCase().includes(key) || p.cn.includes(key)));
    }

    function renderDialogues() {
        document.getElementById('dialogue-container').innerHTML = dialogues.map(d => {
            const bubbles = d.msgs.map(m => {
                const avatar = m.r === 'user' ? 'ğŸ§‘â€ğŸ¼' : 'ğŸ‘©â€ğŸ’¼';
                const rowClass = m.r === 'user' ? 'user-row' : 'staff-row';
                return `<div class="chat-row ${rowClass}"><div class="avatar">${avatar}</div><div class="chat-bubble" onclick="speak('${m.t}')"><span class="bubble-jp">${m.t} ğŸ”Š</span><span class="bubble-cn">${m.c}</span></div></div>`;
            }).join('');
            return `<div class="dialogue-card"><div class="dialogue-header"><span>${d.title}</span></div><div class="dialogue-body">${bubbles}</div></div>`;
        }).join('');
    }

    function openFullscreen(jp, cn) { event.stopPropagation(); document.getElementById('fs-jp').innerText = jp; document.getElementById('fs-cn').innerText = cn; document.getElementById('fullscreen-overlay').style.display = 'flex'; }
    function closeFullscreen() { document.getElementById('fullscreen-overlay').style.display = 'none'; }

    function speak(txt, onEnd=null) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'ja-JP';
        u.rate = speechRate; // ä½¿ç”¨å…¨åŸŸèªé€Ÿ
        if (onEnd) u.onend = onEnd;
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
