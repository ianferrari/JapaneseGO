<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>JapaneseGO V30.0</title>
<style>
    :root { --bg:#000; --card:#1c1c1e; --acc:#0A84FF; --txt:#FFF; --sub:#8E8E93; --rom:#FFD60A; --en:#30D158; --err:#FF453A; --ok:#30D158; --safe-t:env(safe-area-inset-top); --safe-b:env(safe-area-inset-bottom); }
    *{ -webkit-tap-highlight-color:transparent; box-sizing:border-box; }
    body{ background:var(--bg); color:var(--txt); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; margin:0; padding:0; padding-bottom:calc(90px + var(--safe-b)); }
    
    /* Header */
    .sticky-header{ position:sticky; top:0; z-index:1000; background:rgba(0,0,0,0.95); backdrop-filter:blur(20px); border-bottom:1px solid #333; padding-top:var(--safe-t); }
    .header-top{ display:flex; justify-content:space-between; align-items:center; padding:10px 15px; }
    h1{ margin:0; font-size:20px; font-weight:800; background:linear-gradient(90deg,#fff,#aaa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .speed-btn{ background:#333; border:1px solid #555; color:#fff; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; cursor:pointer; }
    
    /* Search & Tabs */
    .search-box{ margin:0 15px 10px; display:none; position:relative; }
    .search-input{ width:100%; background:#2c2c2e; border:none; border-radius:10px; padding:10px 10px 10px 35px; color:#fff; font-size:16px; }
    .search-icon{ position:absolute; left:10px; top:10px; color:#888; }
    .tabs-container{ width:100%; overflow-x:auto; padding:0 15px 10px; white-space:nowrap; display:none; }
    .tabs-container::-webkit-scrollbar{ display:none; }
    .tab-btn{ display:inline-block; background:#333; color:#ccc; border:1px solid #444; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; margin-right:8px; transition:0.2s; }
    .tab-btn.active{ background:var(--acc); color:#fff; border-color:var(--acc); }

    /* Views */
    .view{ display:none; padding:15px; max-width:600px; margin:0 auto; animation:fadeIn 0.3s; }
    .view.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* Card & Elements */
    .card{ background:var(--card); border:1px solid #333; border-radius:18px; padding:18px; margin-bottom:14px; position:relative; transition:0.2s; }
    .card.active-playing{ border-color:var(--acc); background:#15202b; transform:scale(1.02); }
    .card-top{ display:flex; justify-content:space-between; align-items:flex-start; }
    .jp-big{ font-size:20px; font-weight:700; margin-bottom:4px; line-height:1.3; }
    .romaji{ font-family:monospace; color:var(--rom); font-size:13px; margin-bottom:8px; display:block; }
    .cn{ font-size:16px; color:#ddd; display:block; margin-bottom:2px; }
    .en{ font-size:13px; color:var(--en); font-weight:500; }
    .masked .romaji, .masked .cn, .masked .en{ opacity:0; filter:blur(6px); }
    .masked:active .romaji, .masked:active .cn, .masked:active .en{ opacity:1; filter:none; }
    
    .card-actions{ display:flex; gap:15px; align-items:center; margin-left:10px; flex-shrink:0; }
    .check-box{ width:28px; height:28px; border-radius:50%; border:2px solid #555; display:flex; align-items:center; justify-content:center; cursor:pointer; color:transparent; }
    .check-box.checked{ background:var(--ok); border-color:var(--ok); color:white; }
    .star-btn{ font-size:26px; color:#444; padding:5px; cursor:pointer; }
    .star-btn.fav{ color:var(--rom); }
    .trash-btn{ font-size:26px; color:#666; padding:5px; cursor:pointer; }
    .show-btn{ font-size:22px; color:#666; cursor:pointer; }

    /* Week Header */
    .week-header{ margin:30px 0 15px; }
    .week-title-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .week-title{ color:var(--acc); font-size:18px; font-weight:800; margin:0; }
    .week-actions{ display:flex; gap:8px; }
    .action-btn{ background:#222; border:1px solid #444; color:#ccc; padding:6px 12px; border-radius:15px; font-size:12px; font-weight:600; display:flex; align-items:center; gap:5px; cursor:pointer; }
    .autoplay-btn.playing{ background:var(--acc); color:#fff; border-color:var(--acc); animation:pulse 1.5s infinite; }
    @keyframes pulse{ 0%{opacity:1} 50%{opacity:0.7} 100%{opacity:1} }

    /* Quiz */
    .quiz-container{ text-align:center; margin-top:20px; }
    .quiz-speaker{ width:120px; height:120px; background:#222; border-radius:50%; margin:0 auto 30px; display:flex; align-items:center; justify-content:center; font-size:50px; border:2px solid var(--acc); cursor:pointer; box-shadow:0 0 20px rgba(10,132,255,0.2); }
    .quiz-options{ display:grid; gap:12px; }
    .quiz-btn{ background:#2c2c2e; padding:15px; border-radius:12px; border:1px solid #444; font-size:16px; font-weight:600; cursor:pointer; color:#fff; }
    .quiz-btn.correct{ background:var(--ok); border-color:var(--ok); }
    .quiz-btn.wrong{ background:var(--err); border-color:var(--err); }
    .quiz-type-selector{ display:flex; justify-content:center; gap:15px; margin-bottom:20px; }
    .q-type-btn{ padding:5px 15px; border-radius:15px; border:1px solid #555; background:#222; color:#888; font-size:13px; cursor:pointer; }
    .q-type-btn.active{ background:var(--acc); color:#fff; border-color:var(--acc); }

    /* Chat */
    .chat-course-card{ background:#1c1c1e; border:1px solid #333; border-radius:16px; margin-bottom:20px; overflow:hidden; }
    .chat-course-header{ padding:15px; background:#252525; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .chat-course-title{ font-size:16px; font-weight:700; color:#fff; display:flex; align-items:center; gap:10px; }
    .chat-course-body{ display:none; padding:15px; background:#151515; }
    .chat-course-body.open{ display:block; }
    .chat-footer{ padding:12px 15px; border-top:1px solid #333; display:flex; justify-content:flex-end; background:#222; }
    .master-btn{ background:#222; border:1px solid #555; color:#888; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:6px; cursor:pointer; }
    .master-btn.mastered{ background:var(--ok); border-color:var(--ok); color:white; }
    .chat-row{ display:flex; align-items:flex-end; gap:10px; margin-bottom:12px; }
    .chat-row.user-row{ flex-direction:row-reverse; }
    .avatar{ width:38px; height:38px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; border:1px solid #444; }
    .chat-bubble{ max-width:80%; padding:10px 14px; border-radius:16px; font-size:15px; line-height:1.4; cursor:pointer; background:#2c2c2e; color:#eee; }
    .chat-row.user-row .chat-bubble{ background:var(--acc); color:#fff; }
    .bubble-meta{ font-size:12px; opacity:0.8; margin-top:4px; display:block; }

    /* General */
    #fullscreen-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; padding:30px; text-align:center; }
    #fs-jp{ font-size:40px; font-weight:900; margin-bottom:20px; }
    #fs-cn{ font-size:24px; color:#888; margin-bottom:10px; }
    #fs-en{ font-size:18px; color:var(--en); }
    #toast{ position:fixed; bottom:100px; left:50%; transform:translateX(-50%) translateY(20px); background:rgba(30,30,30,0.95); padding:12px 24px; border-radius:30px; font-size:14px; opacity:0; pointer-events:none; transition:0.3s; z-index:9999; border:1px solid #555; display:flex; align-items:center; gap:8px; }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
    .bottom-nav{ position:fixed; bottom:0; left:0; right:0; height:85px; background:rgba(15,15,15,0.98); border-top:1px solid #333; display:flex; justify-content:space-around; padding-top:10px; z-index:2000; padding-bottom:var(--safe-b); }
    .nav-btn{ text-align:center; color:#666; font-size:10px; width:20%; cursor:pointer; }
    .nav-btn.active{ color:var(--acc); }
    .nav-icon{ font-size:24px; display:block; margin-bottom:4px; }
    .sensei-box{ background:linear-gradient(135deg,#1a2a3a,#1c1c1e); border:1px solid #333; border-radius:16px; padding:15px; margin-bottom:20px; display:flex; gap:15px; align-items:center; }
    .mask-toggle-area{ display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px 15px; border-radius:12px; margin-bottom:20px; border:1px solid #333; }
    .toggle-switch{ position:relative; width:50px; height:30px; background:#444; border-radius:15px; transition:0.3s; }
    .toggle-switch.on{ background:var(--ok); }
    .toggle-knob{ position:absolute; top:2px; left:2px; width:26px; height:26px; background:#fff; border-radius:50%; transition:0.3s; }
    .toggle-switch.on .toggle-knob{ transform:translateX(20px); }
    .toolbox-grid{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px; }
    .tool-card{ background:var(--card); border:1px solid #333; border-radius:20px; padding:20px; text-align:center; cursor:pointer; height:130px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .medical-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .med-btn{ background:#2c1a1a; border:1px solid #5a2a2a; border-radius:16px; padding:15px; text-align:center; cursor:pointer; }
    .kids-grid{ display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:10px; }
    .kid-card{ background:#fff; border-radius:20px; padding:15px; text-align:center; color:#333; cursor:pointer; }
    .kana-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
    .kana-cell{ background:#222; border-radius:8px; padding:10px 0; text-align:center; cursor:pointer; border:1px solid #333; }
    .progress-section{ background:#1c1c1e; padding:15px; border-radius:16px; border:1px solid #333; margin-bottom:20px; }
    .prog-bar{ height:8px; background:#333; border-radius:4px; overflow:hidden; margin-top:5px; }
    .prog-fill{ height:100%; background:var(--ok); width:0%; transition:0.5s; }
    .badges-container{ display:flex; justify-content:space-between; background:#222; padding:15px; border-radius:16px; margin:20px 0; border:1px solid #333; }
    .badge-item{ text-align:center; opacity:0.3; filter:grayscale(100%); transition:0.5s; }
    .badge-item.unlocked{ opacity:1; filter:grayscale(0%); transform:scale(1.1); }
    .flashcard-container { perspective: 1000px; width: 100%; height: 300px; margin-top: 20px; }
    .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; background: #222; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    .flashcard.flipped { transform: rotateY(180deg); }
    .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .flashcard-back { transform: rotateY(180deg); background: #2c2c2e; border-radius: 20px; }
    .r-btn { padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; font-size: 16px; min-width: 120px; margin-top: 20px; cursor: pointer; background: #0A84FF; color: white; }
</style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Final V30.0</span></h1>
        <button id="speed-toggle" class="speed-btn" onclick="toggleSpeed()">ğŸ¢ æ…¢é€Ÿ (0.5x)</button>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="filterDict('mistake', this)" style="color:#FF453A;border-color:#FF453A;">ğŸ’€ å¼±é»</button>
        <button class="tab-btn" onclick="filterDict('short', this)">ğŸ—£ï¸ çŸ­å¥</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ æ”¶è—</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">ç”Ÿå­˜</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">ç¾é£Ÿ</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">è³¼ç‰©</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">è¦ªå­</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">è—¥å¦</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">äº¤é€š</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">ä½å®¿</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">æ©Ÿå ´</button>
        <button class="tab-btn" onclick="filterDict('okinawa', this)" style="color:#FF2D55;">ğŸŒº æ²–ç¹©</button>
    </div>
</div>

<div id="toast">å·²æ”¶è— â­</div>
<div id="fullscreen-overlay" onclick="closeFullscreen()">
    <div id="fs-close">âœ•</div><div id="fs-jp">JP</div><div id="fs-cn">CN</div><div id="fs-en">EN</div><div style="margin-top:30px;color:#555;">(é»æ“Šé—œé–‰)</div>
</div>

<div id="view-learn" class="view active">
    <div class="sensei-box">
        <div style="font-size:40px;">ğŸ¦</div>
        <div style="flex:1;"><div style="font-size:13px;color:#0A84FF;font-weight:bold;margin-bottom:4px;">æ•™ç·´å®åš€</div><div id="sensei-msg" style="font-size:15px;">...</div></div>
    </div>
    <div class="mask-toggle-area" onclick="toggleMask()">
        <div><div style="font-weight:bold;">ğŸ«£ è¨˜æ†¶é®æ“‹ (Mask Mode)</div><div style="font-size:12px;color:#888;">éš±è—ä¸­æ–‡ï¼Œè€ƒè€ƒè‡ªå·±</div></div>
        <div id="mask-switch" class="toggle-switch"><div class="toggle-knob"></div></div>
    </div>
    <div class="progress-section">
        <div class="prog-title"><span>ç‰¹è¨“å®Œæˆåº¦</span><span id="vocab-prog-text">0%</span></div>
        <div class="prog-bar"><div id="vocab-prog-fill" class="prog-fill"></div></div>
    </div>
    <div class="badges-container">
        <div id="badge-25" class="badge-item"><span class="badge-icon">ğŸŒº</span><div class="badge-text">æ–°æ‰‹</div></div>
        <div id="badge-50" class="badge-item"><span class="badge-icon">ğŸ¦</span><div class="badge-text">ç†Ÿç·´</div></div>
        <div id="badge-75" class="badge-item"><span class="badge-icon">ğŸ‹</span><div class="badge-text">é”äºº</div></div>
        <div id="badge-100" class="badge-item"><span class="badge-icon">ğŸ°</span><div class="badge-text">æ²–ç¹©é€š</div></div>
    </div>
    <div id="curriculum-container" style="margin-top:20px;"></div>
    <div style="margin-top:20px;font-size:12px;color:#555;text-align:center;text-decoration:underline;cursor:pointer;" onclick="resetAllProgress()">[æ¸…é™¤å…¨éƒ¨è³‡æ–™]</div>
</div>

<div id="view-quiz" class="view">
    <div class="quiz-type-selector">
        <div class="q-type-btn active" id="q-type-word" onclick="setQuizType('word')">å–®å­—æ¸¬é©—</div>
        <div class="q-type-btn" id="q-type-kana" onclick="setQuizType('kana')">äº”åéŸ³æ¸¬é©—</div>
    </div>
    <div style="text-align:center;margin:10px 0 20px;"><h2 id="quiz-title">ğŸ‘‚ è½éŸ³è¾¨ç¾©</h2><div style="color:#888;font-size:13px;">éŒ¯é¡Œæœƒè‡ªå‹•åŠ å…¥ã€Œå¼±é»ã€å­—å…¸</div></div>
    <div class="quiz-container">
        <div class="quiz-speaker" onclick="playQuizAudio()">ğŸ”Š</div>
        <div id="quiz-txt-display" style="font-size:40px;font-weight:bold;margin-bottom:20px;display:none;color:#FFD60A;font-family:monospace;"></div>
        <div id="quiz-options" style="display:grid;gap:12px;"></div>
        <div id="quiz-feedback" style="margin-top:20px;font-size:18px;font-weight:bold;height:30px;"></div>
        <button style="margin-top:20px;background:#444;color:white;padding:10px 20px;border-radius:20px;border:none;" onclick="nextQuiz()">Skip / Next</button>
    </div>
</div>

<div id="view-chat" class="view">
    <div class="progress-section">
        <div class="prog-title"><span>æœƒè©±æ”»ç•¥é€²åº¦</span><span id="chat-prog-text">0%</span></div>
        <div class="prog-bar"><div id="chat-prog-fill" class="prog-fill" style="background:#0A84FF;"></div></div>
    </div>
    <div id="chat-container"></div>
</div>

<div id="view-dict" class="view"><div id="dict-container"></div></div>

<div id="view-tools" class="view">
    <div class="toolbox-grid">
        <div class="tool-card" onclick="openTool('medical')"><div style="font-size:40px;">ğŸ¥</div><div style="font-weight:bold;margin-top:10px;">æ€¥æ•‘æŒ‡æŒ‡é€š</div><div style="font-size:12px;color:#888;">Medical</div></div>
        <div class="tool-card" onclick="openTool('kana')"><div style="font-size:40px;">ğŸ”¤</div><div style="font-weight:bold;margin-top:10px;">äº”åéŸ³è¡¨</div><div style="font-size:12px;color:#888;">Kana Table</div></div>
        <div class="tool-card" onclick="openTool('kids')"><div style="font-size:40px;">ğŸ‘¶</div><div style="font-weight:bold;margin-top:10px;">å¥å¥å°ˆå€</div><div style="font-size:12px;color:#888;">Kids Mode</div></div>
        <div class="tool-card" onclick="openTool('review')"><div style="font-size:40px;">ğŸ”€</div><div style="font-weight:bold;margin-top:10px;">éš¨æ©Ÿè¤‡ç¿’</div><div style="font-size:12px;color:#888;">Review</div></div>
    </div>
</div>
<div id="view-medical" class="view"><div style="margin-bottom:20px;cursor:pointer;color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div><div class="medical-grid" id="medical-grid"></div></div>
<div id="view-kana" class="view"><div style="margin-bottom:20px;cursor:pointer;color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div><div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px;"><button class="tab-btn active" onclick="renderKana('hira')">å¹³å‡å</button><button class="tab-btn" onclick="renderKana('kata')">ç‰‡å‡å</button></div><div id="kana-grid" class="kana-grid"></div></div>
<div id="view-kids" class="view" style="background:#f0f8ff;min-height:100vh;"><div style="margin-bottom:20px;cursor:pointer;color:#0A84FF;font-weight:bold;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div><div class="kids-grid" id="kids-grid"></div></div>
<div id="view-review" class="view">
    <div style="margin-bottom:20px;cursor:pointer;color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… è¿”å›ç™¾å¯¶ç®±</div>
    <div style="text-align:center;margin:20px 0;"><h2>ğŸ”€ éš¨æ©ŸæŠ½è€ƒ</h2><div style="color:#888;">å¾å·²å­¸ç¿’å–®å­—å‡ºé¡Œ</div></div>
    <div id="review-area" style="display:none;">
        <div class="flashcard-container" onclick="flipCard()"><div id="flashcard" class="flashcard"><div class="flashcard-front"><div style="font-size:32px;font-weight:800;margin-bottom:10px;" id="fc-jp"></div><div style="color:#FFD60A;font-family:monospace;" id="fc-romaji"></div><div style="margin-top:20px;color:#666;font-size:12px;">(é»æ“Šç¿»é¢)</div></div><div class="flashcard-back"><div style="font-size:24px;font-weight:bold;" id="fc-cn"></div><div style="margin-top:20px;font-size:30px;" onclick="event.stopPropagation();speakCurrentCard()">ğŸ”Š</div></div></div></div>
        <div style="text-align:center;"><button class="r-btn next" onclick="nextCard()">ä¸‹ä¸€é¡Œ</button></div>
    </div>
    <div id="empty-review" style="text-align:center;margin-top:50px;color:#666;display:none;"><div style="font-size:50px;margin-bottom:20px;">ğŸ“</div>å°šæœªå‹¾é¸ä»»ä½•å–®å­—</div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)"><span class="nav-icon">ğŸ“…</span>ç‰¹è¨“</div>
    <div class="nav-btn" onclick="switchView('quiz', this)"><span class="nav-icon">ğŸ®</span>æ¸¬é©—</div>
    <div class="nav-btn" onclick="switchView('chat', this)"><span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±</div>
    <div class="nav-btn" onclick="switchView('dict', this)"><span class="nav-icon">ğŸ“–</span>å­—å…¸</div>
    <div class="nav-btn" id="nav-tools" onclick="switchView('tools', this)"><span class="nav-icon">ğŸ§°</span>ç™¾å¯¶ç®±</div>
</div>

<script>
    // --- å®Œæ•´è³‡æ–™åº« (V30.0 Full) ---
    const phrases = [
        { id: "x1", cat: "short", jp: "ãªã‚‹ã»ã©", romaji: "Na-ru-ho-do", cn: "åŸä¾†å¦‚æ­¤", en: "I see" },
        { id: "x2", cat: "short", jp: "ã™ã”ã„", romaji: "Su-go-i", cn: "å¥½å²å®³", en: "Amazing" },
        { id: "x3", cat: "short", jp: "æœ¬å½“ï¼Ÿ", romaji: "Hon-tou?", cn: "çœŸçš„å—ï¼Ÿ", en: "Really?" },
        { id: "x4", cat: "short", jp: "ã¡ã‚‡ã£ã¨...", romaji: "Chot-to...", cn: "æœ‰é»...(å©‰æ‹’)", en: "It's a bit..." },
        { id: "x5", cat: "short", jp: "ã‚‚ã¡ã‚ã‚“ã§ã™", romaji: "Mo-chi-ron", cn: "ç•¶ç„¶", en: "Of course" },
        { id: "x6", cat: "short", jp: "ã„ã„ã§ã™ã‚ˆ", romaji: "Ii de-su yo", cn: "å¯ä»¥å–”", en: "That's fine" },
        { id: "x7", cat: "short", jp: "ãŠè…¹ã™ã„ãŸ", romaji: "O-na-ka su-i-ta", cn: "è‚šå­é¤“äº†", en: "I'm hungry" },
        { id: "x8", cat: "short", jp: "ç–²ã‚ŒãŸ", romaji: "Tsu-ka-re-ta", cn: "ç´¯äº†", en: "I'm tired" },
        { id: "x9", cat: "short", jp: "å¯æ„›ã„ï¼", romaji: "Ka-wai-i!", cn: "å¥½å¯æ„›ï¼", en: "So cute!" },
        { id: "x10", cat: "short", jp: "ã‚„ã°ã„", romaji: "Ya-bai", cn: "ç³Ÿç³•/å²å®³", en: "OMG" },
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€", en: "Excuse me" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "A-ri-ga-tou", cn: "è¬è¬", en: "Thank you" },
        { id: "s3", cat: "survival", jp: "å¤§ä¸ˆå¤«ã§ã™", romaji: "Dai-jou-bu", cn: "æ²’é—œä¿‚", en: "It's okay" },
        { id: "s4", cat: "survival", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", romaji: "To-i-re wa do-ko?", cn: "å»æ‰€åœ¨å“ªï¼Ÿ", en: "Where is the toilet?" },
        { id: "s5", cat: "survival", jp: "å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„", romaji: "Sha-shin o tot-te", cn: "è«‹å¹«æˆ‘æ‹ç…§", en: "Take a photo please" },
        { id: "s6", cat: "survival", jp: "ã‚ã‹ã‚Šã¾ã›ã‚“", romaji: "Wa-ka-ri-ma-sen", cn: "è½ä¸æ‡‚", en: "I don't understand" },
        { id: "s7", cat: "survival", jp: "ã“ã‚Œ", romaji: "Ko-re", cn: "é€™å€‹", en: "This one" },
        { id: "s8", cat: "survival", jp: "ã¯ã„ / ã„ã„ãˆ", romaji: "Hai / Ii-e", cn: "æ˜¯ / ä¸æ˜¯", en: "Yes / No" },
        { id: "d1", cat: "dining", jp: "ã“ã‚Œãã ã•ã„", romaji: "Ko-re Ku-da-sai", cn: "æˆ‘è¦é€™å€‹", en: "This one please" },
        { id: "d2", cat: "dining", jp: "ãŠæ°´ãã ã•ã„", romaji: "O-mi-zu", cn: "è«‹çµ¦æˆ‘æ°´", en: "Water please" },
        { id: "d3", cat: "dining", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", romaji: "O-kai-kei", cn: "éº»ç…©çµå¸³", en: "Check please" },
        { id: "d4", cat: "dining", jp: "ãƒã‚®æŠœãã§", romaji: "Ne-gi nu-ki de", cn: "ä¸è¦åŠ è”¥", en: "No green onions" },
        { id: "d5", cat: "dining", jp: "æ°·ãªã—", romaji: "Koo-ri na-shi", cn: "å»å†°", en: "No ice" },
        { id: "d6", cat: "dining", jp: "æŒã¡å¸°ã‚Šã§", romaji: "Mo-chi-ka-e-ri de", cn: "æˆ‘è¦å¤–å¸¶", en: "Take out" },
        { id: "d7", cat: "dining", jp: "åˆ¥ã€…ã§", romaji: "Be-tsu be-tsu de", cn: "åˆ†é–‹çµå¸³", en: "Separate checks" },
        { id: "d8", cat: "dining", jp: "ãŠã™ã™ã‚ã¯ï¼Ÿ", romaji: "O-su-su-me wa?", cn: "æœ‰æ¨è–¦çš„å—ï¼Ÿ", en: "Recommendation?" },
        { id: "d9", cat: "dining", jp: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼", romaji: "Me-nyuu", cn: "èœå–®", en: "Menu" },
        { id: "d10", cat: "dining", jp: "è±šè‚‰", romaji: "Bu-ta ni-ku", cn: "è±¬è‚‰", en: "Pork" },
        { id: "d11", cat: "dining", jp: "ç‰›è‚‰", romaji: "Gyuu ni-ku", cn: "ç‰›è‚‰", en: "Beef" },
        { id: "d12", cat: "dining", jp: "é¶è‚‰", romaji: "To-ri ni-ku", cn: "é›è‚‰", en: "Chicken" },
        { id: "d13", cat: "dining", jp: "é­š", romaji: "Sa-ka-na", cn: "é­š", en: "Fish" },
        { id: "d14", cat: "dining", jp: "ç”Ÿãƒ“ãƒ¼ãƒ«", romaji: "Na-ma bii-ru", cn: "ç”Ÿå•¤é…’", en: "Draft beer" },
        { id: "sh1", cat: "shopping", jp: "ã„ãã‚‰ã§ã™ã‹ï¼Ÿ", romaji: "I-ku-ra?", cn: "å¤šå°‘éŒ¢ï¼Ÿ", en: "How much?" },
        { id: "sh2", cat: "shopping", jp: "ã‚«ãƒ¼ãƒ‰ä½¿ãˆã¾ã™ã‹ï¼Ÿ", romaji: "Kaa-do OK?", cn: "å¯ä»¥åˆ·å¡å—ï¼Ÿ", en: "Card OK?" },
        { id: "sh3", cat: "shopping", jp: "å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ", romaji: "Men-zei", cn: "å¯ä»¥é€€ç¨…å—ï¼Ÿ", en: "Tax free?" },
        { id: "sh4", cat: "shopping", jp: "æ–°ã—ã„ã®ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", romaji: "A-ta-ra-shii no", cn: "æœ‰æ–°çš„å—ï¼Ÿ", en: "New one?" },
        { id: "sh5", cat: "shopping", jp: "è¢‹ã„ã‚Šã¾ã›ã‚“", romaji: "Fu-ku-ro i-ri-ma-sen", cn: "ä¸ç”¨è¢‹å­", en: "No bag" },
        { id: "sh6", cat: "shopping", jp: "ãƒ¬ã‚·ãƒ¼ãƒˆ", romaji: "Re-shii-to", cn: "æ”¶æ“š", en: "Receipt" },
        { id: "sh7", cat: "shopping", jp: "å¤§ãã„ã‚µã‚¤ã‚º", romaji: "Oo-kii sa-i-zu", cn: "å¤§å°ºå¯¸", en: "Bigger size" },
        { id: "sh8", cat: "shopping", jp: "å°ã•ã„ã‚µã‚¤ã‚º", romaji: "Chii-sai sa-i-zu", cn: "å°å°ºå¯¸", en: "Smaller size" },
        { id: "sh9", cat: "shopping", jp: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", romaji: "Pu-re-zen-to", cn: "ç¦®ç‰©", en: "Gift" },
        { id: "k1", cat: "kids", jp: "å­ä¾›æ¤…å­", romaji: "Ko-do-mo Isu", cn: "å…’ç«¥æ¤…", en: "High chair" },
        { id: "k2", cat: "kids", jp: "ã‚¹ãƒ—ãƒ¼ãƒ³", romaji: "Su-puu-n", cn: "æ¹¯åŒ™", en: "Spoon" },
        { id: "k3", cat: "kids", jp: "ãŠæ¹¯", romaji: "O-yu", cn: "ç†±æ°´(æ³¡å¥¶)", en: "Hot water" },
        { id: "k4", cat: "kids", jp: "ã‹ã‚ã„ã„", romaji: "Ka-wai-i", cn: "å¥½å¯æ„›", en: "Cute" },
        { id: "k5", cat: "kids", jp: "ã‚ªãƒ ãƒ„", romaji: "O-mu-tsu", cn: "å°¿å¸ƒ", en: "Diaper" },
        { id: "k6", cat: "kids", jp: "ãŠã—ã‚Šãµã", romaji: "O-shi-ri fu-ki", cn: "æ¿•ç´™å·¾", en: "Wipes" },
        { id: "k7", cat: "kids", jp: "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼", romaji: "Be-bii kaa", cn: "å¬°å…’è»Š", en: "Stroller" },
        { id: "k8", cat: "kids", jp: "ãƒŸãƒ«ã‚¯", romaji: "Mi-ru-ku", cn: "ç‰›å¥¶", en: "Milk" },
        { id: "k9", cat: "kids", jp: "æˆä¹³å®¤", romaji: "Ju-nyuu shi-tsu", cn: "å“ºä¹³å®¤", en: "Nursing room" },
        { id: "m1", cat: "drug", jp: "é¢¨é‚ªè–¬", romaji: "Ka-ze gu-su-ri", cn: "æ„Ÿå†’è—¥", en: "Cold medicine" },
        { id: "m2", cat: "drug", jp: "é ­ç—›è–¬", romaji: "Zu-tsuu ya-ku", cn: "é ­ç—›è—¥", en: "Headache med" },
        { id: "m3", cat: "drug", jp: "çµ†å‰µè†", romaji: "Ban-sou-kou", cn: "OKç¹ƒ", en: "Band-aid" },
        { id: "m4", cat: "drug", jp: "è™«é™¤ã‘", romaji: "Mu-shi yo-ke", cn: "é˜²èšŠæ¶²", en: "Bug spray" },
        { id: "m5", cat: "drug", jp: "æ—¥ç„¼ã‘æ­¢ã‚", romaji: "Hi-ya-ke do-me", cn: "é˜²æ›¬ä¹³", en: "Sunscreen" },
        { id: "m6", cat: "drug", jp: "ç†±ãŒã‚ã‚Šã¾ã™", romaji: "Ne-tsu ga a-ri-ma-su", cn: "ç™¼ç‡’", en: "Has fever" },
        { id: "m7", cat: "drug", jp: "å’³", romaji: "Se-ki", cn: "å’³å—½", en: "Cough" },
        { id: "m8", cat: "drug", jp: "é¼»æ°´", romaji: "Ha-na mi-zu", cn: "æµé¼»æ°´", en: "Runny nose" },
        { id: "m9", cat: "drug", jp: "è–¬å±€", romaji: "Yak-kyo-ku", cn: "è—¥å±€", en: "Pharmacy" },
        { id: "m10", cat: "drug", jp: "ç—…é™¢", romaji: "Byou-in", cn: "é†«é™¢", en: "Hospital" },
        { id: "dr1", cat: "driving", jp: "æº€ã‚¿ãƒ³", romaji: "Man-tan", cn: "åŠ æ»¿æ²¹", en: "Full tank" },
        { id: "dr2", cat: "driving", jp: "é§è»Šå ´", romaji: "Chuu-sha-jou", cn: "åœè»Šå ´", en: "Parking" },
        { id: "dr3", cat: "driving", jp: "ãƒŠãƒ“è¨­å®š", romaji: "Na-bi set-tei", cn: "è¨­å®šå°èˆª", en: "GPS setting" },
        { id: "dr4", cat: "driving", jp: "ã“ã“ã«è¡ŒããŸã„", romaji: "Ko-ko ni i-ki-tai", cn: "æˆ‘æƒ³å»é€™è£¡", en: "Go here" },
        { id: "dr5", cat: "driving", jp: "ã‚¿ã‚¯ã‚·ãƒ¼", romaji: "Ta-ku-shii", cn: "è¨ˆç¨‹è»Š", en: "Taxi" },
        { id: "dr6", cat: "driving", jp: "ãƒã‚¹åœ", romaji: "Ba-su tei", cn: "å…¬è»Šç«™", en: "Bus stop" },
        { id: "dr7", cat: "driving", jp: "ã¾ã£ã™ã", romaji: "Mas-su-gu", cn: "ç›´èµ°", en: "Straight" },
        { id: "h1", cat: "hotel", jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", romaji: "Chek-ku-in", cn: "Check-in", en: "Check-in" },
        { id: "h2", cat: "hotel", jp: "è·ç‰©é ã‹ã‚Š", romaji: "Ni-mo-tsu a-zu-ka-ri", cn: "å¯„æ”¾è¡Œæ", en: "Keep luggage" },
        { id: "h3", cat: "hotel", jp: "Wi-Fiãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", romaji: "Wi-Fi pa-su-waa-do", cn: "Wi-Fiå¯†ç¢¼", en: "WiFi Password" },
        { id: "h4", cat: "hotel", jp: "æœé£Ÿ", romaji: "Chou-sho-ku", cn: "æ—©é¤", en: "Breakfast" },
        { id: "a1", cat: "airport", jp: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ", romaji: "Pa-su-poo-to", cn: "è­·ç…§", en: "Passport" },
        { id: "a2", cat: "airport", jp: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼", romaji: "Ren-ta-kaa", cn: "ç§Ÿè»Š", en: "Rental car" },
        { id: "a3", cat: "airport", jp: "ãƒã‚¹ä¹—ã‚Šå ´", romaji: "Ba-su no-ri-ba", cn: "å·´å£«æ­ä¹˜è™•", en: "Bus stop" },
        { id: "a4", cat: "airport", jp: "å›½éš›ç·š", romaji: "Ko-ku-sai-sen", cn: "åœ‹éš›ç·š", en: "International" },
        { id: "a5", cat: "airport", jp: "è½ã¨ã—ç‰©", romaji: "O-to-shi mo-no", cn: "éºå¤±ç‰©", en: "Lost item" },
        { id: "o1", cat: "okinawa", jp: "ã¯ã„ã•ã„", romaji: "Hai-sai", cn: "ä½ å¥½", en: "Hello" },
        { id: "o2", cat: "okinawa", jp: "ã‚ã‚“ããƒ¼ã‚Œ", romaji: "Men-so-re", cn: "æ­¡è¿å…‰è‡¨", en: "Welcome" },
        { id: "o3", cat: "okinawa", jp: "ã«ãµã‡ãƒ¼ã§ãƒ¼ã³ã‚‹", romaji: "Ni-fee-dee-bi-ru", cn: "è¬è¬", en: "Thank you" },
        { id: "o4", cat: "okinawa", jp: "ãªã‚“ãã‚‹ãªã„ã•", romaji: "Nan-ku-ru nai-sa", cn: "èˆ¹åˆ°æ©‹é ­è‡ªç„¶ç›´", en: "It'll be fine" },
        { id: "o5", cat: "okinawa", jp: "ã‚´ãƒ¼ãƒ¤", romaji: "Goo-ya", cn: "è‹¦ç“œ", en: "Bitter melon" },
        { id: "o6", cat: "okinawa", jp: "ã‚ªãƒªã‚ªãƒ³ãƒ“ãƒ¼ãƒ«", romaji: "O-ri-on Bii-ru", cn: "Orion å•¤é…’", en: "Orion Beer" },
        { id: "o7", cat: "okinawa", jp: "ã‚½ãƒ¼ã‚­ãã°", romaji: "Soo-ki So-ba", cn: "æ’éª¨éºµ", en: "Soki Soba" },
        { id: "o8", cat: "okinawa", jp: "ã‚¢ã‚°ãƒ¼è±š", romaji: "A-guu Bu-ta", cn: "é˜¿å¤è±¬", en: "Agu Pork" }
    ];

    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2","s3","s4","x1"] },
        { t: "Week 2 æºé€šå›æ‡‰", ids: ["s6","s8","s5","d1","x3"] },
        { t: "Week 3 é»é¤å…¥é–€", ids: ["d2","d3","d5","d9","x7"] },
        { t: "Week 4 é»é¤é«˜æ‰‹", ids: ["d4","d6","d7","d8","x5"] },
        { t: "Week 5 é»é¤é€²éš", ids: ["d10","d11","d12","d13","d14"] },
        { t: "Week 6 è³¼ç‰©åŸºç¤", ids: ["sh1","sh2","sh3","sh5","x2"] },
        { t: "Week 7 è³¼ç‰©é€²éš", ids: ["sh4","sh6","sh7","sh8","sh9"] },
        { t: "Week 8 è¦ªå­å¿…å‚™(1)", ids: ["k1","k2","k3","k4","x9"] },
        { t: "Week 9 è¦ªå­å¿…å‚™(2)", ids: ["k5","k6","k7","k8"] },
        { t: "Week 10 è—¥å¦ç—‡ç‹€(1)", ids: ["m1","m2","m3","m6","x4"] },
        { t: "Week 11 è—¥å¦ç—‡ç‹€(2)", ids: ["m4","m5","m7","m8"] },
        { t: "Week 12 äº¤é€šç§»å‹•", ids: ["dr5","dr6","dr7","a3"] },
        { t: "Week 13 è‡ªé§•ç§Ÿè»Š", ids: ["a2","dr1","dr2","dr3"] },
        { t: "Week 14 é£¯åº—ä½å®¿", ids: ["h1","h2","h3","h4","x6"] },
        { t: "Week 15 æ©Ÿå ´é€šé—œ", ids: ["a1","a4","a5","s5","s1"] },
        { t: "Week 16 å‡ºç™¼æº–å‚™", ids: ["s2","d1","sh1","dr1","x10"] }
    ];

    const chatCourse = [
        { 
            id: "c1", title: "ğŸ¨ é£¯åº— Check-in", icon: "ğŸ¨",
            msgs: [{r:"user",t:"ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"æˆ‘è¦Check-in",e:"Check-in please."},{r:"staff",t:"ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’è¦‹ã›ã¦ãã ã•ã„ã€‚",c:"è«‹å‡ºç¤ºè­·ç…§",e:"Passport please."},{r:"user",t:"ã¯ã„ã€ã“ã‚Œã§ã™ã€‚",c:"å¥½çš„ï¼Œåœ¨é€™è£¡",e:"Here it is."},{r:"staff",t:"æœé£Ÿã¯7æ™‚ã‹ã‚‰10æ™‚ã§ã™ã€‚",c:"æ—©é¤æ˜¯7é»åˆ°10é»",e:"Breakfast 7-10."},{r:"user",t:"Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ï¼Ÿ",c:"Wi-Fiå¯†ç¢¼æ˜¯ï¼Ÿ",e:"Wi-Fi password?"},{r:"staff",t:"ã‚«ãƒ¼ãƒ‰ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚",c:"å¯«åœ¨å¡ç‰‡ä¸Š",e:"On the card."}]
        },
        { 
            id: "c2", title: "ğŸœ é¤å»³ç”¨é¤", icon: "ğŸœ",
            msgs: [{r:"staff",t:"ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ä½•åæ§˜ï¼Ÿ",c:"æ­¡è¿å…‰è‡¨ï¼Œå¹¾ä½ï¼Ÿ",e:"Welcome. How many?"},{r:"user",t:"å¤§äºº2äººã€å­ä¾›1äººã§ã™ã€‚",c:"å¤§äºº2ä½ï¼Œå°å­©1ä½",e:"2 adults, 1 child."},{r:"user",t:"å­ä¾›æ¤…å­ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",c:"æœ‰å…’ç«¥æ¤…å—ï¼Ÿ",e:"High chair?"},{r:"staff",t:"ã“ã¡ã‚‰ã¸ã©ã†ãã€‚",c:"é€™é‚Šè«‹",e:"This way."},{r:"user",t:"ã“ã‚Œã¨ã“ã‚Œã‚’ãã ã•ã„ã€‚",c:"æˆ‘è¦é€™å€‹è·Ÿé€™å€‹",e:"This and this."},{r:"user",t:"ãƒã‚®æŠœãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"è«‹ä¸è¦åŠ è”¥",e:"No onions."},{r:"user",t:"ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"éº»ç…©çµå¸³",e:"Check please."}]
        },
        { 
            id: "c3", title: "ğŸ’Š è—¥å¦åº—å…ç¨…", icon: "ğŸ’Š",
            msgs: [{r:"user",t:"ã™ã¿ã¾ã›ã‚“ã€é¢¨é‚ªè–¬ã¯ã©ã“ï¼Ÿ",c:"ä¸å¥½æ„æ€ï¼Œæ„Ÿå†’è—¥åœ¨å“ªï¼Ÿ",e:"Cold medicine?"},{r:"staff",t:"ç†±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",c:"æœ‰ç™¼ç‡’å—ï¼Ÿ",e:"Fever?"},{r:"user",t:"ã¯ã„ã€å°‘ã—ã€‚",c:"æœ‰ï¼Œä¸€é»é»",e:"A little."},{r:"staff",t:"ã“ã¡ã‚‰ãŒãŠã™ã™ã‚ã§ã™ã€‚",c:"æ¨è–¦é€™å€‹çµ¦æ‚¨",e:"Recommend this."},{r:"user",t:"å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ",c:"å¯ä»¥é€€ç¨…å—ï¼Ÿ",e:"Tax free?"},{r:"staff",t:"ã¯ã„ã€ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’ã€‚",c:"å¯ä»¥ï¼Œè«‹å‡ºç¤ºè­·ç…§",e:"Passport please."}]
        },
        { 
            id: "c4", title: "ğŸš— ç§Ÿè»Šèˆ‡åŠ æ²¹", icon: "ğŸš—",
            msgs: [{r:"user",t:"äºˆç´„ã—ã¦ã„ã¾ã™ã€‚",c:"æˆ‘æœ‰é ç´„",e:"Reserved."},{r:"staff",t:"å…è¨±è¨¼ã¨ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’ã€‚",c:"è«‹å‡ºç¤ºé§•ç…§è­·ç…§",e:"License & Passport."},{r:"user",t:"ãƒŠãƒ“ã®è¨­å®šã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"è«‹å¹«æˆ‘è¨­å®šå°èˆª",e:"Set GPS please."},{r:"staff",t:"è¿”å´ã¯æº€ã‚¿ãƒ³ã§ã€‚",c:"é‚„è»Šæ™‚è«‹åŠ æ»¿æ²¹",e:"Return full."},{r:"staff",t:"ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã§ã™ã‹ï¼Ÿ",c:"(åŠ æ²¹ç«™) åŠ æ™®é€šæ²¹å—ï¼Ÿ",e:"Regular?"},{r:"user",t:"ã¯ã„ã€æº€ã‚¿ãƒ³ã§ã€‚",c:"å°ï¼ŒåŠ æ»¿",e:"Full tank."}]
        },
        { 
            id: "c5", title: "ğŸ‘¶ è¦ªå­çªç™¼ç‹€æ³", icon: "ğŸ‘¶",
            msgs: [{r:"user",t:"ã™ã¿ã¾ã›ã‚“ï¼æ°´ã‚’ã“ã¼ã—ã¾ã—ãŸã€‚",c:"å°ä¸èµ·ï¼æ‰“ç¿»æ°´äº†",e:"Spilled water!"},{r:"staff",t:"å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ",c:"æ²’äº‹å§ï¼Ÿ",e:"Are you OK?"},{r:"user",t:"ã™ã¿ã¾ã›ã‚“ã€ã‚¿ã‚ªãƒ«ãã ã•ã„ã€‚",c:"æŠ±æ­‰ï¼Œè«‹çµ¦æˆ‘æ¯›å·¾",e:"Towel please."},{r:"user",t:"æˆä¹³å®¤ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",c:"æœ‰å“ºä¹³å®¤å—ï¼Ÿ",e:"Nursing room?"},{r:"staff",t:"ã¯ã„ã€å¥¥ã«ã‚ã‚Šã¾ã™ã€‚",c:"æœ‰ï¼Œåœ¨è£¡é¢",e:"In the back."}]
        },
        { 
            id: "c6", title: "ğŸš• æ­è¨ˆç¨‹è»Š", icon: "ğŸš•",
            msgs: [{r:"user",t:"ã“ã“ã«è¡Œã£ã¦ãã ã•ã„ã€‚",c:"è«‹å»é€™è£¡(æŒ‡åœ°åœ–)",e:"Go here please."},{r:"staff",t:"ã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚",c:"å¥½çš„ï¼ŒçŸ¥é“äº†",e:"Understood."},{r:"user",t:"ã‚«ãƒ¼ãƒ‰OKã§ã™ã‹ï¼Ÿ",c:"å¯ä»¥åˆ·å¡å—ï¼Ÿ",e:"Card OK?"},{r:"staff",t:"ã¯ã„ã€OKã§ã™ã€‚",c:"å¯ä»¥çš„",e:"Yes."},{r:"user",t:"ãƒ¬ã‚·ãƒ¼ãƒˆãã ã•ã„ã€‚",c:"è«‹çµ¦æˆ‘æ”¶æ“š",e:"Receipt please."}]
        },
        { 
            id: "c7", title: "ğŸª è¶…å•†çµå¸³", icon: "ğŸª",
            msgs: [{r:"staff",t:"è¢‹ã„ã‚Šã¾ã™ã‹ï¼Ÿ",c:"è¦è¢‹å­å—ï¼Ÿ",e:"Bag?"},{r:"user",t:"å¤§ä¸ˆå¤«ã§ã™ã€‚",c:"ä¸ç”¨äº†",e:"No thanks."},{r:"staff",t:"æ¸©ã‚ã¾ã™ã‹ï¼Ÿ",c:"è¦åŠ ç†±å—ï¼Ÿ",e:"Warm up?"},{r:"user",t:"ãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"éº»ç…©ä½ äº†",e:"Yes please."}]
        },
        { 
            id: "c8", title: "âœˆï¸ æ©Ÿå ´/ç§Ÿè»Šæ«ƒæª¯", icon: "âœˆï¸",
            msgs: [{r:"user",t:"äºˆç´„ã—ã¦ã„ã¾ã™ã€‚",c:"æˆ‘æœ‰é ç´„",e:"Reserved."},{r:"staff",t:"ãŠåå‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",c:"è«‹å‘Šè¨´æˆ‘å¤§å",e:"Name please."},{r:"user",t:"å°æ¹¾ã®ã€‡ã€‡ã§ã™ã€‚",c:"æˆ‘æ˜¯å°ç£çš„ã€‡ã€‡",e:"I am OO from Taiwan."},{r:"staff",t:"ãƒã‚¹ã§ãŠå¾…ã¡ãã ã•ã„ã€‚",c:"è«‹åœ¨å·´å£«ä¸Šç¨ç­‰",e:"Wait on bus."}]
        },
        { 
            id: "c9", title: "ğŸŒº æ²–ç¹©éºµåº—", icon: "ğŸŒº",
            msgs: [{r:"staff",t:"ã‚ã‚“ããƒ¼ã‚Œï¼",c:"æ­¡è¿å…‰è‡¨(æ²–ç¹©è©±)",e:"Welcome!"},{r:"user",t:"ã‚½ãƒ¼ã‚­ãã°ãã ã•ã„ã€‚",c:"æˆ‘è¦æ’éª¨éºµ",e:"Soki soba please."},{r:"staff",t:"ã¯ã„ã‚ˆï¼",c:"å¥½å–”ï¼",e:"Sure!"},{r:"user",t:"ã«ãµã‡ãƒ¼ã§ãƒ¼ã³ã‚‹ï¼",c:"è¬è¬(æ²–ç¹©è©±)",e:"Thank you!"}]
        }
    ];

    let currentCat = 'all';
    let isMasked = false;
    let isPlaying = false;
    let speechRate = 1.0;
    let currentQuiz = null;
    let quizType = 'word';

    const medicalItems = [
        {t:"ç†±ãŒã‚ã‚Šã¾ã™",c:"ç™¼ç‡’",e:"Fever"}, {t:"ãŠè…¹ãŒç—›ã„",c:"è‚šå­ç—›",e:"Stomachache"},
        {t:"åãæ°—ãŒã—ã¾ã™",c:"æƒ³å",e:"Nausea"}, {t:"æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ",c:"å—å‚·",e:"Injured"},
        {t:"åµã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼",c:"è›‹éæ•",e:"Egg Allergy"}, {t:"ç‰›ä¹³ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼",c:"å¥¶éæ•",e:"Milk Allergy"},
        {t:"æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§",c:"å«æ•‘è­·è»Š",e:"Call Ambulance"}, {t:"è–¬å±€ã¯ã©ã“",c:"è—¥å±€åœ¨å“ª",e:"Pharmacy?"}
    ];
    const kidsItems = [
        {t:"ãã‚‡ã†ã‚Šã‚…ã†",c:"æé¾",i:"ğŸ¦–"}, {t:"ãã†",c:"å¤§è±¡",i:"ğŸ˜"},
        {t:"ã‚¢ã‚¤ã‚¹",c:"å†°æ·‡æ·‹",i:"ğŸ¦"}, {t:"ãƒã‚¹",c:"å…¬è»Š",i:"ğŸšŒ"},
        {t:"ã²ã“ã†ã",c:"é£›æ©Ÿ",i:"âœˆï¸"}, {t:"ãƒãƒŠãƒŠ",c:"é¦™è•‰",i:"ğŸŒ"}
    ];
    const kanaData = {
        hira: ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“","ã•","ã—","ã™","ã›","ã","ãŸ","ã¡","ã¤","ã¦","ã¨","ãª","ã«","ã¬","ã­","ã®","ã¯","ã²","ãµ","ã¸","ã»","ã¾","ã¿","ã‚€","ã‚","ã‚‚","ã‚„","","ã‚†","","ã‚ˆ","ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚","ã‚","","","","ã‚’","ã‚“"],
        kata: ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª","ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³","ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½","ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ","ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ","ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›","ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢","ãƒ¤","","ãƒ¦","","ãƒ¨","ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­","ãƒ¯","","","","ãƒ²","ãƒ³"],
        romaji: ["a","i","u","e","o","ka","ki","ku","ke","ko","sa","shi","su","se","so","ta","chi","tsu","te","to","na","ni","nu","ne","no","ha","hi","fu","he","ho","ma","mi","mu","me","mo","ya","","yu","","yo","ra","ri","ru","re","ro","wa","","","","wo","n"]
    };

    init();

    function init() {
        document.getElementById('sensei-msg').innerText = ["åŠ æ²¹ï¼ğŸ’ª","æ¯å¤©5åˆ†é˜ï¼â°","å¥å¥ç­‰ä½ å¸¶ä»–ç©ï¼ğŸ‘¶","æ²–ç¹©æˆ‘ä¾†äº†ï¼ğŸŒº"][Math.floor(Math.random()*4)];
        renderPlan(); renderChatCourse(); filterDict('all', null); loadMaskState(); updateAllStats();
        
        document.getElementById('medical-grid').innerHTML = medicalItems.map(i => 
            `<div class="med-btn" onclick="speak('${i.t}')"><span style="font-size:24px">ğŸ†˜</span><div class="med-label" style="font-size:16px;color:#FF453A;font-weight:bold;margin:5px 0;">${i.c}</div><div class="med-en">${i.e}</div></div>`
        ).join('');
        document.getElementById('kids-grid').innerHTML = kidsItems.map(i => 
            `<div class="kid-card" onclick="speak('${i.t}')"><div style="font-size:50px;">${i.i}</div><div style="font-size:20px;font-weight:900;">${i.c}</div></div>`
        ).join('');
        renderKana('hira');
    }

    // èªé€Ÿåˆ‡æ›
    function toggleSpeed() {
        const btn = document.getElementById('speed-toggle');
        if (speechRate === 1.0) {
            speechRate = 0.5; 
            btn.innerText = "ğŸ¢ æ…¢é€Ÿ (0.5x)";
            showToast("å·²åˆ‡æ›ç‚ºæ…¢é€Ÿ");
        } else {
            speechRate = 1.0; 
            btn.innerText = "ğŸ‡ æ­£å¸¸ (1.0x)";
            showToast("å·²åˆ‡æ›ç‚ºæ­£å¸¸èªé€Ÿ");
        }
    }

    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        
        if(['medical','kana','kids','review'].includes(name)) {
            document.getElementById('view-'+name).classList.add('active');
            document.getElementById('nav-tools').classList.add('active');
        } else {
            document.getElementById('view-'+name).classList.add('active');
            if(btn) btn.classList.add('active');
        }

        const isDict = name === 'dict';
        document.getElementById('tabs-bar').style.display = isDict ? 'block' : 'none';
        document.getElementById('search-bar-container').style.display = isDict ? 'block' : 'none';
        
        stopAllAutoPlay();
        if(name==='quiz') nextQuiz();
        if(name==='review') initReview();
        
        // å¦‚æœåˆ‡åˆ°å­—å…¸ï¼Œå¼·åˆ¶åˆ·æ–°
        if(isDict && currentCat === 'mistake') filterDict('mistake', document.querySelector('.tab-btn[onclick*="mistake"]'));
        
        window.scrollTo(0,0);
    }
    function openTool(name) { switchView(name); }

    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        const maskClass = isMasked ? 'masked' : '';
        box.innerHTML = weeks.map((w, idx) => {
            const idsStr = w.ids.join(',');
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `
                <div class="card ${maskClass}" id="card-${id}" onclick="speak('${p.jp}')">
                    <div class="card-top">
                        <div style="flex:1">
                            <div class="jp-big">${p.jp} ğŸ”Š</div>
                            <span class="romaji">${p.romaji}</span>
                            <div class="cn">${p.cn}</div>
                            <div class="en">${p.en}</div>
                        </div>
                        <div class="card-actions">
                            <div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div>
                            <div class="check-box ${chk}" onclick="event.stopPropagation(); toggleCheck('${id}', this)">âœ“</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            return `<div class="week-header"><div class="week-title-row"><h3 class="week-title">${w.t}</h3><div class="week-actions"><div class="action-btn autoplay-btn" onclick="toggleAutoPlay(this, '${idsStr}')">â–¶ Play</div><div class="action-btn reset-btn" onclick="resetWeek(${idx})">â†º</div></div></div></div>${lessons}`;
        }).join('');
    }

    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        if (saved.includes(id)) { saved = saved.filter(x => x !== id); el.classList.remove('checked'); } else { saved.push(id); el.classList.add('checked'); }
        localStorage.setItem('jp_v30_prog', JSON.stringify(saved));
        updateAllStats();
    }

    function resetWeek(idx) {
        if(!confirm("é‡ç½®æœ¬é€±é€²åº¦ï¼Ÿ")) return;
        let saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        const weekIds = weeks[idx].ids;
        saved = saved.filter(id => !weekIds.includes(id));
        localStorage.setItem('jp_v30_prog', JSON.stringify(saved));
        renderPlan(); updateAllStats();
    }

    function resetAllProgress() {
        if(!confirm("æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼Ÿ")) return;
        localStorage.clear();
        location.reload();
    }

    function updateAllStats() {
        const saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        const total = weeks.reduce((a,b)=>a+b.ids.length,0);
        const pct = Math.round(saved.length/total*100);
        document.getElementById('vocab-prog-text').innerText = pct+'%';
        document.getElementById('vocab-prog-fill').style.width = pct+'%';
        
        if(pct >= 25) document.getElementById('badge-25').classList.add('unlocked');
        if(pct >= 50) document.getElementById('badge-50').classList.add('unlocked');
        if(pct >= 75) document.getElementById('badge-75').classList.add('unlocked');
        if(pct >= 100) document.getElementById('badge-100').classList.add('unlocked');

        const cSaved = JSON.parse(localStorage.getItem('jp_v30_chat')||'[]');
        const cTotal = chatCourse.length;
        const cPct = Math.round(cSaved.length/cTotal*100);
        document.getElementById('chat-prog-text').innerText = cPct+'%';
        document.getElementById('chat-prog-fill').style.width = cPct+'%';
    }

    function filterDict(cat, btn) {
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('search-input').value = '';
        let data = phrases;
        currentCat = cat;
        
        if (cat === 'fav') { const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]'); data = phrases.filter(p => favs.includes(p.id)); }
        else if (cat === 'mistake') { const errs = JSON.parse(localStorage.getItem('jp_mistakes')||'[]'); data = phrases.filter(p => errs.includes(p.id)); }
        else if (cat !== 'all') { data = phrases.filter(p => p.cat === cat); }
        renderDictRaw(data);
    }

    function renderDictRaw(data) {
        const box = document.getElementById('dict-container');
        const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (data.length === 0) { box.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ç„¡çµæœ</div>'; return; }
        box.innerHTML = data.map(p => {
            const isFav = favs.includes(p.id) ? 'fav' : '';
            let actionBtn = `<div class="star-btn ${isFav}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">â˜…</div>`;
            if (currentCat === 'mistake') actionBtn = `<div class="trash-btn" onclick="event.stopPropagation(); removeMistake('${p.id}', this)">ğŸ—‘ï¸</div>`;
            return `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div><div class="en">${p.en}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div>${actionBtn}</div></div></div>`;
        }).join('');
    }

    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        let isAdd = false;
        if (favs.includes(id)) { favs = favs.filter(x => x !== id); el.classList.remove('fav'); } else { favs.push(id); el.classList.add('fav'); isAdd = true; }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
        showToast(isAdd ? "å·²æ”¶è— â­" : "å–æ¶ˆæ”¶è—");
        if(currentCat === 'fav') filterDict('fav', null);
    }

    function removeMistake(id, el) {
        let errs = JSON.parse(localStorage.getItem('jp_mistakes')||'[]');
        errs = errs.filter(x => x !== id);
        localStorage.setItem('jp_mistakes', JSON.stringify(errs));
        filterDict('mistake', null);
        showToast("å·²å¾å¼±é»ç§»é™¤");
    }

    function handleSearch() {
        const key = document.getElementById('search-input').value.toLowerCase();
        renderDictRaw(phrases.filter(p => p.jp.includes(key) || p.romaji.toLowerCase().includes(key) || p.cn.includes(key) || p.en.toLowerCase().includes(key)));
    }

    function renderDialogues() {
        document.getElementById('dialogue-container').innerHTML = chatCourse.map(course => {
            const mastered = JSON.parse(localStorage.getItem('jp_v30_chat')||'[]');
            const isMastered = mastered.includes(course.id);
            const masterClass = isMastered ? 'mastered' : '';
            const masterText = isMastered ? 'âœ… å·²å­¸æœƒ' : 'â­•ï¸ æˆ‘å­¸æœƒäº†';
            const chatRows = course.msgs.map(m => {
                const rowClass = m.r === 'user' ? 'user-row' : 'staff-row';
                const avatar = m.r === 'user' ? 'ğŸ§‘â€ğŸ¼' : 'ğŸ‘©â€ğŸ’¼';
                return `<div class="chat-row ${rowClass}"><div class="avatar">${avatar}</div><div class="chat-bubble" onclick="speak('${m.t}')"><span class="bubble-jp">${m.t} ğŸ”Š</span><span class="bubble-meta">${m.c}<br>${m.e}</span></div></div>`;
            }).join('');
            return `<div class="chat-course-card"><div class="chat-course-header" onclick="this.nextElementSibling.classList.toggle('open')"><div class="chat-course-title"><span style="font-size:20px;">${course.icon}</span> ${course.title}</div><div class="chat-toggle-icon">â–¼</div></div><div class="chat-course-body">${chatRows}<div class="chat-footer"><div class="master-btn ${masterClass}" onclick="toggleChatMaster('${course.id}', this)">${masterText}</div></div></div></div>`;
        }).join('');
    }

    function toggleChatMaster(id, btn) {
        let mastered = JSON.parse(localStorage.getItem('jp_v30_chat')||'[]');
        if (mastered.includes(id)) { mastered = mastered.filter(x => x !== id); btn.classList.remove('mastered'); btn.innerText = 'â­•ï¸ æˆ‘å­¸æœƒäº†'; } else { mastered.push(id); btn.classList.add('mastered'); btn.innerText = 'âœ… å·²å­¸æœƒ'; }
        localStorage.setItem('jp_v30_chat', JSON.stringify(mastered)); updateAllStats();
    }

    function openFullscreen(jp, cn, en) { event.stopPropagation(); document.getElementById('fs-jp').innerText = jp; document.getElementById('fs-cn').innerText = cn; document.getElementById('fs-en').innerText = en; document.getElementById('fullscreen-overlay').style.display = 'flex'; }
    function closeFullscreen() { document.getElementById('fullscreen-overlay').style.display = 'none'; }
    function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500); }

    // Quiz
    function setQuizType(type) {
        quizType = type;
        document.querySelectorAll('.q-type-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('q-type-'+type).classList.add('active');
        document.getElementById('quiz-title').innerText = type==='word'?"ğŸ‘‚ è½éŸ³è¾¨ç¾©":"ğŸ‘€ äº”åéŸ³èªå­—";
        document.getElementById('quiz-speaker').style.display='flex';
        document.getElementById('quiz-txt-display').style.display=type==='word'?'none':'block';
        document.getElementById('quiz-options').innerHTML = ''; document.getElementById('quiz-feedback').innerText = '';
        nextQuiz();
    }
    function nextQuiz() {
        document.getElementById('quiz-feedback').innerText = '';
        const container = document.getElementById('quiz-options'); container.innerHTML = '';
        if (quizType === 'word') {
            const target = phrases[Math.floor(Math.random() * phrases.length)]; currentQuiz = target;
            let options = [target];
            while(options.length < 4) { const w = phrases[Math.floor(Math.random()*phrases.length)]; if(!options.includes(w)) options.push(w); }
            options.sort(() => Math.random() - 0.5);
            options.forEach(opt => {
                const btn = document.createElement('div'); btn.className = 'quiz-btn'; btn.innerText = opt.cn;
                btn.onclick = () => checkAnswer(opt, btn, 'word'); container.appendChild(btn);
            });
            setTimeout(() => speak(target.jp), 300);
        } else {
            const type = Math.random() > 0.5 ? 'hira' : 'kata';
            const idx = Math.floor(Math.random() * 46);
            const char = kanaData[type][idx]; const ans = kanaData.romaji[idx];
            if (!char) { nextQuiz(); return; }
            currentQuiz = { jp: char, ans: ans, type: 'kana' };
            document.getElementById('quiz-txt-display').innerText = ans; // æ˜¾ç¤ºç½—é¦¬æ‹¼éŸ³
            document.getElementById('quiz-txt-display').style.color = "#FFD60A";
            let options = [char];
            while(options.length < 4) {
                const rIdx = Math.floor(Math.random()*46);
                const rChar = kanaData[type][rIdx];
                if(rChar && !options.includes(rChar) && rChar !== "") options.push(rChar);
            }
            options.sort(() => Math.random() - 0.5);
            options.forEach(opt => {
                const btn = document.createElement('div'); btn.className = 'quiz-btn'; btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn, 'kana'); container.appendChild(btn);
            });
            setTimeout(() => speak(currentQuiz.jp), 300); // å‘éŸ³
        }
    }
    function playQuizAudio() { if(currentQuiz) speak(currentQuiz.jp); } 
    function checkAnswer(sel, btn, type) {
        const isCorrect = (type === 'word' && sel.id === currentQuiz.id) || (type === 'kana' && sel === currentQuiz.jp);
        if(isCorrect) {
            btn.classList.add('correct'); document.getElementById('quiz-feedback').innerText = "â­•ï¸ æ­£ç¢ºï¼"; speak("æ­£è§£", null); setTimeout(nextQuiz, 1500);
        } else {
            btn.classList.add('wrong'); document.getElementById('quiz-feedback').innerText = "âŒ ç­”éŒ¯";
            if(type==='word') {
                document.getElementById('quiz-feedback').innerText = "âŒ å·²åŠ å…¥å¼±é»";
                let m=JSON.parse(localStorage.getItem('jp_mistakes')||'[]'); if(!m.includes(currentQuiz.id)) { m.push(currentQuiz.id); localStorage.setItem('jp_mistakes',JSON.stringify(m)); }
            }
        }
    }

    function toggleAutoPlay(btn, idsStr) {
        const ids = idsStr.split(',');
        if (isPlaying) { stopAllAutoPlay(); return; }
        isPlaying = true; btn.classList.add('playing'); btn.innerHTML = 'â¹ Stop';
        let index = 0;
        function playNext() {
            if (!isPlaying || index >= ids.length) { index = 0; }
            const id = ids[index];
            const p = phrases.find(x => x.id === id);
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
            const card = document.getElementById('card-'+id);
            if(card) card.classList.add('active-playing');
            speak(p.jp, () => { setTimeout(() => { speak(p.cn, () => { setTimeout(() => { index++; playNext(); }, 1500); }, 'zh-TW'); }, 800); });
        }
        playNext();
    }
    function stopAllAutoPlay() { isPlaying = false; window.speechSynthesis.cancel(); document.querySelectorAll('.autoplay-btn').forEach(b => { b.classList.remove('playing'); b.innerHTML = 'â–¶ Play'; }); document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing')); }

    function toggleMask() { isMasked = !isMasked; document.getElementById('mask-switch').classList.toggle('on'); renderPlan(); }
    function loadMaskState() { isMasked = false; }
    function renderKana(t) { const g=document.getElementById('kana-grid'); g.innerHTML=kanaData[t].map(c=>c?`<div class="kana-cell" onclick="speak('${c}')"><div style="font-size:20px;font-weight:bold;color:white;">${c}</div></div>`:`<div></div>`).join(''); }

    function speak(txt, onEnd=null, lang='ja-JP') {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = lang;
        u.rate = speechRate;
        if (onEnd) u.onend = onEnd;
        window.speechSynthesis.speak(u);
    }
    
    // Init Review
    function initReview() {
        const saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        if (saved.length === 0) { document.getElementById('review-area').style.display = 'none'; document.getElementById('empty-review').style.display = 'block'; }
        else { document.getElementById('review-area').style.display = 'block'; document.getElementById('empty-review').style.display = 'none'; nextCard(); }
    }
    function nextCard() {
        const saved = JSON.parse(localStorage.getItem('jp_v30_prog')||'[]');
        if(saved.length === 0) return;
        const randId = saved[Math.floor(Math.random() * saved.length)];
        currentReviewCard = phrases.find(p => p.id === randId);
        document.getElementById('flashcard').classList.remove('flipped');
        setTimeout(() => { document.getElementById('fc-jp').innerText = currentReviewCard.jp; document.getElementById('fc-romaji').innerText = currentReviewCard.romaji; document.getElementById('fc-cn').innerText = currentReviewCard.cn; }, 200);
    }
    function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); if(document.getElementById('flashcard').classList.contains('flipped')) setTimeout(() => speak(currentReviewCard.jp), 300); }
    function speakCurrentCard() { if(currentReviewCard) speak(currentReviewCard.jp); }
</script>
</body>
</html>
