<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JapaneseGO V21.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --accent-color: #0A84FF;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-romaji: #FFD60A;
            --text-en: #30D158;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: calc(90px + var(--safe-bottom));
        }

        /* é ‚éƒ¨å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding-top: var(--safe-top);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        h1 { margin: 0; font-size: 20px; font-weight: 800; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .speed-btn { background: #333; border: 1px solid #555; color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .speed-btn:active { transform: scale(0.95); background: #444; }

        /* æœå°‹ & åˆ†é¡ */
        .search-box { margin: 0 15px 10px 15px; position: relative; display: none; }
        .search-input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 10px 10px 10px 35px; color: #fff; font-size: 16px; }
        .search-icon { position: absolute; left: 10px; top: 10px; color: #888; }
        .tabs-container { width: 100%; overflow-x: auto; padding: 0 15px 10px 15px; white-space: nowrap; display: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; appearance: none; background: #333; color: #ccc; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        /* å…§å®¹å€ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ */
        .card { background: #1c1c1e; border: 1px solid #333; border-radius: 18px; padding: 18px; margin-bottom: 14px; position: relative; transition: 0.2s; }
        .card.active-playing { border-color: #0A84FF; background: #15202b; transform: scale(1.02); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .jp-big { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; line-height: 1.3; }
        .romaji { font-family: monospace; color: var(--text-romaji); font-size: 13px; margin-bottom: 8px; display: block; }
        .cn { font-size: 16px; color: #ddd; display: block; margin-bottom: 2px; }
        .en { font-size: 13px; color: var(--text-en); font-weight: 500; }
        .masked .romaji, .masked .cn, .masked .en { opacity: 0; filter: blur(6px); }
        .masked:active .romaji, .masked:active .cn, .masked:active .en { opacity: 1; filter: none; }
        .card-actions { display: flex; gap: 15px; align-items: center; margin-left: 10px; flex-shrink: 0; }
        .check-box { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; }
        .check-box.checked { background: #30D158; border-color: #30D158; color: white; }
        .star-btn { font-size: 26px; color: #444; padding: 5px; cursor: pointer; }
        .star-btn.fav { color: #FFD60A; }
        .show-btn { font-size: 22px; color: #666; cursor: pointer; }

        /* ç‰¹è¨“é€±æ¬¡ & æˆå°± */
        .week-header { margin: 30px 0 15px 0; }
        .week-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .week-title { color: #0A84FF; font-size: 18px; font-weight: 800; margin: 0; }
        .week-actions { display: flex; gap: 8px; }
        .action-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .autoplay-btn.playing { background: #0A84FF; color: white; border-color: #0A84FF; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* æˆå°±å¾½ç« å€ (NEW) */
        .badges-container { display: flex; justify-content: space-between; background: #222; padding: 15px; border-radius: 16px; margin-top: 30px; border: 1px solid #333; }
        .badge-item { text-align: center; opacity: 0.3; filter: grayscale(100%); transition: 0.5s; }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
        .badge-icon { font-size: 32px; margin-bottom: 5px; display: block; }
        .badge-text { font-size: 10px; color: #aaa; }

        /* æ¸¬é©—æ¨¡å¼ (æ™ºæ…§éŒ¯é¡Œ) */
        .quiz-container { text-align: center; margin-top: 20px; }
        .quiz-speaker { width: 120px; height: 120px; background: #222; border-radius: 50%; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center; font-size: 50px; border: 2px solid #0A84FF; cursor: pointer; box-shadow: 0 0 20px rgba(10, 132, 255, 0.2); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(10,132,255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(10,132,255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10,132,255, 0); } }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .quiz-btn { background: #2c2c2e; color: #fff; padding: 15px; border-radius: 12px; border: 1px solid #444; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .quiz-btn.correct { background: #30D158; border-color: #30D158; }
        .quiz-btn.wrong { background: #FF453A; border-color: #FF453A; }
        .quiz-type-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .q-type-btn { padding: 5px 15px; border-radius: 15px; border: 1px solid #555; background: #222; color: #888; font-size: 13px; cursor: pointer; }
        .q-type-btn.active { background: #0A84FF; color: white; border-color: #0A84FF; }

        /* å…¨è¢å¹• & Toast */
        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        #fs-jp { font-size: 40px; font-weight: 900; color: #fff; margin-bottom: 20px; line-height: 1.3; word-break: break-all; }
        #fs-cn { font-size: 24px; color: #888; font-weight: 500; margin-bottom: 10px; }
        #fs-en { font-size: 18px; color: var(--text-en); }
        #fs-close { position: absolute; top: 50px; right: 30px; font-size: 30px; color: #666; border: 1px solid #333; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(30,30,30,0.95); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 9999; border: 1px solid #555; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* å…¶ä»–é€šç”¨ */
        .toolbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .tool-card { background: #1c1c1e; border: 1px solid #333; border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; height: 130px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .medical-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .med-btn { background: #2c1a1a; border: 1px solid #5a2a2a; border-radius: 16px; padding: 15px; text-align: center; cursor: pointer; }
        .kids-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .kid-card { background: #fff; border-radius: 20px; padding: 15px; text-align: center; color: #333; cursor: pointer; }
        .kana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .kana-cell { background: #222; border-radius: 8px; padding: 10px 0; text-align: center; cursor: pointer; border: 1px solid #333; }
        .dialogue-card { background: #151515; border: 1px solid #333; border-radius: 16px; margin-bottom: 20px; overflow: hidden; }
        .chat-row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 10px; }
        .chat-row.user-row { flex-direction: row-reverse; }
        .chat-bubble { max-width: 80%; padding: 12px; border-radius: 18px; font-size: 15px; line-height: 1.4; cursor: pointer; position: relative; }
        .chat-row.staff-row .chat-bubble { background: #2c2c2e; color: #eee; border-bottom-left-radius: 4px; }
        .chat-row.user-row .chat-bubble { background: #0A84FF; color: #fff; border-bottom-right-radius: 4px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(15,15,15,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding-top: 10px; z-index: 2000; padding-bottom: var(--safe-bottom); }
        .nav-btn { text-align: center; color: #666; font-size: 10px; width: 20%; cursor: pointer; }
        .nav-btn.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        .sensei-box { background: linear-gradient(135deg, #1a2a3a 0%, #1c1c1e 100%); border: 1px solid #333; border-radius: 16px; padding: 15px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        .mask-toggle-area { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .toggle-switch { position: relative; width: 50px; height: 30px; background: #444; border-radius: 15px; transition: 0.3s; }
        .toggle-switch.on { background: #30D158; }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on .toggle-knob { transform: translateX(20px); }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Smart V21.0</span></h1>
        <button id="speed-toggle" class="speed-btn" onclick="toggleSpeed()">ğŸ¢ æ…¢é€Ÿ (0.5x)</button>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹/Search..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="filterDict('mistake', this)" style="color:#FF453A; border-color:#FF453A;">ğŸ’€ å¼±é»</button> <button class="tab-btn" onclick="filterDict('short', this)">ğŸ—£ï¸ çŸ­å¥</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ æ”¶è—</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">ç”Ÿå­˜</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">ç¾é£Ÿ</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">è³¼ç‰©</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">è¦ªå­</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">è—¥å¦</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">äº¤é€š</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">ä½å®¿</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">æ©Ÿå ´</button>
        <button class="tab-btn" onclick="filterDict('okinawa', this)" style="color:#FF2D55;">ğŸŒº æ²–ç¹©</button>
    </div>
</div>

<div id="toast">å·²æ”¶è— â­</div>

<div id="fullscreen-overlay" onclick="closeFullscreen()">
    <div id="fs-close">âœ•</div>
    <div id="fs-jp">JP</div>
    <div id="fs-cn">CN</div>
    <div id="fs-en">EN</div>
    <div style="margin-top:30px; font-size:12px; color:#555;">(Tap to close)</div>
</div>

<div id="view-learn" class="view active">
    <div class="sensei-box">
        <div style="font-size:40px;">ğŸ¦</div>
        <div style="flex:1;">
            <div style="font-size:13px; color:#0A84FF; font-weight:bold; margin-bottom:4px;">æ•™ç·´å®åš€</div>
            <div id="sensei-msg" style="font-size:15px; color:#fff;">...</div>
        </div>
    </div>
    
    <div class="mask-toggle-area" onclick="toggleMask()">
        <div>
            <div style="font-weight:bold; color:#fff;">ğŸ«£ è¨˜æ†¶é®æ“‹ (Mask Mode)</div>
            <div style="font-size:12px; color:#888;">Hide translation / éš±è—ç¿»è­¯</div>
        </div>
        <div id="mask-switch" class="toggle-switch"><div class="toggle-knob"></div></div>
    </div>

    <div class="week-block" style="color:#888; text-align:center; font-size:13px; margin-bottom:10px;">
        Progress: <span id="progress-text">0%</span>
        <div style="margin-top:15px; font-size:12px; color:#555; text-decoration:underline; cursor:pointer;" onclick="resetAllProgress()">[Reset All Data]</div>
    </div>

    <div class="badges-container">
        <div id="badge-25" class="badge-item">
            <span class="badge-icon">ğŸŒº</span><div class="badge-text">æ–°æ‰‹</div>
        </div>
        <div id="badge-50" class="badge-item">
            <span class="badge-icon">ğŸ¦</span><div class="badge-text">ç†Ÿç·´</div>
        </div>
        <div id="badge-75" class="badge-item">
            <span class="badge-icon">ğŸ‹</span><div class="badge-text">é”äºº</div>
        </div>
        <div id="badge-100" class="badge-item">
            <span class="badge-icon">ğŸ°</span><div class="badge-text">æ²–ç¹©é€š</div>
        </div>
    </div>

    <div id="curriculum-container" style="margin-top:20px;"></div>
</div>

<div id="view-quiz" class="view">
    <div class="quiz-type-selector">
        <div class="q-type-btn active" id="q-type-word" onclick="setQuizType('word')">å–®å­—æ¸¬é©—</div>
        <div class="q-type-btn" id="q-type-kana" onclick="setQuizType('kana')">äº”åéŸ³æ¸¬é©—</div>
    </div>

    <div style="text-align:center; margin-top:10px; margin-bottom:20px;">
        <h2 id="quiz-title">ğŸ‘‚ è½éŸ³è¾¨ç¾©</h2>
        <div style="color:#888; font-size:13px;">éŒ¯é¡Œæœƒè‡ªå‹•åŠ å…¥ã€Œå¼±é»ã€å­—å…¸</div>
    </div>
    <div class="quiz-container">
        <div class="quiz-speaker" onclick="playQuizAudio()">ğŸ”Š</div>
        <div id="quiz-txt-display" style="font-size:40px; font-weight:bold; margin-bottom:20px; display:none;">?</div> <div id="quiz-options" class="quiz-options"></div>
        <div id="quiz-feedback" style="margin-top:20px; font-size:18px; font-weight:bold; height:30px;"></div>
        <button style="margin-top:20px; background:#444; color:white; padding:10px 20px; border-radius:20px; border:none; font-size:14px; cursor:pointer;" onclick="nextQuiz()">Skip / Next</button>
    </div>
</div>

<div id="view-dialogue" class="view">
    <div id="dialogue-container"></div>
</div>

<div id="view-dict" class="view">
    <div id="dict-container"></div>
</div>

<div id="view-tools" class="view">
    <div class="toolbox-grid">
        <div class="tool-card" onclick="openTool('medical')"><div style="font-size:40px;">ğŸ¥</div><div style="font-weight:bold;margin-top:10px;">Medical</div><div style="font-size:12px;color:#888;">æ€¥æ•‘æŒ‡æŒ‡é€š</div></div>
        <div class="tool-card" onclick="openTool('kana')"><div style="font-size:40px;">ğŸ”¤</div><div style="font-weight:bold;margin-top:10px;">Kana Table</div><div style="font-size:12px;color:#888;">äº”åéŸ³è¡¨</div></div>
        <div class="tool-card" onclick="openTool('kids')"><div style="font-size:40px;">ğŸ‘¶</div><div style="font-weight:bold;margin-top:10px;">Kids Mode</div><div style="font-size:12px;color:#888;">å¥å¥å°ˆå€</div></div>
    </div>
</div>

<div id="view-medical" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div class="medical-grid" id="medical-grid"></div>
</div>
<div id="view-kana" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
        <button class="tab-btn active" onclick="renderKana('hira')">å¹³å‡å</button>
        <button class="tab-btn" onclick="renderKana('kata')">ç‰‡å‡å</button>
    </div>
    <div id="kana-grid" class="kana-grid"></div>
</div>
<div id="view-kids" class="view" style="background:#f0f8ff; min-height:100vh;">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF; font-weight:bold;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div class="kids-grid" id="kids-grid"></div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)"><span class="nav-icon">ğŸ“…</span>ç‰¹è¨“</div>
    <div class="nav-btn" onclick="switchView('quiz', this)"><span class="nav-icon">ğŸ®</span>æ¸¬é©—</div>
    <div class="nav-btn" onclick="switchView('dialogue', this)"><span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±</div>
    <div class="nav-btn" onclick="switchView('dict', this)"><span class="nav-icon">ğŸ“–</span>å­—å…¸</div>
    <div class="nav-btn" id="nav-tools" onclick="switchView('tools', this)"><span class="nav-icon">ğŸ§°</span>ç™¾å¯¶ç®±</div>
</div>

<script>
    // --- å®Œæ•´è³‡æ–™åº« (è«‹å¡«å…¥ V18.0 çš„å®Œæ•´ 200+ å¥ï¼Œæ­¤è™•ç‚ºç¯„ä¾‹) ---
    const phrases = [
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€", en: "Excuse me" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "A-ri-ga-tou", cn: "è¬è¬", en: "Thank you" },
        // ... (å‹™å¿…è£œä¸Šæ‰€æœ‰è³‡æ–™) ...
        { id: "x1", cat: "short", jp: "ãªã‚‹ã»ã©", romaji: "Na-ru-ho-do", cn: "åŸä¾†å¦‚æ­¤", en: "I see" }
    ];

    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2"] }
        // ... (å‹™å¿…è£œä¸Šæ‰€æœ‰é€±æ¬¡) ...
    ];

    const dialogues = [
        { title: "ğŸ¨ é£¯åº— Check-in", msgs: [{r:"user",t:"ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³",c:"Check-in",e:"Check-in"}] }
        // ... (å‹™å¿…è£œä¸Šæ‰€æœ‰æœƒè©±) ...
    ];

    // --- ç¨‹å¼è®Šæ•¸ ---
    let currentCat = 'all';
    let isMasked = false;
    let isPlaying = false;
    let speechRate = 1.0;
    let currentQuiz = null;
    let quizType = 'word'; // 'word' or 'kana'

    const medicalItems = [{t:"ç†±ãŒã‚ã‚Šã¾ã™",c:"ç™¼ç‡’",e:"Fever"}, {t:"è–¬å±€ã¯ã©ã“",c:"è—¥å±€åœ¨å“ª",e:"Pharmacy?"}]; // ... è£œå…¨
    const kidsItems = [{t:"ãã‚‡ã†ã‚Šã‚…ã†",c:"æé¾",i:"ğŸ¦–"}, {t:"ã‚¢ã‚¤ã‚¹",c:"å†°æ·‡æ·‹",i:"ğŸ¦"}]; // ... è£œå…¨
    const kanaData = {
        hira: ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“","ã•","ã—","ã™","ã›","ã","ãŸ","ã¡","ã¤","ã¦","ã¨","ãª","ã«","ã¬","ã­","ã®","ã¯","ã²","ãµ","ã¸","ã»","ã¾","ã¿","ã‚€","ã‚","ã‚‚","ã‚„","","ã‚†","","ã‚ˆ","ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚","ã‚","","","","ã‚’","ã‚“"],
        kata: ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª","ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³","ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½","ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ","ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ","ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›","ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢","ãƒ¤","","ãƒ¦","","ãƒ¨","ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­","ãƒ¯","","","","ãƒ²","ãƒ³"],
        romaji: ["a","i","u","e","o","ka","ki","ku","ke","ko","sa","shi","su","se","so","ta","chi","tsu","te","to","na","ni","nu","ne","no","ha","hi","fu","he","ho","ma","mi","mu","me","mo","ya","","yu","","yo","ra","ri","ru","re","ro","wa","","","","wo","n"]
    };

    init();

    function init() {
        document.getElementById('sensei-msg').innerText = "ç›®æ¨™æ˜¯æ²–ç¹©é€šï¼åŠ æ²¹ï¼";
        renderPlan(); renderDialogues(); filterDict('all', null); loadMaskState(); updateAllStats();
        
        // Render Tools (ç•¥å¾®ç°¡åŒ–ï¼Œè«‹ç¢ºä¿è³‡æ–™å®Œæ•´æ™‚å–æ¶ˆè¨»è§£æˆ–è£œé½Š)
        document.getElementById('medical-grid').innerHTML = medicalItems.map(i => `<div class="med-btn" onclick="speak('${i.t}')"><span style="font-size:24px">ğŸ†˜</span><div class="med-label" style="font-size:16px;color:#FF453A;font-weight:bold;">${i.c}</div></div>`).join('');
        document.getElementById('kids-grid').innerHTML = kidsItems.map(i => `<div class="kid-card" onclick="speak('${i.t}')"><div class="kid-icon">${i.i}</div><div class="kid-label">${i.c}</div></div>`).join('');
        renderKana('hira');
    }

    // --- æ¸¬é©—ç³»çµ± (å‡ç´šç‰ˆ) ---
    function setQuizType(type) {
        quizType = type;
        document.querySelectorAll('.q-type-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('q-type-'+type).classList.add('active');
        document.getElementById('quiz-title').innerText = type === 'word' ? "ğŸ‘‚ è½éŸ³è¾¨ç¾©" : "ğŸ‘€ äº”åéŸ³èªå­—";
        document.getElementById('quiz-speaker').style.display = type === 'word' ? 'flex' : 'none';
        document.getElementById('quiz-txt-display').style.display = type === 'word' ? 'none' : 'block';
        nextQuiz();
    }

    function nextQuiz() {
        document.getElementById('quiz-feedback').innerText = '';
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';

        if (quizType === 'word') {
            const target = phrases[Math.floor(Math.random() * phrases.length)];
            currentQuiz = target;
            let options = [target];
            while(options.length < 4) { const w = phrases[Math.floor(Math.random()*phrases.length)]; if(!options.includes(w)) options.push(w); }
            options.sort(() => Math.random() - 0.5);
            options.forEach(opt => {
                const btn = document.createElement('div'); btn.className = 'quiz-btn'; btn.innerText = opt.cn;
                btn.onclick = () => checkAnswer(opt, btn, 'word');
                container.appendChild(btn);
            });
            setTimeout(() => speak(target.jp), 300);
        } else {
            // Kana Quiz
            const type = Math.random() > 0.5 ? 'hira' : 'kata';
            const idx = Math.floor(Math.random() * 46); // Basic chars
            const char = kanaData[type][idx];
            const ans = kanaData.romaji[idx];
            if (!char || char === "") { nextQuiz(); return; } // Skip empty
            
            currentQuiz = { jp: char, ans: ans, type: 'kana' };
            document.getElementById('quiz-txt-display').innerText = char;
            
            let options = [ans];
            while(options.length < 4) {
                const r = kanaData.romaji[Math.floor(Math.random()*46)];
                if(r && !options.includes(r) && r !== "") options.push(r);
            }
            options.sort(() => Math.random() - 0.5);
            
            options.forEach(opt => {
                const btn = document.createElement('div'); btn.className = 'quiz-btn'; btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn, 'kana');
                container.appendChild(btn);
            });
        }
    }

    function playQuizAudio() { if(quizType === 'word' && currentQuiz) speak(currentQuiz.jp); }

    function checkAnswer(selected, btn, type) {
        const isCorrect = (type === 'word' && selected.id === currentQuiz.id) || (type === 'kana' && selected === currentQuiz.ans);
        
        if(isCorrect) {
            btn.classList.add('correct');
            document.getElementById('quiz-feedback').innerText = "â­•ï¸ æ­£ç¢ºï¼";
            speak("æ­£è§£", null);
            setTimeout(nextQuiz, 1500);
        } else {
            btn.classList.add('wrong');
            document.getElementById('quiz-feedback').innerText = "âŒ å·²åŠ å…¥å¼±é»";
            
            // â­ï¸ æ™ºæ…§éŒ¯é¡Œé‚è¼¯
            if (type === 'word') {
                let mistakes = JSON.parse(localStorage.getItem('jp_mistakes')||'[]');
                if(!mistakes.includes(currentQuiz.id)) {
                    mistakes.push(currentQuiz.id);
                    localStorage.setItem('jp_mistakes', JSON.stringify(mistakes));
                    showToast("å·²åŠ å…¥å¼±é» ğŸ’€");
                }
            }
        }
    }

    // --- æˆå°±ç³»çµ± ---
    function updateAllStats() {
        const saved = JSON.parse(localStorage.getItem('jp_v21_prog')||'[]');
        const total = weeks.reduce((a,b)=>a+b.ids.length,0);
        const pct = Math.round(saved.length/total*100);
        document.getElementById('progress-text').innerText = pct+'%';
        
        // å¾½ç« è§£é–é‚è¼¯
        if(pct >= 25) document.getElementById('badge-25').classList.add('unlocked');
        if(pct >= 50) document.getElementById('badge-50').classList.add('unlocked');
        if(pct >= 75) document.getElementById('badge-75').classList.add('unlocked');
        if(pct >= 100) document.getElementById('badge-100').classList.add('unlocked');
    }

    // --- å­—å…¸éæ¿¾ (å«å¼±é») ---
    function filterDict(cat, btn) {
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('search-input').value = '';
        let data = phrases;
        
        if (cat === 'fav') { 
            const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]'); 
            data = phrases.filter(p => favs.includes(p.id)); 
        } else if (cat === 'mistake') { // NEW
            const errs = JSON.parse(localStorage.getItem('jp_mistakes')||'[]');
            data = phrases.filter(p => errs.includes(p.id));
        } else if (cat !== 'all') { 
            data = phrases.filter(p => p.cat === cat); 
        }
        renderDictRaw(data);
    }

    // (å…¶é¤˜åŸºæœ¬åŠŸèƒ½ï¼šåˆ‡æ›é é¢ã€æ¸²æŸ“åˆ—è¡¨ã€ç™¼éŸ³ã€å…¨è¢å¹•ç­‰ï¼Œè«‹è¤‡è£½ V18.0 çš„ä»£ç¢¼ä¸¦ä¿æŒä¸è®Š)
    // ç‚ºäº†ç¯€çœç©ºé–“ï¼Œè«‹ç¢ºä¿å°‡ V18.0 çš„ switchView, renderPlan, toggleCheck, speak, openFullscreen ç­‰å‡½æ•¸å®Œæ•´è²¼åœ¨æ­¤è™•ã€‚
    // è¨˜å¾—å°‡ localStorage key æ”¹ç‚º jp_v21_prog ä»¥é˜²è¡çªã€‚
    
    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        if(['medical','kana','kids'].includes(name)) {
            document.getElementById('view-'+name).classList.add('active');
            document.getElementById('nav-tools').classList.add('active');
        } else {
            document.getElementById('view-'+name).classList.add('active');
            if(btn) btn.classList.add('active');
        }
        const isDict = name === 'dict';
        document.getElementById('tabs-bar').style.display = isDict ? 'block' : 'none';
        document.getElementById('search-bar-container').style.display = isDict ? 'block' : 'none';
        if(name==='quiz') nextQuiz();
        window.scrollTo(0,0);
    }
    function renderDictRaw(data) {
        const box = document.getElementById('dict-container');
        const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (data.length === 0) { box.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ç„¡çµæœ</div>'; return; }
        box.innerHTML = data.map(p => {
            const isFav = favs.includes(p.id) ? 'fav' : '';
            return `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div><div class="en">${p.en}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div><div class="star-btn ${isFav}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">â˜…</div></div></div></div>`;
        }).join('');
    }
    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_v21_prog')||'[]'); // Key updated
        const maskClass = isMasked ? 'masked' : '';
        box.innerHTML = weeks.map((w, idx) => {
            const idsStr = w.ids.join(',');
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `<div class="card ${maskClass}" id="card-${id}" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div><div class="en">${p.en}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div><div class="check-box ${chk}" onclick="event.stopPropagation(); toggleCheck('${id}', this)">âœ“</div></div></div></div>`;
            }).join('');
            return `<div class="week-header"><div class="week-title-row"><h3 class="week-title">${w.t}</h3><div class="week-actions"><div class="action-btn autoplay-btn" onclick="toggleAutoPlay(this, '${idsStr}')">â–¶ Play</div><div class="action-btn reset-btn" onclick="resetWeek(${idx})">â†º</div></div></div></div>${lessons}`;
        }).join('');
    }
    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_v21_prog')||'[]');
        if (saved.includes(id)) { saved = saved.filter(x => x !== id); el.classList.remove('checked'); }
        else { saved.push(id); el.classList.add('checked'); }
        localStorage.setItem('jp_v21_prog', JSON.stringify(saved));
        updateAllStats();
    }
    function resetWeek(idx) {
        if(!confirm("é‡ç½®ï¼Ÿ")) return;
        let saved = JSON.parse(localStorage.getItem('jp_v21_prog')||'[]');
        const weekIds = weeks[idx].ids;
        saved = saved.filter(id => !weekIds.includes(id));
        localStorage.setItem('jp_v21_prog', JSON.stringify(saved));
        renderPlan(); updateAllStats();
    }
    function resetAllProgress() { if(confirm("æ¸…é™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (favs.includes(id)) { favs = favs.filter(x => x !== id); el.classList.remove('fav'); } else { favs.push(id); el.classList.add('fav'); }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
        showToast(favs.includes(id)?"å·²æ”¶è—":"å·²å–æ¶ˆ");
    }
    function openFullscreen(jp,cn,en) { event.stopPropagation(); document.getElementById('fs-jp').innerText=jp; document.getElementById('fs-cn').innerText=cn; document.getElementById('fs-en').innerText=en; document.getElementById('fullscreen-overlay').style.display='flex'; }
    function closeFullscreen() { document.getElementById('fullscreen-overlay').style.display='none'; }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
    function renderDialogues() { document.getElementById('dialogue-container').innerHTML = dialogues.map(d=>`<div class="dialogue-card"><div class="dialogue-header"><span>${d.title}</span></div><div class="dialogue-body">${d.msgs.map(m=>`<div class="chat-row ${m.r==='user'?'user-row':'staff-row'}"><div class="avatar">${m.r==='user'?'ğŸ§‘â€ğŸ¼':'ğŸ‘©â€ğŸ’¼'}</div><div class="chat-bubble" onclick="speak('${m.t}')"><span class="bubble-jp">${m.t} ğŸ”Š</span><span class="bubble-cn">${m.c}</span></div></div>`).join('')}</div></div>`).join(''); }
    function speak(txt, cb) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'ja-JP'; u.rate = speechRate; if(cb) u.onend=cb; window.speechSynthesis.speak(u); }
    function toggleSpeed() { speechRate = speechRate===1.0?0.5:1.0; document.getElementById('speed-toggle').innerText = speechRate===1.0?"ğŸ‡ æ­£å¸¸":"ğŸ¢ æ…¢é€Ÿ"; showToast("èªé€Ÿå·²åˆ‡æ›"); }
    function toggleMask() { isMasked=!isMasked; document.getElementById('mask-switch').classList.toggle('on'); renderPlan(); }
    function loadMaskState() { isMasked=false; }
    function handleSearch() { const key=document.getElementById('search-input').value.toLowerCase(); renderDictRaw(phrases.filter(p=>p.jp.includes(key)||p.romaji.toLowerCase().includes(key)||p.cn.includes(key))); }
    function renderKana(t) { const g=document.getElementById('kana-grid'); g.innerHTML=kanaData[t].map(c=>c?`<div class="kana-cell" onclick="speak('${c}')"><div style="font-size:20px;font-weight:bold;color:white;">${c}</div></div>`:`<div></div>`).join(''); }
    function toggleAutoPlay(btn, idsStr) {
        const ids = idsStr.split(',');
        if (isPlaying) { stopAllAutoPlay(); return; }
        isPlaying = true; btn.classList.add('playing'); btn.innerHTML = 'â¹ Stop';
        let index = 0;
        function playNext() {
            if (!isPlaying || index >= ids.length) { index = 0; }
            const id = ids[index];
            const p = phrases.find(x => x.id === id);
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
            const card = document.getElementById('card-'+id);
            if(card) card.classList.add('active-playing');
            speak(p.jp, () => { setTimeout(() => { speak(p.cn, () => { setTimeout(() => { index++; playNext(); }, 1500); }, 'zh-TW'); }, 800); });
        }
        playNext();
    }
    function stopAllAutoPlay() {
        isPlaying = false; window.speechSynthesis.cancel();
        document.querySelectorAll('.autoplay-btn').forEach(b => { b.classList.remove('playing'); b.innerHTML = 'â–¶ Play'; });
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
    }
</script>
</body>
</html>
