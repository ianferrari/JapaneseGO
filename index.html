<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JapaneseGO V18.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --accent-color: #0A84FF;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-romaji: #FFD60A;
            --text-en: #30D158; /* è‹±æ–‡ç”¨ç¶ è‰²å€éš” */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: calc(90px + var(--safe-bottom));
        }

        /* é ‚éƒ¨å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding-top: var(--safe-top);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        h1 { margin: 0; font-size: 20px; font-weight: 800; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* èªé€ŸæŒ‰éˆ• */
        .speed-btn {
            background: #333; border: 1px solid #555; color: #fff;
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;
            transition: 0.2s;
        }
        .speed-btn:active { transform: scale(0.95); background: #444; }

        /* æœå°‹ & åˆ†é¡ */
        .search-box { margin: 0 15px 10px 15px; position: relative; display: none; }
        .search-input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 10px 10px 10px 35px; color: #fff; font-size: 16px; }
        .search-icon { position: absolute; left: 10px; top: 10px; color: #888; }
        .tabs-container { width: 100%; overflow-x: auto; padding: 0 15px 10px 15px; white-space: nowrap; display: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; appearance: none; background: #333; color: #ccc; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        /* å…§å®¹å€ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ (æ”¯æ´4èª) */
        .card { background: #1c1c1e; border: 1px solid #333; border-radius: 18px; padding: 18px; margin-bottom: 14px; position: relative; transition: 0.2s; }
        .card.active-playing { border-color: #0A84FF; background: #15202b; transform: scale(1.02); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .jp-big { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; line-height: 1.3; }
        .romaji { font-family: monospace; color: var(--text-romaji); font-size: 13px; margin-bottom: 8px; display: block; }
        .cn { font-size: 16px; color: #ddd; display: block; margin-bottom: 2px; }
        .en { font-size: 13px; color: var(--text-en); font-weight: 500; } /* è‹±æ–‡æ¨£å¼ */
        
        .masked .romaji, .masked .cn, .masked .en { opacity: 0; filter: blur(6px); }
        .masked:active .romaji, .masked:active .cn, .masked:active .en { opacity: 1; filter: none; }
        
        .card-actions { display: flex; gap: 15px; align-items: center; margin-left: 10px; flex-shrink: 0; }
        .check-box { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; }
        .check-box.checked { background: #30D158; border-color: #30D158; color: white; }
        .star-btn { font-size: 26px; color: #444; padding: 5px; cursor: pointer; }
        .star-btn.fav { color: #FFD60A; }
        .show-btn { font-size: 22px; color: #666; cursor: pointer; }

        /* ç‰¹è¨“é€±æ¬¡ */
        .week-header { margin: 30px 0 15px 0; }
        .week-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .week-title { color: #0A84FF; font-size: 18px; font-weight: 800; margin: 0; }
        .week-actions { display: flex; gap: 8px; }
        .action-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .autoplay-btn.playing { background: #0A84FF; color: white; border-color: #0A84FF; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* æœƒè©± (4èªç‰ˆ) */
        .dialogue-card { background: #151515; border: 1px solid #333; border-radius: 16px; margin-bottom: 20px; overflow: hidden; }
        .dialogue-header { background: #222; padding: 10px 15px; font-weight: 700; color: #fff; border-bottom: 1px solid #333; }
        .dialogue-body { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .chat-row { display: flex; align-items: flex-end; gap: 10px; }
        .chat-row.user-row { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; border: 1px solid #444; }
        .chat-bubble { max-width: 80%; padding: 12px; border-radius: 18px; font-size: 15px; line-height: 1.4; cursor: pointer; position: relative; }
        .chat-row.staff-row .chat-bubble { background: #2c2c2e; color: #eee; border-bottom-left-radius: 4px; }
        .chat-row.user-row .chat-bubble { background: #0A84FF; color: #fff; border-bottom-right-radius: 4px; }
        .bubble-jp { font-weight: 700; margin-bottom: 4px; display: block; font-size: 17px; }
        .bubble-meta { font-size: 12px; opacity: 0.8; margin-top: 4px; display: block; }
        
        /* å…¨è¢å¹•è¦†è“‹ */
        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        #fs-jp { font-size: 40px; font-weight: 900; color: #fff; margin-bottom: 20px; line-height: 1.3; word-break: break-all; }
        #fs-cn { font-size: 24px; color: #888; font-weight: 500; margin-bottom: 10px; }
        #fs-en { font-size: 18px; color: var(--text-en); }
        #fs-close { position: absolute; top: 50px; right: 30px; font-size: 30px; color: #666; border: 1px solid #333; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* ç™¾å¯¶ç®±èˆ‡å…¶ä»– */
        .toolbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .tool-card { background: #1c1c1e; border: 1px solid #333; border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; height: 130px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .medical-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .med-btn { background: #2c1a1a; border: 1px solid #5a2a2a; border-radius: 16px; padding: 15px; text-align: center; cursor: pointer; }
        .med-en { font-size: 10px; color: #999; display: block; margin-top: 2px; }
        .kids-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .kid-card { background: #fff; border-radius: 20px; padding: 15px; text-align: center; color: #333; cursor: pointer; }
        .kid-icon { font-size: 50px; margin-bottom: 5px; }
        .kana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .kana-cell { background: #222; border-radius: 8px; padding: 10px 0; text-align: center; cursor: pointer; border: 1px solid #333; }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(15,15,15,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding-top: 10px; z-index: 2000; padding-bottom: var(--safe-bottom); }
        .nav-btn { text-align: center; color: #666; font-size: 10px; width: 20%; cursor: pointer; }
        .nav-btn.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        
        /* è¼”åŠ© */
        .mask-toggle-area { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .toggle-switch { position: relative; width: 50px; height: 30px; background: #444; border-radius: 15px; transition: 0.3s; }
        .toggle-switch.on { background: #30D158; }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on .toggle-knob { transform: translateX(20px); }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Full V18.0</span></h1>
        <button id="speed-toggle" class="speed-btn" onclick="toggleSpeed()">ğŸ¢ æ…¢é€Ÿ (0.5x)</button>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹/Search..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">All</button>
        <button class="tab-btn" onclick="filterDict('short', this)">ğŸ—£ï¸ Short</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ Fav</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">Survival</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">Dining</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">Shopping</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">Kids</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">Medical</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">Driving</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">Hotel</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">Airport</button>
        <button class="tab-btn" onclick="filterDict('okinawa', this)" style="color:#FF2D55;">ğŸŒº Okinawa</button>
    </div>
</div>

<div id="fullscreen-overlay" onclick="closeFullscreen()">
    <div id="fs-close">âœ•</div>
    <div id="fs-jp">JP</div>
    <div id="fs-cn">CN</div>
    <div id="fs-en">EN</div>
    <div style="margin-top:30px; font-size:12px; color:#555;">(Tap to close)</div>
</div>

<div id="view-learn" class="view active">
    <div style="background:linear-gradient(135deg,#1a2a3a,#1c1c1e); border:1px solid #333; border-radius:16px; padding:15px; margin-bottom:20px; display:flex; gap:15px; align-items:center;">
        <div style="font-size:40px;">ğŸ¦</div>
        <div style="flex:1;">
            <div style="font-size:13px; color:#0A84FF; font-weight:bold; margin-bottom:4px;">Sensei's Tips</div>
            <div id="sensei-msg" style="font-size:15px; color:#fff;">...</div>
        </div>
    </div>
    
    <div class="mask-toggle-area" onclick="toggleMask()">
        <div>
            <div style="font-weight:bold; color:#fff;">ğŸ«£ è¨˜æ†¶é®æ“‹ (Mask Mode)</div>
            <div style="font-size:12px; color:#888;">Hide translation / éš±è—ç¿»è­¯</div>
        </div>
        <div id="mask-switch" class="toggle-switch"><div class="toggle-knob"></div></div>
    </div>

    <div class="week-block" style="color:#888; text-align:center; font-size:13px; margin-bottom:10px;">
        Progress: <span id="progress-text">0%</span>
        <div style="margin-top:15px; font-size:12px; color:#555; text-decoration:underline; cursor:pointer;" onclick="resetAllProgress()">[Reset All Data]</div>
    </div>
    <div id="curriculum-container"></div>
</div>

<div id="view-dialogue" class="view">
    <div id="dialogue-container"></div>
</div>

<div id="view-dict" class="view">
    <div id="dict-container"></div>
</div>

<div id="view-tools" class="view">
    <div class="toolbox-grid">
        <div class="tool-card" onclick="openTool('medical')"><div style="font-size:40px;">ğŸ¥</div><div style="font-weight:bold;margin-top:10px;">Medical</div><div style="font-size:12px;color:#888;">æ€¥æ•‘æŒ‡æŒ‡é€š</div></div>
        <div class="tool-card" onclick="openTool('kana')"><div style="font-size:40px;">ğŸ”¤</div><div style="font-weight:bold;margin-top:10px;">Kana Table</div><div style="font-size:12px;color:#888;">äº”åéŸ³è¡¨</div></div>
        <div class="tool-card" onclick="openTool('kids')"><div style="font-size:40px;">ğŸ‘¶</div><div style="font-weight:bold;margin-top:10px;">Kids Mode</div><div style="font-size:12px;color:#888;">å¥å¥å°ˆå€</div></div>
    </div>
</div>

<div id="view-medical" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div class="medical-grid" id="medical-grid"></div>
</div>
<div id="view-kana" class="view">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
        <button class="tab-btn active" onclick="renderKana('hira')">å¹³å‡å</button>
        <button class="tab-btn" onclick="renderKana('kata')">ç‰‡å‡å</button>
    </div>
    <div id="kana-grid" class="kana-grid"></div>
</div>
<div id="view-kids" class="view" style="background:#f0f8ff; min-height:100vh;">
    <div style="margin-bottom:20px; cursor:pointer; color:#0A84FF; font-weight:bold;" onclick="switchView('tools', document.getElementById('nav-tools'))">â¬… Back</div>
    <div class="kids-grid" id="kids-grid"></div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)"><span class="nav-icon">ğŸ“…</span>ç‰¹è¨“</div>
    <div class="nav-btn" onclick="switchView('dialogue', this)"><span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±</div>
    <div class="nav-btn" onclick="switchView('dict', this)"><span class="nav-icon">ğŸ“–</span>å­—å…¸</div>
    <div class="nav-btn" id="nav-tools" onclick="switchView('tools', this)"><span class="nav-icon">ğŸ§°</span>ç™¾å¯¶</div>
</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™åº« (å®Œæ•´æ“´å……ï¼Œå«è‹±æ–‡) ---
    const phrases = [
        // Short Phrases
        { id: "x1", cat: "short", jp: "ãªã‚‹ã»ã©", romaji: "Na-ru-ho-do", cn: "åŸä¾†å¦‚æ­¤", en: "I see / Indeed" },
        { id: "x2", cat: "short", jp: "ã™ã”ã„", romaji: "Su-go-i", cn: "å¥½å²å®³", en: "Amazing / Wow" },
        { id: "x3", cat: "short", jp: "æœ¬å½“ï¼Ÿ", romaji: "Hon-tou?", cn: "çœŸçš„å—ï¼Ÿ", en: "Really?" },
        { id: "x4", cat: "short", jp: "ã¡ã‚‡ã£ã¨...", romaji: "Chot-to...", cn: "æœ‰é»...(å©‰æ‹’)", en: "A little bit... (No thanks)" },
        { id: "x5", cat: "short", jp: "ã‚‚ã¡ã‚ã‚“ã§ã™", romaji: "Mo-chi-ron", cn: "ç•¶ç„¶", en: "Of course" },
        { id: "x6", cat: "short", jp: "ã„ã„ã§ã™ã‚ˆ", romaji: "Ii de-su yo", cn: "å¯ä»¥å–”", en: "That's fine / Sure" },
        { id: "x7", cat: "short", jp: "ãŠè…¹ã™ã„ãŸ", romaji: "O-na-ka su-i-ta", cn: "è‚šå­é¤“äº†", en: "I'm hungry" },
        { id: "x8", cat: "short", jp: "ç–²ã‚ŒãŸ", romaji: "Tsu-ka-re-ta", cn: "ç´¯äº†", en: "I'm tired" },
        { id: "x9", cat: "short", jp: "å¯æ„›ã„ï¼", romaji: "Ka-wai-i!", cn: "å¥½å¯æ„›ï¼", en: "So cute!" },
        { id: "x10", cat: "short", jp: "ã‚„ã°ã„", romaji: "Ya-bai", cn: "ç³Ÿç³•/å²å®³", en: "OMG / Crazy" },

        // Survival
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€", en: "Excuse me" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", romaji: "A-ri-ga-tou", cn: "è¬è¬", en: "Thank you" },
        { id: "s3", cat: "survival", jp: "å¤§ä¸ˆå¤«ã§ã™", romaji: "Dai-jou-bu", cn: "æ²’é—œä¿‚", en: "It's okay / No thanks" },
        { id: "s4", cat: "survival", jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", romaji: "To-i-re wa do-ko?", cn: "å»æ‰€åœ¨å“ªï¼Ÿ", en: "Where is the restroom?" },
        { id: "s5", cat: "survival", jp: "å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„", romaji: "Sha-shin o tot-te", cn: "è«‹å¹«æˆ‘æ‹ç…§", en: "Take a photo, please" },
        { id: "s6", cat: "survival", jp: "ã‚ã‹ã‚Šã¾ã›ã‚“", romaji: "Wa-ka-ri-ma-sen", cn: "è½ä¸æ‡‚", en: "I don't understand" },
        { id: "s7", cat: "survival", jp: "ã“ã‚Œ", romaji: "Ko-re", cn: "é€™å€‹", en: "This one" },
        { id: "s8", cat: "survival", jp: "ã¯ã„ / ã„ã„ãˆ", romaji: "Hai / Ii-e", cn: "æ˜¯ / ä¸æ˜¯", en: "Yes / No" },

        // Dining
        { id: "d1", cat: "dining", jp: "ã“ã‚Œãã ã•ã„", romaji: "Ko-re Ku-da-sai", cn: "æˆ‘è¦é€™å€‹", en: "This one, please" },
        { id: "d2", cat: "dining", jp: "ãŠæ°´ãã ã•ã„", romaji: "O-mi-zu", cn: "è«‹çµ¦æˆ‘æ°´", en: "Water, please" },
        { id: "d3", cat: "dining", jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", romaji: "O-kai-kei", cn: "éº»ç…©çµå¸³", en: "Check, please" },
        { id: "d4", cat: "dining", jp: "ãƒã‚®æŠœãã§", romaji: "Ne-gi nu-ki de", cn: "ä¸è¦åŠ è”¥", en: "No green onions" },
        { id: "d5", cat: "dining", jp: "æ°·ãªã—", romaji: "Koo-ri na-shi", cn: "å»å†°", en: "No ice" },
        { id: "d6", cat: "dining", jp: "æŒã¡å¸°ã‚Šã§", romaji: "Mo-chi-ka-e-ri de", cn: "æˆ‘è¦å¤–å¸¶", en: "To go / Take out" },
        { id: "d7", cat: "dining", jp: "åˆ¥ã€…ã§", romaji: "Be-tsu be-tsu de", cn: "åˆ†é–‹çµå¸³", en: "Pay separately" },
        { id: "d8", cat: "dining", jp: "ãŠã™ã™ã‚ã¯ï¼Ÿ", romaji: "O-su-su-me wa?", cn: "æœ‰æ¨è–¦çš„å—ï¼Ÿ", en: "Recommendation?" },
        { id: "d9", cat: "dining", jp: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼", romaji: "Me-nyuu", cn: "èœå–®", en: "Menu" },
        { id: "d10", cat: "dining", jp: "è±šè‚‰", romaji: "Bu-ta ni-ku", cn: "è±¬è‚‰", en: "Pork" },
        { id: "d11", cat: "dining", jp: "ç‰›è‚‰", romaji: "Gyuu ni-ku", cn: "ç‰›è‚‰", en: "Beef" },
        { id: "d12", cat: "dining", jp: "é¶è‚‰", romaji: "To-ri ni-ku", cn: "é›è‚‰", en: "Chicken" },
        { id: "d13", cat: "dining", jp: "é­š", romaji: "Sa-ka-na", cn: "é­š", en: "Fish" },
        { id: "d14", cat: "dining", jp: "ç”Ÿãƒ“ãƒ¼ãƒ«", romaji: "Na-ma bii-ru", cn: "ç”Ÿå•¤é…’", en: "Draft beer" },

        // Shopping
        { id: "sh1", cat: "shopping", jp: "ã„ãã‚‰ã§ã™ã‹ï¼Ÿ", romaji: "I-ku-ra?", cn: "å¤šå°‘éŒ¢ï¼Ÿ", en: "How much?" },
        { id: "sh2", cat: "shopping", jp: "ã‚«ãƒ¼ãƒ‰ä½¿ãˆã¾ã™ã‹ï¼Ÿ", romaji: "Kaa-do OK?", cn: "å¯ä»¥åˆ·å¡å—ï¼Ÿ", en: "Credit card OK?" },
        { id: "sh3", cat: "shopping", jp: "å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ", romaji: "Men-zei", cn: "å¯ä»¥é€€ç¨…å—ï¼Ÿ", en: "Tax free?" },
        { id: "sh4", cat: "shopping", jp: "æ–°ã—ã„ã®ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", romaji: "A-ta-ra-shii no", cn: "æœ‰æ–°çš„å—ï¼Ÿ", en: "New one?" },
        { id: "sh5", cat: "shopping", jp: "è¢‹ã„ã‚Šã¾ã›ã‚“", romaji: "Fu-ku-ro i-ri-ma-sen", cn: "ä¸ç”¨è¢‹å­", en: "No bag needed" },
        { id: "sh6", cat: "shopping", jp: "ãƒ¬ã‚·ãƒ¼ãƒˆ", romaji: "Re-shii-to", cn: "æ”¶æ“š", en: "Receipt" },
        { id: "sh7", cat: "shopping", jp: "å¤§ãã„ã‚µã‚¤ã‚º", romaji: "Oo-kii sa-i-zu", cn: "å¤§å°ºå¯¸", en: "Larger size" },
        { id: "sh8", cat: "shopping", jp: "å°ã•ã„ã‚µã‚¤ã‚º", romaji: "Chii-sai sa-i-zu", cn: "å°å°ºå¯¸", en: "Smaller size" },
        { id: "sh9", cat: "shopping", jp: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", romaji: "Pu-re-zen-to", cn: "ç¦®ç‰©åŒ…è£", en: "Gift wrap" },

        // Kids
        { id: "k1", cat: "kids", jp: "å­ä¾›æ¤…å­", romaji: "Ko-do-mo Isu", cn: "å…’ç«¥æ¤…", en: "High chair" },
        { id: "k2", cat: "kids", jp: "ã‚¹ãƒ—ãƒ¼ãƒ³", romaji: "Su-puu-n", cn: "æ¹¯åŒ™", en: "Spoon" },
        { id: "k3", cat: "kids", jp: "ãŠæ¹¯", romaji: "O-yu", cn: "ç†±æ°´(æ³¡å¥¶)", en: "Hot water" },
        { id: "k4", cat: "kids", jp: "ã‹ã‚ã„ã„", romaji: "Ka-wai-i", cn: "å¥½å¯æ„›", en: "Cute" },
        { id: "k5", cat: "kids", jp: "ã‚ªãƒ ãƒ„", romaji: "O-mu-tsu", cn: "å°¿å¸ƒ", en: "Diaper" },
        { id: "k6", cat: "kids", jp: "ãŠã—ã‚Šãµã", romaji: "O-shi-ri fu-ki", cn: "æ¿•ç´™å·¾", en: "Baby wipes" },
        { id: "k7", cat: "kids", jp: "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼", romaji: "Be-bii kaa", cn: "å¬°å…’è»Š", en: "Stroller" },
        { id: "k8", cat: "kids", jp: "ãƒŸãƒ«ã‚¯", romaji: "Mi-ru-ku", cn: "ç‰›å¥¶/é…æ–¹å¥¶", en: "Milk" },
        { id: "k9", cat: "kids", jp: "æˆä¹³å®¤", romaji: "Ju-nyuu shi-tsu", cn: "å“ºä¹³å®¤", en: "Nursing room" },

        // Drug / Medical
        { id: "m1", cat: "drug", jp: "é¢¨é‚ªè–¬", romaji: "Ka-ze gu-su-ri", cn: "æ„Ÿå†’è—¥", en: "Cold medicine" },
        { id: "m2", cat: "drug", jp: "é ­ç—›è–¬", romaji: "Zu-tsuu ya-ku", cn: "é ­ç—›è—¥", en: "Headache med" },
        { id: "m3", cat: "drug", jp: "çµ†å‰µè†", romaji: "Ban-sou-kou", cn: "OKç¹ƒ", en: "Band-aid" },
        { id: "m4", cat: "drug", jp: "è™«é™¤ã‘", romaji: "Mu-shi yo-ke", cn: "é˜²èšŠæ¶²", en: "Bug spray" },
        { id: "m5", cat: "drug", jp: "æ—¥ç„¼ã‘æ­¢ã‚", romaji: "Hi-ya-ke do-me", cn: "é˜²æ›¬ä¹³", en: "Sunscreen" },
        { id: "m6", cat: "drug", jp: "ç†±ãŒã‚ã‚Šã¾ã™", romaji: "Ne-tsu ga a-ri-ma-su", cn: "ç™¼ç‡’", en: "Have a fever" },
        { id: "m7", cat: "drug", jp: "å’³", romaji: "Se-ki", cn: "å’³å—½", en: "Cough" },
        { id: "m8", cat: "drug", jp: "é¼»æ°´", romaji: "Ha-na mi-zu", cn: "æµé¼»æ°´", en: "Runny nose" },
        { id: "m9", cat: "drug", jp: "è–¬å±€", romaji: "Yak-kyo-ku", cn: "è—¥å±€", en: "Pharmacy" },
        { id: "m10", cat: "drug", jp: "ç—…é™¢", romaji: "Byou-in", cn: "é†«é™¢", en: "Hospital" },

        // Driving
        { id: "dr1", cat: "driving", jp: "æº€ã‚¿ãƒ³", romaji: "Man-tan", cn: "åŠ æ»¿æ²¹", en: "Full tank" },
        { id: "dr2", cat: "driving", jp: "é§è»Šå ´", romaji: "Chuu-sha-jou", cn: "åœè»Šå ´", en: "Parking lot" },
        { id: "dr3", cat: "driving", jp: "ãƒŠãƒ“è¨­å®š", romaji: "Na-bi set-tei", cn: "è¨­å®šå°èˆª", en: "Set GPS" },
        { id: "dr4", cat: "driving", jp: "ã“ã“ã«è¡ŒããŸã„", romaji: "Ko-ko ni i-ki-tai", cn: "æˆ‘æƒ³å»é€™è£¡", en: "I want to go here" },
        { id: "dr5", cat: "driving", jp: "ã‚¿ã‚¯ã‚·ãƒ¼", romaji: "Ta-ku-shii", cn: "è¨ˆç¨‹è»Š", en: "Taxi" },
        { id: "dr6", cat: "driving", jp: "ãƒã‚¹åœ", romaji: "Ba-su tei", cn: "å…¬è»Šç«™", en: "Bus stop" },
        { id: "dr7", cat: "driving", jp: "ã¾ã£ã™ã", romaji: "Mas-su-gu", cn: "ç›´èµ°", en: "Go straight" },

        // Hotel
        { id: "h1", cat: "hotel", jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", romaji: "Chek-ku-in", cn: "Check-in", en: "Check-in" },
        { id: "h2", cat: "hotel", jp: "è·ç‰©é ã‹ã‚Š", romaji: "Ni-mo-tsu a-zu-ka-ri", cn: "å¯„æ”¾è¡Œæ", en: "Keep luggage" },
        { id: "h3", cat: "hotel", jp: "Wi-Fiãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", romaji: "Wi-Fi pa-su-waa-do", cn: "Wi-Fiå¯†ç¢¼", en: "Wi-Fi Password" },
        { id: "h4", cat: "hotel", jp: "æœé£Ÿ", romaji: "Chou-sho-ku", cn: "æ—©é¤", en: "Breakfast" },

        // Airport
        { id: "a1", cat: "airport", jp: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ", romaji: "Pa-su-poo-to", cn: "è­·ç…§", en: "Passport" },
        { id: "a2", cat: "airport", jp: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼", romaji: "Ren-ta-kaa", cn: "ç§Ÿè»Š", en: "Rental car" },
        { id: "a3", cat: "airport", jp: "ãƒã‚¹ä¹—ã‚Šå ´", romaji: "Ba-su no-ri-ba", cn: "å·´å£«æ­ä¹˜è™•", en: "Bus stop" },
        { id: "a4", cat: "airport", jp: "å›½éš›ç·š", romaji: "Ko-ku-sai-sen", cn: "åœ‹éš›ç·š", en: "International" },
        { id: "a5", cat: "airport", jp: "è½ã¨ã—ç‰©", romaji: "O-to-shi mo-no", cn: "éºå¤±ç‰©", en: "Lost item" },

        // Okinawa
        { id: "o1", cat: "okinawa", jp: "ã¯ã„ã•ã„", romaji: "Hai-sai", cn: "ä½ å¥½", en: "Hello (Okinawa)" },
        { id: "o2", cat: "okinawa", jp: "ã‚ã‚“ããƒ¼ã‚Œ", romaji: "Men-so-re", cn: "æ­¡è¿å…‰è‡¨", en: "Welcome" },
        { id: "o3", cat: "okinawa", jp: "ã«ãµã‡ãƒ¼ã§ãƒ¼ã³ã‚‹", romaji: "Ni-fee-dee-bi-ru", cn: "è¬è¬", en: "Thank you" },
        { id: "o4", cat: "okinawa", jp: "ãªã‚“ãã‚‹ãªã„ã•", romaji: "Nan-ku-ru nai-sa", cn: "èˆ¹åˆ°æ©‹é ­è‡ªç„¶ç›´", en: "It'll be alright" },
        { id: "o5", cat: "okinawa", jp: "ã‚´ãƒ¼ãƒ¤", romaji: "Goo-ya", cn: "è‹¦ç“œ", en: "Bitter melon" },
        { id: "o6", cat: "okinawa", jp: "ã‚ªãƒªã‚ªãƒ³ãƒ“ãƒ¼ãƒ«", romaji: "O-ri-on Bii-ru", cn: "Orion å•¤é…’", en: "Orion Beer" },
        { id: "o7", cat: "okinawa", jp: "ã‚½ãƒ¼ã‚­ãã°", romaji: "Soo-ki So-ba", cn: "æ’éª¨éºµ", en: "Soki Soba" },
        { id: "o8", cat: "okinawa", jp: "ã‚¢ã‚°ãƒ¼è±š", romaji: "A-guu Bu-ta", cn: "é˜¿å¤è±¬", en: "Agu Pork" }
    ];

    // --- 16 é€±ç‰¹è¨“ (å®Œæ•´) ---
    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2","s3","s4","x1"] },
        { t: "Week 2 æºé€šå›æ‡‰", ids: ["s6","s8","s5","d1","x3"] },
        { t: "Week 3 é»é¤å…¥é–€", ids: ["d2","d3","d5","d9","x7"] },
        { t: "Week 4 é»é¤é«˜æ‰‹", ids: ["d4","d6","d7","d8","x5"] },
        { t: "Week 5 é»é¤é€²éš", ids: ["d10","d11","d12","d13","d14"] },
        { t: "Week 6 è³¼ç‰©åŸºç¤", ids: ["sh1","sh2","sh3","sh5","x2"] },
        { t: "Week 7 è³¼ç‰©é€²éš", ids: ["sh4","sh6","sh7","sh8","sh9"] },
        { t: "Week 8 è¦ªå­å¿…å‚™(1)", ids: ["k1","k2","k3","k4","x9"] },
        { t: "Week 9 è¦ªå­å¿…å‚™(2)", ids: ["k5","k6","k7","k8"] },
        { t: "Week 10 è—¥å¦ç—‡ç‹€(1)", ids: ["m1","m2","m3","m6","x4"] },
        { t: "Week 11 è—¥å¦ç—‡ç‹€(2)", ids: ["m4","m5","m7","m8"] },
        { t: "Week 12 äº¤é€šç§»å‹•", ids: ["dr5","dr6","dr7","a3"] },
        { t: "Week 13 è‡ªé§•ç§Ÿè»Š", ids: ["a2","dr1","dr2","dr3"] },
        { t: "Week 14 é£¯åº—ä½å®¿", ids: ["h1","h2","h3","h4","x6"] },
        { t: "Week 15 æ©Ÿå ´é€šé—œ", ids: ["a1","a4","a5","s5","s1"] },
        { t: "Week 16 å‡ºç™¼æº–å‚™", ids: ["s2","d1","sh1","dr1","x10"] }
    ];

    // --- æœƒè©±èª²ç¨‹ (å«è‹±æ–‡) ---
    const dialogues = [
        {
            title: "ğŸ¨ é£¯åº— Check-in",
            msgs: [
                { r: "user", t: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŠé¡˜ã„ã—ã¾ã™ã€‚", c: "æˆ‘è¦Check-in", e: "Check-in, please." },
                { r: "staff", t: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’è¦‹ã›ã¦ãã ã•ã„ã€‚", c: "è«‹å‡ºç¤ºè­·ç…§", e: "Passport, please." },
                { r: "user", t: "ã¯ã„ã€ã“ã‚Œã§ã™ã€‚", c: "å¥½çš„ï¼Œåœ¨é€™è£¡", e: "Here it is." },
                { r: "user", t: "æœé£Ÿã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ", c: "æ—©é¤æ˜¯å¹¾é»ï¼Ÿ", e: "What time is breakfast?" }
            ]
        },
        {
            title: "ğŸœ é¤å»³å®¢è£½",
            msgs: [
                { r: "staff", t: "ã”æ³¨æ–‡ã¯ï¼Ÿ", c: "è«‹å•è¦é»ä»€éº¼ï¼Ÿ", e: "Order please?" },
                { r: "user", t: "ã“ã‚Œãã ã•ã„ã€‚ãƒã‚®æŠœãã§ã€‚", c: "æˆ‘è¦é€™å€‹ï¼Œä¸è¦è”¥", e: "This one, no green onions." },
                { r: "user", t: "ã‚ã¨ã€å­ä¾›æ¤…å­ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "é‚„æœ‰ï¼Œæœ‰å…’ç«¥æ¤…å—ï¼Ÿ", e: "Do you have a high chair?" },
                { r: "staff", t: "ã¯ã„ã€ã‚ã‚Šã¾ã™ã‚ˆã€‚", c: "æœ‰çš„ï¼Œé€™é‚Šè«‹", e: "Yes, this way." }
            ]
        },
        {
            title: "ğŸ’Š è—¥å¦åº—è²·è—¥",
            msgs: [
                { r: "user", t: "ã™ã¿ã¾ã›ã‚“ã€é¢¨é‚ªè–¬ã¯ã©ã“ï¼Ÿ", c: "ä¸å¥½æ„æ€ï¼Œæ„Ÿå†’è—¥åœ¨å“ªï¼Ÿ", e: "Where is cold medicine?" },
                { r: "staff", t: "ç†±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "æœ‰ç™¼ç‡’å—ï¼Ÿ", e: "Do you have a fever?" },
                { r: "user", t: "ã¯ã„ã€å°‘ã—ã€‚", c: "æœ‰ï¼Œä¸€é»é»", e: "Yes, a little." },
                { r: "staff", t: "ã“ã¡ã‚‰ãŒãŠã™ã™ã‚ã§ã™ã€‚", c: "æ¨è–¦é€™å€‹çµ¦æ‚¨", e: "I recommend this one." }
            ]
        },
        {
            title: "ğŸª è¶…å•†çµå¸³",
            msgs: [
                { r: "staff", t: "è¢‹ã„ã‚Šã¾ã™ã‹ï¼Ÿ", c: "è¦è¢‹å­å—ï¼Ÿ", e: "Need a bag?" },
                { r: "user", t: "å¤§ä¸ˆå¤«ã§ã™ã€‚", c: "ä¸ç”¨äº†", e: "No thanks." },
                { r: "staff", t: "æ¸©ã‚ã¾ã™ã‹ï¼Ÿ", c: "è¦åŠ ç†±å—ï¼Ÿ", e: "Warm it up?" },
                { r: "user", t: "ãŠé¡˜ã„ã—ã¾ã™ã€‚", c: "éº»ç…©ä½ äº†", e: "Yes, please." }
            ]
        },
        {
            title: "ğŸš• æ­è¨ˆç¨‹è»Š",
            msgs: [
                { r: "user", t: "ã“ã“ã«è¡Œã£ã¦ãã ã•ã„ã€‚", c: "è«‹å»é€™è£¡(æŒ‡åœ°åœ–)", e: "Go here please." },
                { r: "staff", t: "ã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚", c: "å¥½çš„ï¼ŒçŸ¥é“äº†", e: "Okay, understood." },
                { r: "user", t: "ã‚«ãƒ¼ãƒ‰OKã§ã™ã‹ï¼Ÿ", c: "å¯ä»¥åˆ·å¡å—ï¼Ÿ", e: "Credit card OK?" },
                { r: "staff", t: "ã¯ã„ã€OKã§ã™ã€‚", c: "å¯ä»¥çš„", e: "Yes, OK." }
            ]
        },
        {
            title: "ğŸš— åŠ æ²¹ç«™",
            msgs: [
                { r: "staff", t: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚", c: "æ­¡è¿å…‰è‡¨", e: "Welcome." },
                { r: "user", t: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã€æº€ã‚¿ãƒ³ã§ã€‚", c: "æ™®é€šæ²¹ï¼ŒåŠ æ»¿", e: "Regular, full tank." },
                { r: "user", t: "ã‚´ãƒŸã€æ¨ã¦ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ", c: "å¯ä»¥å¹«æˆ‘ä¸Ÿåƒåœ¾å—ï¼Ÿ", e: "Can you trash this?" },
                { r: "staff", t: "ã¯ã„ã€ã©ã†ãã€‚", c: "Sure, go ahead.", e: "Sure." }
            ]
        },
        {
            title: "ğŸ‘¶ è¦ªå­çªç™¼",
            msgs: [
                { r: "user", t: "ã™ã¿ã¾ã›ã‚“ã€ãƒˆã‚¤ãƒ¬ã©ã“ï¼Ÿ", c: "ä¸å¥½æ„æ€ï¼Œå»æ‰€åœ¨å“ªï¼Ÿ", e: "Where is the toilet?" },
                { r: "staff", t: "ã‚ã¡ã‚‰ã§ã™ã€‚", c: "åœ¨é‚£é‚Š", e: "Over there." },
                { r: "user", t: "æˆä¹³å®¤ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "æœ‰å“ºä¹³å®¤å—ï¼Ÿ", e: "Nursing room?" },
                { r: "staff", t: "ã¯ã„ã€å¥¥ã«ã‚ã‚Šã¾ã™ã€‚", c: "æœ‰ï¼Œåœ¨è£¡é¢", e: "Yes, in the back." }
            ]
        }
    ];

    // --- ç¨‹å¼é‚è¼¯ ---
    let currentCat = 'all';
    let isMasked = false;
    let isPlaying = false;
    let speechRate = 1.0; // é è¨­èªé€Ÿ 1.0

    // å·¥å…·ç®±è³‡æ–™
    const medicalItems = [
        {t:"ç†±ãŒã‚ã‚Šã¾ã™",c:"ç™¼ç‡’",e:"Fever"}, {t:"ãŠè…¹ãŒç—›ã„",c:"è‚šå­ç—›",e:"Stomachache"},
        {t:"åãæ°—ãŒã—ã¾ã™",c:"æƒ³å",e:"Nausea"}, {t:"æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ",c:"å—å‚·",e:"Injured"},
        {t:"åµã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼",c:"è›‹éæ•",e:"Egg Allergy"}, {t:"ç‰›ä¹³ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼",c:"å¥¶éæ•",e:"Milk Allergy"},
        {t:"æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§",c:"å«æ•‘è­·è»Š",e:"Call Ambulance"}, {t:"è–¬å±€ã¯ã©ã“",c:"è—¥å±€åœ¨å“ª",e:"Pharmacy?"}
    ];
    const kidsItems = [
        {t:"ãã‚‡ã†ã‚Šã‚…ã†",c:"æé¾",i:"ğŸ¦–"}, {t:"ãã†",c:"å¤§è±¡",i:"ğŸ˜"},
        {t:"ã‚¢ã‚¤ã‚¹",c:"å†°æ·‡æ·‹",i:"ğŸ¦"}, {t:"ãƒã‚¹",c:"å…¬è»Š",i:"ğŸšŒ"},
        {t:"ã²ã“ã†ã",c:"é£›æ©Ÿ",i:"âœˆï¸"}, {t:"ãƒãƒŠãƒŠ",c:"é¦™è•‰",i:"ğŸŒ"}
    ];
    const kanaData = {
        hira: ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“","ã•","ã—","ã™","ã›","ã","ãŸ","ã¡","ã¤","ã¦","ã¨","ãª","ã«","ã¬","ã­","ã®","ã¯","ã²","ãµ","ã¸","ã»","ã¾","ã¿","ã‚€","ã‚","ã‚‚","ã‚„","","ã‚†","","ã‚ˆ","ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚","ã‚","","","","ã‚’","ã‚“"],
        kata: ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª","ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³","ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½","ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ","ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ","ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›","ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢","ãƒ¤","","ãƒ¦","","ãƒ¨","ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­","ãƒ¯","","","","ãƒ²","ãƒ³"]
    };

    // åˆå§‹åŒ–
    init();

    function init() {
        document.getElementById('sensei-msg').innerText = ["åŠ æ²¹ï¼ğŸ’ª","æ¯å¤©5åˆ†é˜ï¼â°","å¥å¥ç­‰ä½ å¸¶ä»–ç©ï¼ğŸ‘¶","æ²–ç¹©æˆ‘ä¾†äº†ï¼ğŸŒº"][Math.floor(Math.random()*4)];
        renderPlan();
        renderDialogues();
        filterDict('all', null);
        loadMaskState();
        updateAllStats();
        
        // Render Medical
        document.getElementById('medical-grid').innerHTML = medicalItems.map(i => 
            `<div class="med-btn" onclick="speak('${i.t}')"><span style="font-size:24px">ğŸ†˜</span><div class="med-label" style="font-size:16px;color:#FF453A;font-weight:bold;margin:5px 0;">${i.c}</div><div class="med-en">${i.e}</div></div>`
        ).join('');
        
        // Render Kids
        document.getElementById('kids-grid').innerHTML = kidsItems.map(i => 
            `<div class="kid-card" onclick="speak('${i.t}')"><div class="kid-icon">${i.i}</div><div class="kid-label">${i.c}</div></div>`
        ).join('');
        
        // Render Kana (Default Hira)
        renderKana('hira');
    }

    // èªé€Ÿåˆ‡æ› (0.5x vs 1.0x)
    function toggleSpeed() {
        const btn = document.getElementById('speed-toggle');
        if (speechRate === 1.0) {
            speechRate = 0.5; // è¶…æ…¢
            btn.innerText = "ğŸ¢ æ…¢é€Ÿ (0.5x)";
        } else {
            speechRate = 1.0; // æ­£å¸¸
            btn.innerText = "ğŸ‡ æ­£å¸¸ (1.0x)";
        }
    }

    // åˆ‡æ›é é¢
    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        
        if(['medical','kana','kids'].includes(name)) {
            document.getElementById('view-'+name).classList.add('active');
            document.getElementById('nav-tools').classList.add('active');
        } else {
            document.getElementById('view-'+name).classList.add('active');
            if(btn) btn.classList.add('active');
        }

        const isDict = name === 'dict';
        document.getElementById('tabs-bar').style.display = isDict ? 'block' : 'none';
        document.getElementById('search-bar-container').style.display = isDict ? 'block' : 'none';
        
        stopAllAutoPlay();
        window.scrollTo(0,0);
    }

    function openTool(name) { switchView(name); }

    // ç‰¹è¨“æ¸²æŸ“
    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_v18_prog')||'[]');
        const maskClass = isMasked ? 'masked' : '';
        box.innerHTML = weeks.map((w, idx) => {
            const idsStr = w.ids.join(',');
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `
                <div class="card ${maskClass}" id="card-${id}" onclick="speak('${p.jp}')">
                    <div class="card-top">
                        <div style="flex:1">
                            <div class="jp-big">${p.jp} ğŸ”Š</div>
                            <span class="romaji">${p.romaji}</span>
                            <div class="cn">${p.cn}</div>
                            <div class="en">${p.en}</div>
                        </div>
                        <div class="card-actions">
                            <div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div>
                            <div class="check-box ${chk}" onclick="event.stopPropagation(); toggleCheck('${id}', this)">âœ“</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            return `<div class="week-header"><div class="week-title-row"><h3 class="week-title">${w.t}</h3><div class="week-actions"><div class="action-btn autoplay-btn" onclick="toggleAutoPlay(this, '${idsStr}')">â–¶ Play</div><div class="action-btn reset-btn" onclick="resetWeek(${idx})">â†º</div></div></div></div>${lessons}`;
        }).join('');
    }

    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_v18_prog')||'[]');
        if (saved.includes(id)) { saved = saved.filter(x => x !== id); el.classList.remove('checked'); }
        else { saved.push(id); el.classList.add('checked'); }
        localStorage.setItem('jp_v18_prog', JSON.stringify(saved));
        updateAllStats();
    }

    function resetWeek(idx) {
        if(!confirm("é‡ç½®æœ¬é€±é€²åº¦ï¼Ÿ")) return;
        let saved = JSON.parse(localStorage.getItem('jp_v18_prog')||'[]');
        const weekIds = weeks[idx].ids;
        saved = saved.filter(id => !weekIds.includes(id));
        localStorage.setItem('jp_v18_prog', JSON.stringify(saved));
        renderPlan(); updateAllStats();
    }

    function resetAllProgress() {
        if(!confirm("æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼Ÿ")) return;
        localStorage.clear();
        location.reload();
    }

    function updateAllStats() {
        const saved = JSON.parse(localStorage.getItem('jp_v18_prog')||'[]');
        const total = weeks.reduce((a,b)=>a+b.ids.length,0);
        const pct = Math.round(saved.length/total*100);
        document.getElementById('progress-text').innerText = pct+'%';
    }

    // å­—å…¸æ¸²æŸ“
    function filterDict(cat, btn) {
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('search-input').value = '';
        let data = phrases;
        if (cat === 'fav') { const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]'); data = phrases.filter(p => favs.includes(p.id)); }
        else if (cat !== 'all') { data = phrases.filter(p => p.cat === cat); }
        renderDictRaw(data);
    }

    function renderDictRaw(data) {
        const box = document.getElementById('dict-container');
        const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (data.length === 0) { box.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ç„¡çµæœ</div>'; return; }
        box.innerHTML = data.map(p => {
            const isFav = favs.includes(p.id) ? 'fav' : '';
            return `<div class="card" onclick="speak('${p.jp}')"><div class="card-top"><div style="flex:1"><div class="jp-big">${p.jp} ğŸ”Š</div><span class="romaji">${p.romaji}</span><div class="cn">${p.cn}</div><div class="en">${p.en}</div></div><div class="card-actions"><div class="show-btn" onclick="openFullscreen('${p.jp}', '${p.cn}', '${p.en}')">ğŸ”</div><div class="star-btn ${isFav}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">â˜…</div></div></div></div>`;
        }).join('');
    }

    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (favs.includes(id)) { favs = favs.filter(x => x !== id); el.classList.remove('fav'); }
        else { favs.push(id); el.classList.add('fav'); }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
    }

    function handleSearch() {
        const key = document.getElementById('search-input').value.toLowerCase();
        renderDictRaw(phrases.filter(p => p.jp.includes(key) || p.romaji.toLowerCase().includes(key) || p.cn.includes(key) || p.en.toLowerCase().includes(key)));
    }

    // æœƒè©±æ¸²æŸ“
    function renderDialogues() {
        document.getElementById('dialogue-container').innerHTML = dialogues.map(d => {
            const bubbles = d.msgs.map(m => {
                const rowClass = m.r === 'user' ? 'user-row' : 'staff-row';
                const avatar = m.r === 'user' ? 'ğŸ§‘â€ğŸ¼' : 'ğŸ‘©â€ğŸ’¼';
                return `<div class="chat-row ${rowClass}"><div class="avatar">${avatar}</div><div class="chat-bubble" onclick="speak('${m.t}')"><span class="bubble-jp">${m.t} ğŸ”Š</span><span class="bubble-meta">${m.c} <br> ${m.e}</span></div></div>`;
            }).join('');
            return `<div class="dialogue-card"><div class="dialogue-header"><span>${d.title}</span></div><div class="dialogue-body">${bubbles}</div></div>`;
        }).join('');
    }

    // äº”åéŸ³
    function renderKana(type) {
        const grid = document.getElementById('kana-grid');
        grid.innerHTML = kanaData[type].map(char => 
            char ? `<div class="kana-cell" onclick="speak('${char}')"><div style="font-size:20px;font-weight:bold;color:white;">${char}</div></div>` : `<div></div>`
        ).join('');
    }

    // å…¶ä»–åŠŸèƒ½
    function toggleAutoPlay(btn, idsStr) {
        const ids = idsStr.split(',');
        if (isPlaying) { stopAllAutoPlay(); return; }
        isPlaying = true; btn.classList.add('playing'); btn.innerHTML = 'â¹ Stop';
        let index = 0;
        function playNext() {
            if (!isPlaying || index >= ids.length) { index = 0; }
            const id = ids[index];
            const p = phrases.find(x => x.id === id);
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
            const card = document.getElementById('card-'+id);
            if(card) card.classList.add('active-playing');
            speak(p.jp, () => { setTimeout(() => { speak(p.cn, () => { setTimeout(() => { index++; playNext(); }, 1500); }, 'zh-TW'); }, 800); });
        }
        playNext();
    }
    function stopAllAutoPlay() {
        isPlaying = false; window.speechSynthesis.cancel();
        document.querySelectorAll('.autoplay-btn').forEach(b => { b.classList.remove('playing'); b.innerHTML = 'â–¶ Play'; });
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
    }

    function toggleMask() { isMasked = !isMasked; document.getElementById('mask-switch').classList.toggle('on'); renderPlan(); }
    function loadMaskState() { isMasked = false; } // Reset on load for better UX

    function openFullscreen(jp, cn, en) { event.stopPropagation(); document.getElementById('fs-jp').innerText = jp; document.getElementById('fs-cn').innerText = cn; document.getElementById('fs-en').innerText = en; document.getElementById('fullscreen-overlay').style.display = 'flex'; }
    function closeFullscreen() { document.getElementById('fullscreen-overlay').style.display = 'none'; }

    function speak(txt, onEnd=null, lang='ja-JP') {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = lang;
        u.rate = speechRate;
        if (onEnd) u.onend = onEnd;
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
