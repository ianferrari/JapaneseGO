<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JapaneseGO V10.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --accent-color: #0A84FF;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --safe-top: env(safe-area-inset-top);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: 120px;
        }

        /* é ‚éƒ¨å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            padding-top: var(--safe-top);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        h1 { margin: 0; font-size: 22px; font-weight: 800; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* æœå°‹æ¡† & åˆ†é¡ (å­—å…¸ç”¨) */
        .search-box { margin: 0 15px 10px 15px; position: relative; display: none; }
        .search-input { width: 100%; background: #2c2c2e; border: none; border-radius: 10px; padding: 10px 10px 10px 35px; color: #fff; font-size: 16px; }
        .search-icon { position: absolute; left: 10px; top: 10px; color: #888; }
        
        .tabs-container { width: 100%; overflow-x: auto; padding: 0 15px 10px 15px; white-space: nowrap; display: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; appearance: none; background: #333; color: #ccc; border: 1px solid #444; padding: 6px 14px; border-radius: 18px; font-size: 13px; font-weight: 600; margin-right: 8px; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        /* å…§å®¹å€ */
        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç‰¹è¨“æ¨£å¼ */
        .mask-toggle-area { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; }
        .toggle-switch { position: relative; width: 50px; height: 30px; background: #444; border-radius: 15px; transition: 0.3s; }
        .toggle-switch.on { background: #30D158; }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on .toggle-knob { transform: translateX(20px); }

        .week-header { margin: 25px 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .week-title { color: #0A84FF; font-size: 18px; font-weight: bold; margin: 0; }
        .autoplay-btn { background: #222; border: 1px solid #444; color: #0A84FF; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .autoplay-btn.playing { background: #0A84FF; color: #fff; border-color: #0A84FF; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* å¡ç‰‡ */
        .card { background: #1c1c1e; border: 1px solid #333; border-radius: 16px; padding: 16px; margin-bottom: 12px; position: relative; transition: 0.2s; }
        .card.active-playing { border-color: #0A84FF; background: #1a2a3a; transform: scale(1.02); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .jp-big { font-size: 19px; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .romaji { font-family: monospace; color: #FFD60A; font-size: 13px; margin-bottom: 5px; display: block; }
        .cn { font-size: 15px; color: #ccc; transition: 0.3s; }
        .masked .romaji, .masked .cn { opacity: 0; filter: blur(5px); }
        .masked:active .romaji, .masked:active .cn { opacity: 1; filter: none; }
        .star-btn { font-size: 22px; color: #555; transition: 0.2s; padding: 5px; }
        .star-btn.fav { color: #FFD60A; transform: scale(1.2); }

        /* è¤‡ç¿’æ¨¡å¼ (Review) */
        .review-stats { text-align: center; color: #888; font-size: 13px; margin-bottom: 20px; }
        .flashcard-container { perspective: 1000px; width: 100%; height: 300px; margin-top: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; background: #222; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; }
        .flashcard-back { transform: rotateY(180deg); background: #2c2c2e; }
        .review-btns { display: flex; gap: 15px; margin-top: 30px; justify-content: center; }
        .r-btn { padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; font-size: 16px; min-width: 120px; }
        .r-btn.next { background: #0A84FF; color: white; }
        .r-btn.flip { background: #444; color: white; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(15,15,15,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding-top: 10px; z-index: 2000; }
        .nav-btn { text-align: center; color: #666; font-size: 10px; width: 20%; }
        .nav-btn.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>JapaneseGO <span style="font-size:12px; color:#888;">Final V10.0</span></h1>
    </div>
    <div id="search-bar-container" class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="æœå°‹..." oninput="handleSearch()">
    </div>
    <div id="tabs-bar" class="tabs-container">
        <button class="tab-btn active" onclick="filterDict('all', this)">å…¨éƒ¨</button>
        <button class="tab-btn" onclick="filterDict('fav', this)">â­ æ”¶è—</button>
        <button class="tab-btn" onclick="filterDict('survival', this)">ç”Ÿå­˜</button>
        <button class="tab-btn" onclick="filterDict('dining', this)">ç¾é£Ÿ</button>
        <button class="tab-btn" onclick="filterDict('shopping', this)">è³¼ç‰©</button>
        <button class="tab-btn" onclick="filterDict('kids', this)">è¦ªå­</button>
        <button class="tab-btn" onclick="filterDict('drug', this)">è—¥å¦</button>
        <button class="tab-btn" onclick="filterDict('driving', this)">äº¤é€š</button>
        <button class="tab-btn" onclick="filterDict('hotel', this)">ä½å®¿</button>
        <button class="tab-btn" onclick="filterDict('airport', this)">æ©Ÿå ´</button>
    </div>
</div>

<div id="view-learn" class="view active">
    <div class="mask-toggle-area" onclick="toggleMask()">
        <div>
            <div style="font-weight:bold; color:#fff;">ğŸ«£ è¨˜æ†¶é®æ“‹æ¨¡å¼</div>
            <div style="font-size:12px; color:#888;">éš±è—ä¸­æ–‡ï¼Œè€ƒè€ƒè‡ªå·±</div>
        </div>
        <div id="mask-switch" class="toggle-switch"><div class="toggle-knob"></div></div>
    </div>
    <div class="week-block" style="color:#888; text-align:center; font-size:13px; margin-bottom:10px;">
        ç¸½é€²åº¦: <span id="progress-text">0%</span>
    </div>
    <div id="curriculum-container"></div>
</div>

<div id="view-review" class="view">
    <div style="text-align:center; margin-top:20px;">
        <h2>ğŸ”€ éš¨æ©ŸæŠ½è€ƒ</h2>
        <div class="review-stats">
            å¾å·²å­¸ç¿’çš„ <span id="learned-count" style="color:#0A84FF; font-weight:bold;">0</span> å€‹å–®å­—ä¸­å‡ºé¡Œ
        </div>
    </div>

    <div id="review-area" style="display:none;">
        <div class="flashcard-container" onclick="flipCard()">
            <div id="flashcard" class="flashcard">
                <div class="flashcard-front">
                    <div style="font-size:32px; font-weight:800; margin-bottom:10px;" id="fc-jp">JP</div>
                    <div style="color:#FFD60A; font-family:monospace;" id="fc-romaji">Romaji</div>
                    <div style="margin-top:20px; color:#666; font-size:12px;">(é»æ“Šç¿»é¢)</div>
                </div>
                <div class="flashcard-back">
                    <div style="font-size:24px; font-weight:bold;" id="fc-cn">CN</div>
                    <div style="margin-top:20px; font-size:30px;" onclick="event.stopPropagation(); speakCurrentCard()">ğŸ”Š</div>
                </div>
            </div>
        </div>
        <div class="review-btns">
            <button class="r-btn next" onclick="nextCard()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="empty-review" style="text-align:center; margin-top:50px; color:#666; display:none;">
        <div style="font-size:50px; margin-bottom:20px;">ğŸ“</div>
        ä½ é‚„æ²’æœ‰æ‰“å‹¾ä»»ä½•å–®å­—å–”ï¼<br>å»ç‰¹è¨“è¨ˆç•«å‹¾é¸å­¸æœƒçš„å–®å­—å†ä¾†è¤‡ç¿’å§ã€‚
    </div>
</div>

<div id="view-dialogue" class="view">
    <div id="dialogue-container"></div>
</div>

<div id="view-dict" class="view">
    <div id="dict-container"></div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active" onclick="switchView('learn', this)">
        <span class="nav-icon">ğŸ“…</span>ç‰¹è¨“
    </div>
    <div class="nav-btn" onclick="switchView('review', this)">
        <span class="nav-icon">ğŸ”€</span>è¤‡ç¿’
    </div>
    <div class="nav-btn" onclick="switchView('dialogue', this)">
        <span class="nav-icon">ğŸ—£ï¸</span>æœƒè©±
    </div>
    <div class="nav-btn" onclick="switchView('dict', this)">
        <span class="nav-icon">ğŸ“–</span>å­—å…¸
    </div>
</div>

<script>
    // --- å®Œæ•´è³‡æ–™åº« (ä¿æŒ V9.0 çš„è±å¯Œå…§å®¹) ---
    // (ç‚ºäº†ç¯‡å¹…ï¼Œé€™è£¡çœç•¥ä¸­é–“é‡è¤‡çš„è³‡æ–™ï¼Œè«‹å‹™å¿…ä½¿ç”¨ V9.0 çš„å®Œæ•´ phrases é™£åˆ—)
    // *** è«‹ç¢ºä¿é€™è£¡åŒ…å« V9.0 æ‰€æœ‰ 150+ å¥å–®å­— ***
    const phrases = [
        { id: "s1", cat: "survival", jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Su-mi-ma-sen", cn: "ä¸å¥½æ„æ€" },
        { id: "s2", cat: "survival", jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "A-ri-ga-tou", cn: "è¬è¬" },
        { id: "s3", cat: "survival", jp: "å¤§ä¸ˆå¤«", romaji: "Dai-jou-bu", cn: "æ²’é—œä¿‚" },
        { id: "s4", cat: "survival", jp: "ãƒˆã‚¤ãƒ¬", romaji: "To-i-re", cn: "å»æ‰€" },
        { id: "s5", cat: "survival", jp: "å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„", romaji: "Sha-shin o tot-te...", cn: "è«‹å¹«æˆ‘æ‹ç…§" },
        { id: "s6", cat: "survival", jp: "ã‚ã‹ã‚Šã¾ã›ã‚“", romaji: "Wa-ka-ri-ma-sen", cn: "è½ä¸æ‡‚" },
        { id: "s7", cat: "survival", jp: "ã“ã‚Œ", romaji: "Ko-re", cn: "é€™å€‹" },
        { id: "s8", cat: "survival", jp: "ã¯ã„ / ã„ã„ãˆ", romaji: "Hai / Ii-e", cn: "æ˜¯ / ä¸æ˜¯" },
        { id: "d1", cat: "dining", jp: "ã“ã‚Œãã ã•ã„", romaji: "Ko-re Ku-da-sai", cn: "æˆ‘è¦é€™å€‹" },
        { id: "d2", cat: "dining", jp: "ãŠæ°´", romaji: "O-mi-zu", cn: "æ°´" },
        { id: "d3", cat: "dining", jp: "ãŠä¼šè¨ˆ", romaji: "O-kai-kei", cn: "çµå¸³" },
        { id: "d4", cat: "dining", jp: "ãƒã‚®æŠœãã§", romaji: "Ne-gi nu-ki de", cn: "ä¸è¦åŠ è”¥" },
        { id: "d5", cat: "dining", jp: "æ°·ãªã—", romaji: "Koo-ri na-shi", cn: "å»å†°" },
        { id: "d6", cat: "dining", jp: "æŒã¡å¸°ã‚Šã§", romaji: "Mo-chi-ka-e-ri de", cn: "æˆ‘è¦å¤–å¸¶" },
        { id: "d7", cat: "dining", jp: "åˆ¥ã€…ã§", romaji: "Be-tsu be-tsu de", cn: "åˆ†é–‹çµå¸³" },
        { id: "d8", cat: "dining", jp: "ãŠã™ã™ã‚ã¯ï¼Ÿ", romaji: "O-su-su-me wa?", cn: "æœ‰æ¨è–¦çš„å—ï¼Ÿ" },
        { id: "d9", cat: "dining", jp: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼", romaji: "Me-nyuu", cn: "èœå–®" },
        { id: "sh1", cat: "shopping", jp: "ã„ãã‚‰ï¼Ÿ", romaji: "I-ku-ra?", cn: "å¤šå°‘éŒ¢ï¼Ÿ" },
        { id: "sh2", cat: "shopping", jp: "ã‚«ãƒ¼ãƒ‰OKï¼Ÿ", romaji: "Kaa-do OK?", cn: "å¯ä»¥åˆ·å¡å—ï¼Ÿ" },
        { id: "sh3", cat: "shopping", jp: "å…ç¨", romaji: "Men-zei", cn: "é€€ç¨…" },
        { id: "sh4", cat: "shopping", jp: "æ–°ã—ã„ã®", romaji: "A-ta-ra-shii no", cn: "æœ‰æ–°çš„å—ï¼Ÿ" },
        { id: "sh5", cat: "shopping", jp: "è¢‹ã„ã‚Šã¾ã›ã‚“", romaji: "Fu-ku-ro i-ri-ma-sen", cn: "ä¸ç”¨è¢‹å­" },
        { id: "k1", cat: "kids", jp: "å­ä¾›æ¤…å­", romaji: "Ko-do-mo Isu", cn: "å…’ç«¥æ¤…" },
        { id: "k2", cat: "kids", jp: "ã‚¹ãƒ—ãƒ¼ãƒ³", romaji: "Su-puu-n", cn: "æ¹¯åŒ™" },
        { id: "k3", cat: "kids", jp: "ãŠæ¹¯", romaji: "O-yu", cn: "ç†±æ°´(æ³¡å¥¶)" },
        { id: "k4", cat: "kids", jp: "ã‹ã‚ã„ã„", romaji: "Ka-wai-i", cn: "å¥½å¯æ„›" },
        { id: "k5", cat: "kids", jp: "ã‚ªãƒ ãƒ„", romaji: "O-mu-tsu", cn: "å°¿å¸ƒ" },
        { id: "k6", cat: "kids", jp: "ãŠã—ã‚Šãµã", romaji: "O-shi-ri fu-ki", cn: "æ¿•ç´™å·¾" },
        { id: "k7", cat: "kids", jp: "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼", romaji: "Be-bii kaa", cn: "å¬°å…’è»Š" },
        { id: "m1", cat: "drug", jp: "é¢¨é‚ªè–¬", romaji: "Ka-ze gu-su-ri", cn: "æ„Ÿå†’è—¥" },
        { id: "m2", cat: "drug", jp: "é ­ç—›è–¬", romaji: "Zu-tsuu ya-ku", cn: "é ­ç—›è—¥" },
        { id: "m3", cat: "drug", jp: "çµ†å‰µè†", romaji: "Ban-sou-kou", cn: "OKç¹ƒ" },
        { id: "m4", cat: "drug", jp: "è™«é™¤ã‘", romaji: "Mu-shi yo-ke", cn: "é˜²èšŠæ¶²" },
        { id: "m5", cat: "drug", jp: "æ—¥ç„¼ã‘æ­¢ã‚", romaji: "Hi-ya-ke do-me", cn: "é˜²æ›¬ä¹³" },
        { id: "m6", cat: "drug", jp: "ç†±", romaji: "Ne-tsu", cn: "ç™¼ç‡’" },
        { id: "dr1", cat: "driving", jp: "æº€ã‚¿ãƒ³", romaji: "Man-tan", cn: "åŠ æ»¿æ²¹" },
        { id: "dr2", cat: "driving", jp: "é§è»Šå ´", romaji: "Chuu-sha-jou", cn: "åœè»Šå ´" },
        { id: "dr3", cat: "driving", jp: "ãƒŠãƒ“è¨­å®š", romaji: "Na-bi set-tei", cn: "è¨­å®šå°èˆª" },
        { id: "dr4", cat: "driving", jp: "ã“ã“ã«è¡ŒããŸã„", romaji: "Ko-ko ni i-ki-tai", cn: "æˆ‘æƒ³å»é€™è£¡" },
        { id: "dr5", cat: "driving", jp: "ã‚¿ã‚¯ã‚·ãƒ¼", romaji: "Ta-ku-shii", cn: "è¨ˆç¨‹è»Š" },
        { id: "h1", cat: "hotel", jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", romaji: "Chek-ku-in", cn: "Check-in" },
        { id: "h2", cat: "hotel", jp: "è·ç‰©é ã‹ã‚Š", romaji: "Ni-mo-tsu a-zu-ka-ri", cn: "å¯„æ”¾è¡Œæ" },
        { id: "h3", cat: "hotel", jp: "Wi-Fiãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", romaji: "Wi-Fi pa-su-waa-do", cn: "Wi-Fiå¯†ç¢¼" },
        { id: "a1", cat: "airport", jp: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ", romaji: "Pa-su-poo-to", cn: "è­·ç…§" },
        { id: "a2", cat: "airport", jp: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼", romaji: "Ren-ta-kaa", cn: "ç§Ÿè»Š" },
        { id: "a4", cat: "airport", jp: "å›½éš›ç·š", romaji: "Ko-ku-sai-sen", cn: "åœ‹éš›ç·š" }
    ];
    // (ä¸Šæ–¹åƒ…åˆ—å‡ºéƒ¨åˆ†ï¼Œè«‹å‹™å¿…è£œä¸Š V9.0 çš„å®Œæ•´è³‡æ–™)

    const weeks = [
        { t: "Week 1 ç”Ÿå­˜åŸºç¤", ids: ["s1","s2","s3","s4","s7"] },
        { t: "Week 2 æºé€šå›æ‡‰", ids: ["s6","s8","s5","d1"] },
        { t: "Week 3 é»é¤å…¥é–€", ids: ["d2","d3","d5","d9"] },
        { t: "Week 4 é»é¤é«˜æ‰‹", ids: ["d4","d6","d7","d8"] },
        { t: "Week 5 è³¼ç‰©åŸºç¤", ids: ["sh1","sh2","sh3","sh5"] },
        { t: "Week 6 è³¼ç‰©é€²éš", ids: ["sh4","sh6","sh7","a1"] },
        { t: "Week 7 è¦ªå­å¿…å‚™(1)", ids: ["k1","k2","k3","k4"] },
        { t: "Week 8 è¦ªå­å¿…å‚™(2)", ids: ["k5","k6","k7","k8"] },
        { t: "Week 9 è—¥å¦ç—‡ç‹€(1)", ids: ["m1","m2","m3","m6"] },
        { t: "Week 10 è—¥å¦ç—‡ç‹€(2)", ids: ["m4","m5","m7","m8"] },
        { t: "Week 11 äº¤é€šç§»å‹•", ids: ["dr5","dr6","dr7","a3"] },
        { t: "Week 12 è‡ªé§•ç§Ÿè»Š", ids: ["a2","dr1","dr2","dr3"] },
        { t: "Week 13 é£¯åº—ä½å®¿", ids: ["h1","h2","h3","h4"] },
        { t: "Week 14 æ©Ÿå ´é€šé—œ", ids: ["a1","a4","s5","s1"] },
        { t: "Week 15 ç·Šæ€¥è¤‡ç¿’", ids: ["s4","m6","dr4","k9"] },
        { t: "Week 16 å‡ºç™¼æº–å‚™", ids: ["s2","d1","sh1","dr1"] }
    ];

    const dialogues = [
        {
            title: "ğŸ¨ é£¯åº—å…¥ä½",
            msgs: [
                { r: "user", t: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŠé¡˜ã„ã—ã¾ã™ã€‚", c: "æˆ‘è¦Check-in" },
                { r: "staff", t: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’è¦‹ã›ã¦ãã ã•ã„ã€‚", c: "è«‹å‡ºç¤ºè­·ç…§" },
                { r: "user", t: "ã¯ã„ã€ã“ã‚Œã§ã™ã€‚", c: "å¥½çš„ï¼Œåœ¨é€™è£¡" },
                { r: "user", t: "æœé£Ÿã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ", c: "æ—©é¤æ˜¯å¹¾é»ï¼Ÿ" }
            ]
        },
        {
            title: "ğŸœ é¤å»³å®¢è£½",
            msgs: [
                { r: "staff", t: "ã”æ³¨æ–‡ã¯ï¼Ÿ", c: "è«‹å•è¦é»ä»€éº¼ï¼Ÿ" },
                { r: "user", t: "ã“ã‚Œãã ã•ã„ã€‚ãƒã‚®æŠœãã§ã€‚", c: "æˆ‘è¦é€™å€‹ï¼Œä¸è¦è”¥" },
                { r: "user", t: "ã‚ã¨ã€å­ä¾›æ¤…å­ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", c: "é‚„æœ‰ï¼Œæœ‰å…’ç«¥æ¤…å—ï¼Ÿ" }
            ]
        },
        {
            title: "ğŸª è¶…å•†çµå¸³",
            msgs: [
                { r: "staff", t: "è¢‹ã„ã‚Šã¾ã™ã‹ï¼Ÿ", c: "è¦è¢‹å­å—ï¼Ÿ" },
                { r: "user", t: "å¤§ä¸ˆå¤«ã§ã™ã€‚", c: "ä¸ç”¨äº†" },
                { r: "staff", t: "æ¸©ã‚ã¾ã™ã‹ï¼Ÿ", c: "è¦åŠ ç†±å—ï¼Ÿ" }
            ]
        },
        {
            title: "ğŸš— åŠ æ²¹ç«™",
            msgs: [
                { r: "staff", t: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚", c: "æ­¡è¿å…‰è‡¨" },
                { r: "user", t: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã€æº€ã‚¿ãƒ³ã§ã€‚", c: "æ™®é€šæ²¹ï¼ŒåŠ æ»¿" },
                { r: "user", t: "ã‚´ãƒŸã€æ¨ã¦ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ", c: "å¯ä»¥å¹«æˆ‘ä¸Ÿåƒåœ¾å—ï¼Ÿ" }
            ]
        }
    ];

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let currentCat = 'all';
    let isMasked = false;
    let autoPlayInterval = null;
    let isPlaying = false;
    let currentReviewCard = null;

    // åˆå§‹åŒ–
    renderPlan();
    renderDialogues();
    filterDict('all', null);
    loadMaskState();
    updateReviewStats();

    function switchView(name, btn) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+name).classList.add('active');
        btn.classList.add('active');
        
        const tabs = document.getElementById('tabs-bar');
        const search = document.getElementById('search-bar-container');
        if (name === 'dict') {
            tabs.style.display = 'block';
            search.style.display = 'block';
        } else {
            tabs.style.display = 'none';
            search.style.display = 'none';
        }

        // åœæ­¢è‡ªå‹•æ’­æ”¾
        stopAllAutoPlay();

        // å¦‚æœåˆ‡åˆ°è¤‡ç¿’ï¼Œåˆå§‹åŒ–å¡ç‰‡
        if (name === 'review') {
            initReview();
        }

        window.scrollTo(0,0);
    }

    // --- è‡ªå‹•æ’­æ”¾é‚è¼¯ (Auto-Play) ---
    function toggleAutoPlay(btn, idsStr) {
        const ids = idsStr.split(',');
        
        if (isPlaying) {
            stopAllAutoPlay();
            return;
        }

        isPlaying = true;
        btn.classList.add('playing');
        btn.innerHTML = 'â¹ åœæ­¢æ’­æ”¾';
        
        let index = 0;
        
        function playNext() {
            if (!isPlaying || index >= ids.length) {
                index = 0; // å¾ªç’°æ’­æ”¾
                // stopAllAutoPlay(); return; // å¦‚æœä¸æƒ³å¾ªç’°ï¼Œå°±æ‰“é–‹é€™è¡Œ
            }
            
            const id = ids[index];
            const p = phrases.find(x => x.id === id);
            
            // è¦–è¦ºå›é¥‹
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
            const card = document.getElementById('card-'+id);
            if(card) card.classList.add('active-playing');

            // æ’­æ”¾æ—¥æ–‡
            speak(p.jp, () => {
                // æ—¥æ–‡å”¸å®Œï¼Œåœ 1 ç§’å”¸ä¸­æ–‡ (é¸ç”¨)
                setTimeout(() => {
                    speak(p.cn, () => {
                         // ä¸­æ–‡å”¸å®Œï¼Œåœ 1.5 ç§’æ›ä¸‹ä¸€å¥
                         setTimeout(() => {
                             index++;
                             playNext();
                         }, 1500);
                    }, 'zh-TW');
                }, 800);
            });
        }
        playNext();
    }

    function stopAllAutoPlay() {
        isPlaying = false;
        window.speechSynthesis.cancel();
        document.querySelectorAll('.autoplay-btn').forEach(b => {
            b.classList.remove('playing');
            b.innerHTML = 'â–¶ æ’­æ”¾å…¨é€±';
        });
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-playing'));
    }

    // --- è¤‡ç¿’é‚è¼¯ (Review) ---
    function initReview() {
        const saved = JSON.parse(localStorage.getItem('jp_prog')||'[]');
        document.getElementById('learned-count').innerText = saved.length;
        
        if (saved.length === 0) {
            document.getElementById('review-area').style.display = 'none';
            document.getElementById('empty-review').style.display = 'block';
        } else {
            document.getElementById('review-area').style.display = 'block';
            document.getElementById('empty-review').style.display = 'none';
            nextCard();
        }
    }

    function nextCard() {
        const saved = JSON.parse(localStorage.getItem('jp_prog')||'[]');
        if(saved.length === 0) return;
        
        // éš¨æ©ŸæŠ½ä¸€å€‹
        const randId = saved[Math.floor(Math.random() * saved.length)];
        currentReviewCard = phrases.find(p => p.id === randId);
        
        // é‡ç½®å¡ç‰‡é¢
        const cardEl = document.getElementById('flashcard');
        cardEl.classList.remove('flipped');
        
        // å¡«å…¥å…§å®¹
        setTimeout(() => {
            document.getElementById('fc-jp').innerText = currentReviewCard.jp;
            document.getElementById('fc-romaji').innerText = currentReviewCard.romaji;
            document.getElementById('fc-cn').innerText = currentReviewCard.cn;
        }, 200);
    }

    function flipCard() {
        document.getElementById('flashcard').classList.toggle('flipped');
        if (document.getElementById('flashcard').classList.contains('flipped')) {
            // ç¿»é¢è‡ªå‹•æ’­æ”¾
            setTimeout(() => speak(currentReviewCard.jp), 300);
        }
    }
    
    function speakCurrentCard() {
        if(currentReviewCard) speak(currentReviewCard.jp);
    }
    
    function updateReviewStats() {
        const saved = JSON.parse(localStorage.getItem('jp_prog')||'[]');
        const el = document.getElementById('learned-count');
        if(el) el.innerText = saved.length;
    }

    // --- å…¶ä»–æ¸²æŸ“é‚è¼¯ (åŒå‰ç‰ˆ) ---
    function renderPlan() {
        const box = document.getElementById('curriculum-container');
        const saved = JSON.parse(localStorage.getItem('jp_prog')||'[]');
        const maskClass = isMasked ? 'masked' : '';

        box.innerHTML = weeks.map((w, idx) => {
            const idsStr = w.ids.join(',');
            const lessons = w.ids.map(id => {
                const p = phrases.find(x=>x.id===id);
                if(!p) return '';
                const chk = saved.includes(id) ? 'checked' : '';
                return `
                <div class="card ${maskClass}" id="card-${id}">
                    <div class="card-top">
                        <div style="flex:1" onclick="speak('${p.jp}')">
                            <div class="jp-big">${p.jp} ğŸ”Š</div>
                            <span class="romaji">${p.romaji}</span>
                            <div class="cn">${p.cn}</div>
                        </div>
                        <div class="check-box ${chk}" onclick="toggleCheck('${id}', this)" 
                             style="width:24px; height:24px; border-radius:50%; border:2px solid #555; display:flex; align-items:center; justify-content:center;">
                             âœ“
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            return `
            <div class="week-header">
                <h3 class="week-title">${w.t}</h3>
                <button class="autoplay-btn" onclick="toggleAutoPlay(this, '${idsStr}')">â–¶ æ’­æ”¾å…¨é€±</button>
            </div>
            ${lessons}`;
        }).join('');
        
        const total = weeks.reduce((a,b)=>a+b.ids.length,0);
        const pct = Math.round(saved.length/total*100);
        document.getElementById('progress-text').innerText = pct+'%';
    }
    
    // (å…¶é¤˜ Search, Filter, Speak ç­‰åŸºç¤åŠŸèƒ½ä¿æŒä¸è®Šï¼Œèˆ‡ V9.0 ç›¸åŒ)
    function handleSearch() {
        const key = document.getElementById('search-input').value.toLowerCase();
        if (document.getElementById('view-dict').classList.contains('active')) {
             renderDictRaw(phrases.filter(p => 
                p.jp.includes(key) || p.romaji.toLowerCase().includes(key) || p.cn.includes(key)
            ));
        }
    }

    function filterDict(cat, btn) {
        if(btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        currentCat = cat;
        document.getElementById('search-input').value = ''; 
        if (cat === 'fav') {
            const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
            renderDictRaw(phrases.filter(p => favs.includes(p.id)));
        } else if (cat === 'all') {
            renderDictRaw(phrases);
        } else {
            renderDictRaw(phrases.filter(p => p.cat === cat));
        }
    }

    function renderDictRaw(data) {
        const box = document.getElementById('dict-container');
        const favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (data.length === 0) {
            box.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">æ²’æœ‰æ‰¾åˆ°çµæœ</div>';
            return;
        }
        box.innerHTML = data.map(p => {
            const isFav = favs.includes(p.id) ? 'fav' : '';
            return `
            <div class="card">
                <div class="card-top">
                    <div style="flex:1" onclick="speak('${p.jp}')">
                        <div class="jp-big">${p.jp} ğŸ”Š</div>
                        <span class="romaji">${p.romaji}</span>
                        <div class="cn">${p.cn}</div>
                    </div>
                    <div class="star-btn ${isFav}" onclick="toggleFav('${p.id}', this)">â˜…</div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleFav(id, el) {
        let favs = JSON.parse(localStorage.getItem('jp_favs')||'[]');
        if (favs.includes(id)) {
            favs = favs.filter(x => x !== id);
            el.classList.remove('fav');
        } else {
            favs.push(id);
            el.classList.add('fav');
        }
        localStorage.setItem('jp_favs', JSON.stringify(favs));
        if(currentCat === 'fav') filterDict('fav', null);
    }

    function toggleMask() {
        isMasked = !isMasked;
        document.getElementById('mask-switch').classList.toggle('on');
        localStorage.setItem('jp_mask', isMasked);
        renderPlan(); 
    }

    function loadMaskState() {
        isMasked = JSON.parse(localStorage.getItem('jp_mask')||'false');
        if(isMasked) document.getElementById('mask-switch').classList.add('on');
    }
    
    function toggleCheck(id, el) {
        let saved = JSON.parse(localStorage.getItem('jp_prog')||'[]');
        if (saved.includes(id)) {
            saved = saved.filter(x => x !== id);
            el.classList.remove('checked');
        } else {
            saved.push(id);
            el.classList.add('checked');
        }
        localStorage.setItem('jp_prog', JSON.stringify(saved));
        // æ›´æ–° %
        const total = weeks.reduce((a,b)=>a+b.ids.length,0);
        const pct = Math.round(saved.length/total*100);
        document.getElementById('progress-text').innerText = pct+'%';
        updateReviewStats();
    }
    
    function renderDialogues() {
        document.getElementById('dialogue-container').innerHTML = dialogues.map(d => {
            const bubbles = d.msgs.map(m => `
                <div class="bubble ${m.r}" onclick="speak('${m.t}')">
                    <div class="bubble-jp">${m.t} ğŸ”Š</div>
                    <div class="bubble-cn">${m.c}</div>
                </div>
            `).join('');
            return `<div class="dialogue-card"><div class="dialogue-header"><span>${d.title}</span></div><div class="dialogue-body">${bubbles}</div></div>`;
        }).join('');
    }

    function speak(txt, onEndCallback = null, lang = 'ja-JP') {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = lang;
        u.rate = 0.9;
        if (onEndCallback) {
            u.onend = onEndCallback;
        }
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
